<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Expediente - Parque Automotor</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-blue: #1e40af;
            --primary-blue-light: #3b82f6;
            --primary-blue-dark: #1e3a8a;
            --accent-blue: #60a5fa;
            --blue-50: #eff6ff;
            --blue-100: #dbeafe;
            --blue-200: #bfdbfe;
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e1;
            --gray-400: #94a3b8;
            --gray-500: #64748b;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1e293b;
            --gray-900: #0f172a;
            --success: #10b981;
            --success-light: #d1fae5;
            --warning: #f59e0b;
            --warning-light: #fef3c7;
            --danger: #ef4444;
            --danger-light: #fee2e2;
            --white: #ffffff;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            --border-radius-sm: 0.375rem;
            --border-radius: 0.5rem;
            --border-radius-md: 0.75rem;
            --border-radius-lg: 1rem;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-blue-dark) 50%, var(--primary-blue) 100%);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            min-height: 100vh;
            padding: 2rem;
            position: relative;
            overflow-x: auto;
            text-transform: uppercase;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml,<svg width="60" height="60" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd"><g fill="%23ffffff" fill-opacity="0.02"><circle cx="30" cy="30" r="1"/></g></g></svg>');
            z-index: -1;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 3rem;
            position: relative;
        }

        .header::after {
            content: '';
            position: absolute;
            bottom: -1rem;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--accent-blue), transparent);
            border-radius: 2px;
        }

        .header h1 {
            font-size: 3rem;
            font-weight: 800;
            margin-bottom: 0.75rem;
            letter-spacing: -0.02em;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            background: linear-gradient(135deg, #ffffff 0%, var(--blue-200) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            font-size: 1.25rem;
            opacity: 0.95;
            font-weight: 400;
            letter-spacing: 0.025em;
        }

        .main-card {
            background: var(--white);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-xl);
            margin-bottom: 2.5rem;
            overflow: hidden;
            border: 1px solid var(--blue-100);
            backdrop-filter: blur(10px);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .main-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 25px 50px -12px rgba(30, 64, 175, 0.25);
        }

        .card-header {
            padding: 2rem;
            background: linear-gradient(135deg, var(--blue-50) 0%, var(--blue-100) 100%);
            border-bottom: 1px solid var(--blue-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            overflow: hidden;
        }

        .card-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, var(--primary-blue), var(--accent-blue), var(--primary-blue));
        }

        .card-header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .card-header h2 {
            color: var(--gray-800);
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .icon-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-blue-light));
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-md);
        }

        .icon {
            width: 24px;
            height: 24px;
            fill: white;
        }

        .add-btn {
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-blue-light));
            color: white;
            border: none;
            width: 48px;
            height: 48px;
            border-radius: var(--border-radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
        }

        .add-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .add-btn:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: var(--shadow-lg);
        }

        .add-btn:hover::before {
            left: 100%;
        }

        .add-btn:active {
            transform: translateY(0) scale(0.98);
        }


        .card-content {
            padding: 2rem;
            color: var(--gray-600);
            font-size: 1rem;
            line-height: 1.6;
            background: linear-gradient(135deg, var(--white) 0%, var(--gray-50) 100%);
        }

        /* FILTRO GLOBAL */
        .filter-bar {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        .filter-btn {
            padding: 0.5rem 0.9rem;
            border: 1px solid var(--gray-300);
            border-radius: 0.5rem;
            background: var(--white);
            color: var(--gray-700);
            cursor: pointer;
            font-weight: 600;
        }
        .filter-btn.active {
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-blue-light));
            color: #fff;
            border-color: transparent;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .section-card {
            background: var(--white);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            border: 1px solid var(--gray-200);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .section-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-blue), var(--accent-blue));
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .section-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
            border-color: var(--blue-200);
        }

        .section-card:hover::before {
            transform: scaleX(1);
        }

        .section-header {
            padding: 1.5rem;
            background: linear-gradient(135deg, var(--gray-50) 0%, var(--blue-50) 100%);
            border-bottom: 1px solid var(--gray-200);
            position: relative;
        }

        .section-header h3 {
            color: var(--gray-800);
            font-size: 1.125rem;
            font-weight: 600;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .section-icon-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--primary-blue-light), var(--accent-blue));
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
        }

        .section-content {
            padding: 1.5rem;
            background: var(--white);
        }

        .expediente-item {
            background: linear-gradient(135deg, var(--blue-50) 0%, var(--white) 100%);
            border: 1px solid var(--blue-200);
            border-radius: var(--border-radius-md);
            padding: 1.5rem;
            margin-bottom: 1rem;
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }

        .expediente-item:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
            border-color: var(--primary-blue-light);
        }

        .expediente-item:last-child {
            margin-bottom: 0;
        }

        .expediente-header {
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 0.75rem;
            font-size: 0.95rem;
            line-height: 1.4;
            padding-right: 120px;
        }

        .expediente-details {
            font-size: 0.875rem;
            color: var(--gray-600);
            line-height: 1.5;
        }

        .expediente-details strong {
            color: var(--gray-700);
            font-weight: 600;
        }

        .status-badge {
            position: absolute;
            top: 1rem;
            right: 1rem;
            padding: 0.375rem 0.75rem;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            box-shadow: var(--shadow-sm);
        }

        .status-finalizado {
            background: var(--success-light);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .status-pendiente {
            background: var(--warning-light);
            color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.2);
        }

        .status-alert {
            background: var(--danger-light);
            color: var(--danger);
            border: 1px solid rgba(239, 68, 68, 0.25);
        }

        .empty-state {
            text-align: center;
            color: var(--gray-400);
            padding: 3rem 1.5rem;
        }

        .empty-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.6;
        }

        .empty-state p {
            font-size: 1rem;
            font-weight: 500;
        }

        .shopping-preview {
            background: linear-gradient(135deg, var(--blue-50) 0%, var(--white) 100%);
            border: 1px solid var(--blue-200);
            border-radius: var(--border-radius-md);
            padding: 2rem;
            text-align: center;
            color: var(--gray-600);
            transition: all 0.3s ease;
        }

        .shopping-preview:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .shopping-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            opacity: 0.7;
        }

        .executive-item {
            background: linear-gradient(135deg, #fef7ed 0%, var(--white) 100%);
            border: 1px solid #fed7aa;
            border-radius: var(--border-radius-md);
            padding: 1.5rem;
            margin-bottom: 1rem;
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }

        .executive-item:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
            border-color: var(--warning);
        }

        .executive-item:last-child {
            margin-bottom: 0;
        }

        .delete-btn {
            background: var(--white);
            border: 1px solid var(--danger-light);
            color: var(--danger);
            cursor: pointer;
            font-size: 16px;
            width: 32px;
            height: 32px;
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            box-shadow: var(--shadow-sm);
        }

        .delete-btn:hover {
            background: var(--danger-light);
            border-color: var(--danger);
            transform: scale(1.1);
        }

        .delete-btn:active {
            transform: scale(0.95);
        }

        /* Mejoras para dispositivos m√≥viles */
        @media (max-width: 768px) {
            .item-actions {
                position: static !important;
                margin-top: 0.5rem;
                display: flex;
                gap: 0.5rem;
                flex-wrap: wrap;
                justify-content: center;
            }

            .item-actions button {
                flex: 1;
                min-width: 0;
                font-size: 0.8rem;
                padding: 0.4rem 0.6rem;
                touch-action: manipulation;
            }

            .expediente-item,
            .executive-item {
                position: relative;
                padding-bottom: 3rem;
            }

            .expediente-header {
                padding-right: 0;
                margin-bottom: 0.5rem;
            }

            .expediente-details {
                margin-bottom: 0.5rem;
            }

            /* Mejorar la legibilidad en m√≥viles */
            .expediente-item:hover,
            .executive-item:hover {
                transform: none;
            }

            .expediente-item:active,
            .executive-item:active {
                transform: scale(0.98);
            }

            /* Asegurar que los botones sean f√°ciles de tocar */
            button {
                min-height: 44px;
                min-width: 44px;
            }

            .delete-btn,
            .edit-btn,
            .send-btn,
            .finalize-btn {
                min-height: 36px;
                font-size: 0.8rem;
            }
        }

        .edit-btn {
            padding: 0.45rem 0.8rem;
            border-radius: 0.5rem;
            border: 1px solid var(--warning);
            background: var(--white);
            color: var(--warning);
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s ease;
        }

        .edit-btn:hover {
            background: var(--warning);
            color: var(--white);
            transform: scale(1.05);
        }

        .finalize-btn {
            padding: 0.45rem 0.8rem;
            border-radius: 0.5rem;
            border: 1px solid var(--success);
            background: var(--white);
            color: var(--success);
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .finalize-btn:hover {
            background: var(--success);
            color: var(--white);
            transform: scale(1.05);
        }

        /* Toolbar de selecci√≥n y env√≠o */
        .item-actions {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        .inline-select {
            padding: 0.45rem 0.6rem;
            border: 1px solid var(--gray-300);
            border-radius: 0.5rem;
            font-size: 0.85rem;
            background: var(--white);
            color: var(--gray-700);
        }
        .send-btn, .send-back-btn {
            padding: 0.45rem 0.8rem;
            border-radius: 0.5rem;
            border: none;
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-blue-light));
            color: #fff;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .stats-bar {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--gray-200);
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: var(--gray-50);
            border-radius: var(--border-radius);
            font-size: 0.875rem;
            color: var(--gray-600);
        }

        .stat-number {
            font-weight: 600;
            color: var(--primary-blue);
        }

        /* Form Page Styles */
        .form-page {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-blue-dark) 50%, var(--primary-blue) 100%);
            z-index: 1000;
            overflow-y: auto;
            padding: 1rem;
        }

        .form-page.active {
            display: flex;
            flex-direction: column;
        }

        .form-container {
            max-width: 600px;
            margin: 0 auto;
            background: var(--white);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-xl);
            overflow: hidden;
            border: 1px solid var(--blue-100);
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Responsive para m√≥viles */
        @media (max-width: 768px) {
            .form-page {
                padding: 0.5rem;
            }
            
            .form-container {
                max-width: 100%;
                max-height: 95vh;
                border-radius: 0.5rem;
            }
        }
        
        @media (max-width: 480px) {
            .form-page {
                padding: 0.25rem;
            }
        }

        /* Config Page Styles */
        .config-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-blue-dark) 50%, var(--primary-blue) 100%);
            z-index: 1000;
            overflow-y: auto;
            padding: 1rem;
        }

        .config-container {
            max-width: 1000px;
            margin: 0 auto;
            background: var(--white);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-xl);
            overflow: hidden;
            border: 1px solid var(--blue-100);
            max-height: 95vh;
            display: flex;
            flex-direction: column;
        }

        .config-header {
            padding: 1rem;
            background: linear-gradient(135deg, var(--blue-50) 0%, var(--blue-100) 100%);
            border-bottom: 1px solid var(--blue-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .config-header h2 {
            color: var(--gray-800);
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
        }

        .config-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .config-sidebar {
            width: 250px;
            background: var(--gray-50);
            border-right: 1px solid var(--gray-200);
            padding: 1rem;
        }

        .config-tabs {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .tab-btn {
            padding: 0.75rem 1rem;
            border: none;
            background: transparent;
            color: var(--gray-700);
            font-weight: 600;
            text-align: left;
            cursor: pointer;
            border-radius: var(--border-radius);
            transition: all 0.2s ease;
        }

        .tab-btn:hover {
            background: var(--gray-100);
        }

        .tab-btn.active {
            background: var(--primary-blue);
            color: white;
        }

        .config-main {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .user-info {
            margin-bottom: 2rem;
        }

        .user-info h3 {
            color: var(--gray-800);
            margin-bottom: 1rem;
        }

        .info-item {
            margin-bottom: 0.75rem;
            padding: 0.5rem;
            background: var(--gray-50);
            border-radius: var(--border-radius);
        }

        .password-section h3 {
            color: var(--gray-800);
            margin-bottom: 1rem;
        }

        /* Roles Section Styles */
        .roles-section {
            margin-bottom: 2rem;
            padding: 1rem;
            background: var(--gray-50);
            border-radius: var(--border-radius);
            border: 1px solid var(--gray-200);
        }

        .roles-section h4 {
            color: var(--gray-800);
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .users-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .user-item {
            padding: 0.75rem;
            background: white;
            border-radius: var(--border-radius);
            border: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .user-info {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .user-name {
            font-weight: 600;
            color: var(--gray-800);
        }

        .user-details {
            font-size: 0.85rem;
            color: var(--gray-600);
        }

        .roles-info {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .role-item {
            padding: 1rem;
            background: white;
            border-radius: var(--border-radius);
            border: 1px solid var(--gray-200);
        }

        .role-item strong {
            color: var(--gray-800);
            font-size: 1rem;
        }

        .role-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        .role-badge.admin {
            background: var(--danger);
            color: white;
        }

        .role-badge.mesa {
            background: var(--warning);
            color: white;
        }

        .role-badge.personal {
            background: var(--primary-blue);
            color: white;
        }

        .role-item p {
            margin-top: 0.5rem;
            color: var(--gray-600);
            font-size: 0.9rem;
        }

        .user-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }

        .stat-card {
            padding: 1rem;
            background: white;
            border-radius: var(--border-radius);
            border: 1px solid var(--gray-200);
            text-align: center;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-blue);
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--gray-600);
            margin-top: 0.25rem;
        }

        /* Role Management Styles */
        .role-management {
            background: white;
            border-radius: var(--border-radius);
            border: 1px solid var(--gray-200);
            padding: 1rem;
        }

        .role-form h5 {
            color: var(--gray-800);
            margin-bottom: 1rem;
            font-size: 1rem;
        }

        .form-row {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .form-row .form-select {
            flex: 1;
            min-width: 150px;
        }

        .form-row .btn {
            white-space: nowrap;
            padding: 0.5rem 1rem;
        }

        /* Responsive para m√≥viles */
        @media (max-width: 768px) {
            .roles-section {
                padding: 0.75rem;
                margin-bottom: 1.5rem;
            }
            
            .user-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            
            .user-stats {
                grid-template-columns: 1fr;
            }
            
            .role-item {
                padding: 0.75rem;
            }
            
            .form-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .form-row .form-select,
            .form-row .btn {
                width: 100%;
            }
        }

        /* Responsive para m√≥viles */
        @media (max-width: 768px) {
            .config-page {
                padding: 0.5rem;
            }
            
            .config-container {
                max-width: 100%;
                max-height: 98vh;
                border-radius: 0.5rem;
            }
            
            .config-content {
                flex-direction: column;
            }
            
            .config-sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid var(--gray-200);
                padding: 0.75rem;
            }
            
            .config-tabs {
                flex-direction: row;
                overflow-x: auto;
                gap: 0.25rem;
            }
            
            .tab-btn {
                white-space: nowrap;
                padding: 0.5rem 0.75rem;
                font-size: 0.85rem;
            }
            
            .config-main {
                padding: 1rem;
            }
        }

        @media (max-width: 480px) {
            .config-page {
                padding: 0.25rem;
            }
            
            .config-header {
                padding: 0.75rem;
            }
            
            .config-header h2 {
                font-size: 1.25rem;
            }
            
            .config-main {
                padding: 0.75rem;
            }
        }

        .form-header {
            padding: 1rem;
            background: linear-gradient(135deg, var(--blue-50) 0%, var(--blue-100) 100%);
            border-bottom: 1px solid var(--blue-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        /* Responsive header para m√≥viles */
        @media (max-width: 768px) {
            .form-header {
                padding: 0.75rem;
            }
        }

        .form-header h2 {
            color: var(--gray-800);
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .close-btn {
            background: var(--white);
            border: 1px solid var(--gray-300);
            color: var(--gray-600);
            cursor: pointer;
            font-size: 16px;
            width: 36px;
            height: 36px;
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .close-btn:hover {
            background: var(--gray-100);
            color: var(--gray-800);
        }

        .form-content {
            padding: 1rem;
            flex: 1;
            overflow-y: auto;
        }
        
        /* Responsive padding para m√≥viles */
        @media (max-width: 768px) {
            .form-content {
                padding: 0.75rem;
            }
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }
        
        /* Responsive grid para m√≥viles */
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-label {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            margin-bottom: 0.3rem;
            color: var(--gray-700);
            font-weight: 500;
            font-size: 0.8rem;
        }
        
        /* Responsive labels para m√≥viles */
        @media (max-width: 768px) {
            .form-label {
                font-size: 0.75rem;
                gap: 0.3rem;
                margin-bottom: 0.25rem;
            }
        }

        .form-label .required {
            color: var(--danger);
        }

        .form-input, .form-select, .form-textarea {
            padding: 0.6rem;
            border: 1px solid var(--gray-300);
            border-radius: var(--border-radius);
            font-size: 0.85rem;
            transition: all 0.2s ease;
            outline: none;
        }
        
        /* Responsive inputs para m√≥viles */
        @media (max-width: 768px) {
            .form-input, .form-select, .form-textarea {
                padding: 0.5rem;
                font-size: 0.8rem;
            }
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        /* Responsive textarea para m√≥viles */
        @media (max-width: 768px) {
            .form-textarea {
                min-height: 60px;
            }
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            padding: 1rem;
            border-top: 1px solid var(--gray-200);
            background: var(--white);
            flex-shrink: 0;
            position: sticky;
            bottom: 0;
        }
        
        /* Responsive botones para m√≥viles */
        @media (max-width: 768px) {
            .form-actions {
                padding: 0.75rem;
                gap: 0.5rem;
                flex-direction: column;
            }
        }

        .btn {
            padding: 0.6rem 1rem;
            border-radius: var(--border-radius);
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }
        
        /* Responsive botones para m√≥viles */
        @media (max-width: 768px) {
            .btn {
                padding: 0.5rem 0.75rem;
                font-size: 0.8rem;
                gap: 0.3rem;
            }
        }

        .btn-secondary {
            background: var(--white);
            color: var(--gray-700);
            border: 1px solid var(--gray-300);
        }

        .btn-secondary:hover {
            background: var(--gray-50);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-blue-light));
            color: white;
            box-shadow: var(--shadow-sm);
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        @media (max-width: 1024px) {
            .grid-container {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 0.5rem;
                font-size: 14px;
            }
            
            .header {
                margin-bottom: 1rem;
                padding: 0.75rem;
                text-align: center;
            }
            
            .header h1 {
                font-size: 1.5rem;
                line-height: 1.2;
            }

            .header p {
                font-size: 0.9rem;
                margin-top: 0.25rem;
            }
            
            .main-card {
                margin-bottom: 0.75rem;
            }
            
            .card-header {
                padding: 0.75rem;
                flex-direction: column;
                align-items: stretch;
                gap: 0.5rem;
            }

            .card-header-left {
                justify-content: center;
                flex-wrap: wrap;
                text-align: center;
            }

            .card-content {
                padding: 0.75rem;
            }

            .section-content {
                padding: 0.5rem;
            }

            .expediente-item,
            .executive-item {
                padding: 0.75rem;
                margin-bottom: 0.5rem;
                border-radius: 8px;
            }

            .expediente-header {
                padding-right: 0;
                font-size: 0.8rem;
                margin-bottom: 0.5rem;
                font-weight: 600;
            }

            .expediente-details {
                font-size: 0.75rem;
                margin-bottom: 0.75rem;
                line-height: 1.4;
            }

            .item-actions {
                position: static !important;
                margin-top: 0.5rem;
                display: flex;
                gap: 0.25rem;
                flex-wrap: wrap;
                justify-content: center;
            }

            .item-actions button {
                flex: 1;
                min-width: 60px;
                font-size: 0.7rem;
                padding: 0.4rem 0.5rem;
                border-radius: 4px;
                min-height: 36px;
                touch-action: manipulation;
            }

            .stats-bar {
                flex-wrap: wrap;
                gap: 0.25rem;
                justify-content: center;
            }

            .stats-item {
                font-size: 0.75rem;
                padding: 0.4rem;
                min-width: 80px;
                text-align: center;
            }

            .form-grid {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }

            .form-content {
                padding: 0.75rem;
            }

            .form-group {
                margin-bottom: 0.5rem;
            }

            .form-group label {
                font-size: 0.8rem;
                margin-bottom: 0.25rem;
            }

            .form-group input,
            .form-group select,
            .form-group textarea {
                font-size: 0.8rem;
                padding: 0.5rem;
                width: 100%;
            }

            .btn {
                font-size: 0.8rem;
                padding: 0.5rem 0.75rem;
                min-height: 40px;
                touch-action: manipulation;
            }

            .grid-container {
                gap: 0.75rem;
                grid-template-columns: 1fr;
            }

            .section-title {
                font-size: 1rem;
                margin-bottom: 0.5rem;
                text-align: center;
            }

            /* Mejoras espec√≠ficas para m√≥viles */
            .card {
                border-radius: 8px;
                margin-bottom: 0.5rem;
            }

            .status-badge {
                font-size: 0.65rem;
                padding: 0.2rem 0.4rem;
            }

            /* Botones m√°s grandes para touch */
            button, .btn, input[type="button"], input[type="submit"] {
                min-height: 44px;
                touch-action: manipulation;
            }

            /* Selects m√°s grandes */
            select {
                min-height: 44px;
                font-size: 16px; /* Evita zoom en iOS */
            }

            /* Mejorar legibilidad en pantallas peque√±as */
            .expediente-details strong {
                display: inline-block;
                min-width: 80px;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 0.5rem;
                font-size: 13px;
            }

            .header {
                margin-bottom: 1rem;
                padding: 0.75rem;
            }

            .header h1 {
                font-size: 1.5rem;
                line-height: 1.1;
            }

            .header p {
                font-size: 0.9rem;
            }

            .main-card {
                margin-bottom: 1rem;
            }

            .card-header {
                padding: 0.75rem;
            }

            .card-content {
                padding: 0.75rem;
            }

            .section-content {
                padding: 0.5rem;
            }

            .expediente-item,
            .executive-item {
                padding: 0.5rem;
                margin-bottom: 0.5rem;
            }

            .expediente-header {
                font-size: 0.8rem;
                margin-bottom: 0.25rem;
            }

            .expediente-details {
                font-size: 0.75rem;
                margin-bottom: 0.25rem;
            }

            .item-actions {
                margin-top: 0.25rem;
                gap: 0.25rem;
            }

            .item-actions button {
                font-size: 0.75rem;
                padding: 0.3rem 0.4rem;
            }

            .stats-bar {
                gap: 0.25rem;
            }

            .stats-item {
                font-size: 0.75rem;
                padding: 0.4rem;
            }

            .form-content {
                padding: 0.75rem;
            }

            .form-group {
                margin-bottom: 0.5rem;
            }

            .form-group label {
                font-size: 0.8rem;
            }

            .form-group input,
            .form-group select,
            .form-group textarea {
                font-size: 0.8rem;
                padding: 0.4rem;
            }

            .btn {
                font-size: 0.8rem;
                padding: 0.4rem 0.8rem;
            }

            .grid-container {
                gap: 0.75rem;
            }

            .section-title {
                font-size: 1rem;
                margin-bottom: 0.5rem;
            }

            .status-badge {
                font-size: 0.7rem;
                padding: 0.2rem 0.4rem;
            }
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--gray-100);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-blue-light);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-blue);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .loading {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='0.9em' font-size='90'%3E%F0%9F%9A%97%3C/text%3E%3C/svg%3E">
</head>
<body>
    <!-- LOGIN PAGE -->
    <div class="form-page active" id="loginPage">
        <div class="form-container" style="max-width: 500px;">
            <div class="form-header">
                <h2>
                    <div class="icon-wrapper" style="width: 40px; height: 40px;">
                        <svg class="icon" viewBox="0 0 24 24" style="width: 20px; height: 20px;">
                            <path d="M12 2C13.1 2 14 2.9 14 4C14 5.1 13.1 6 12 6C10.9 6 10 5.1 10 4C10 2.9 10.9 2 12 2ZM21 9V7L15 1H5C3.89 1 3 1.89 3 3V21C3 22.11 3.89 23 5 23H11V21H5V3H13V9H21Z"/>
                        </svg>
                    </div>
                    INICIAR SESI√ìN
                </h2>
            </div>
            
            <div class="form-content">
                <form id="loginForm">
                    <div class="form-group">
                        <label class="form-label">üÜî DNI (USUARIO) <span class="required">*</span></label>
                        <input type="text" name="username" class="form-input" placeholder="INGRESE SU DNI" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">üîí CONTRASE√ëA <span class="required">*</span></label>
                        <input type="password" name="password" class="form-input" placeholder="INGRESE SU CONTRASE√ëA" required>
                    </div>
                    <div class="form-actions" style="flex-direction: column; gap: 1rem;">
                        <button type="submit" class="btn btn-primary" style="width: 100%;">üöÄ INGRESAR AL SISTEMA</button>
                        <div style="text-align: center; color: var(--gray-600);">
                            ¬øNO TIENES CUENTA? 
                            <a href="#" onclick="showRegister()" style="color: var(--primary-blue); font-weight: 600; text-decoration: none;">REG√çSTRATE AQU√ç</a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- REGISTER PAGE -->
    <div class="form-page" id="registerPage">
        <div class="form-container" style="max-width: 600px;">
            <div class="form-header">
                <h2>
                    <div class="icon-wrapper" style="width: 40px; height: 40px;">
                        <svg class="icon" viewBox="0 0 24 24" style="width: 20px; height: 20px;">
                            <path d="M15 12C17.21 12 19 10.21 19 8S17.21 4 15 4 11 5.79 11 8 12.79 12 15 12M6 10V7H4V10H1V12H4V15H6V12H9V10M15 14C12.33 14 7 15.34 7 18V20H23V18C23 15.34 17.67 14 15 14Z"/>
                        </svg>
                    </div>
                    REGISTRO DE USUARIO
                </h2>
                <button class="close-btn" onclick="showLogin()" title="VOLVER AL LOGIN">‚Üê</button>
            </div>
            
            <div class="form-content">
                <form id="registerForm">
                    <div class="form-group">
                        <label class="form-label">üÜî DNI <span class="required">*</span></label>
                        <input type="text" name="dni" class="form-input" placeholder="EJ: 12345678" required pattern="^\d{7,9}$" title="INGRESE SOLO N√öMEROS (7 A 9 D√çGITOS)">
                    </div>

                    <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                        <div class="form-group">
                            <label class="form-label">üë§ NOMBRE COMPLETO <span class="required">*</span></label>
                            <input type="text" name="nombre" class="form-input" placeholder="EJ: JUAN CARLOS" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">üìù APELLIDO <span class="required">*</span></label>
                            <input type="text" name="apellido" class="form-input" placeholder="EJ: GONZ√ÅLEZ" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">üë§ USUARIO (AUTOCOMPLETADO CON DNI)</label>
                        <input type="text" name="username" class="form-input" placeholder="SE AUTOCOMPLETA CON DNI" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">üîí CONTRASE√ëA <span class="required">*</span></label>
                        <input type="password" name="password" class="form-input" placeholder="M√çNIMO 6 CARACTERES" required minlength="6">
                    </div>
                    <div class="form-group">
                        <label class="form-label">üîí REPETIR CONTRASE√ëA <span class="required">*</span></label>
                        <input type="password" name="confirmPassword" class="form-input" placeholder="CONFIRME SU CONTRASE√ëA" required minlength="6">
                    </div>
                    <div class="form-actions" style="flex-direction: column; gap: 1rem;">
                        <button type="submit" class="btn btn-primary" style="width: 100%;">‚úÖ REGISTRAR USUARIO</button>
                        <div style="text-align: center; color: var(--gray-600);">
                            ¬øYA TIENES CUENTA? 
                            <a href="#" onclick="showLogin()" style="color: var(--primary-blue); font-weight: 600; text-decoration: none;">INICIA SESI√ìN AQU√ç</a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="container" id="mainPage" style="display: none;">
        <div class="header">
            <h1>CONTROL DE EXPEDIENTE</h1>
            <h1 style="margin-top: -0.5rem;">PARQUE AUTOMOTOR</h1>
            <p>Sistema integral de gesti√≥n de expedientes automotores</p>
            <div id="dbStatusIndicator" style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 0.5rem 1rem; border-radius: 8px; margin-top: 1rem; text-align: center; font-weight: 600; font-size: 0.9rem;">
                üóÑÔ∏è BASE DE DATOS √öNICA CENTRALIZADA - Una sola fuente de expedientes para todos los usuarios
            </div>
            <div style="position: absolute; top: 1rem; right: 1rem; display:flex; gap:.5rem;">
                <button class="btn btn-secondary" onclick="showConfig()" style="padding: 0.5rem 1rem;">‚öôÔ∏è CONFIGURACI√ìN</button>
                <button class="btn btn-secondary" onclick="logout()" style="padding: 0.5rem 1rem;">üö™ CERRAR SESI√ìN</button>
            </div>
        </div>

        <div class="main-card">
            <div class="card-header">
                <div class="card-header-left">
                    <div class="icon-wrapper">
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
                        </svg>
                    </div>
                    <h2>Mesa de Entrada</h2>
                </div>
                <button class="add-btn" onclick="openNewExpedienteForm()" title="Agregar nuevo expediente">+</button>
            </div>
            <div class="card-content">
                Administre y controle todos los expedientes del parque automotor desde un panel centralizado con herramientas avanzadas de seguimiento y gesti√≥n profesional.
                
                <div class="stats-bar">
                    <div class="stat-item">
                        <span>üìä</span>
                        <span>Total: <span class="stat-number" id="totalExpedientes">1</span></span>
                    </div>
                    <div class="stat-item">
                        <span>‚úÖ</span>
                        <span>Finalizados: <span class="stat-number" id="finalizados">1</span></span>
                    </div>
                    <div class="stat-item">
                        <span>‚è≥</span>
                        <span>Pendientes: <span class="stat-number" id="pendientes">0</span></span>
                    </div>
                </div>

                <div class="filter-bar">
                    <span style="color:var(--gray-700); font-weight:600;">FILTRAR:</span>
                    <button class="filter-btn" data-filter="TODOS">TODOS</button>
                    <button class="filter-btn" data-filter="PENDIENTE">PENDIENTE</button>
                    <button class="filter-btn" data-filter="CONFIRMADOS">CONFIRMADOS</button>
                </div>

                <!-- Buscador Global por Fecha y Texto -->
                <div class="global-search-bar" style="margin: 2rem 0; padding: 1.5rem; background: linear-gradient(135deg, var(--gray-50) 0%, var(--blue-50) 100%); border-radius: 1rem; border: 1px solid var(--gray-200); box-shadow: var(--shadow-sm);">
                    <div style="text-align: center; margin-bottom: 1.5rem;">
                        <h3 style="color: var(--gray-800); font-size: 1.2rem; font-weight: 700; margin: 0;">üîç BUSCADOR GLOBAL DE EXPEDIENTES</h3>
                        <p style="color: var(--gray-600); font-size: 0.9rem; margin: 0.5rem 0 0 0;">Busca por palabra o fecha en todas las secciones</p>
                    </div>
                    
                    <!-- B√∫squeda por Texto -->
                    <div style="margin-bottom: 1.5rem; padding: 1rem; background: white; border-radius: 0.75rem; border: 1px solid var(--gray-200);">
                        <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; justify-content: center;">
                            <div style="display: flex; align-items: center; gap: 0.75rem; flex: 1; min-width: 300px;">
                                <label style="font-size: 1rem; font-weight: 700; color: var(--gray-800);">üîç BUSCAR POR PALABRA:</label>
                                <input type="text" id="textoBusqueda" placeholder="C√≥digo, detalle, corresponde, derivado, observaci√≥n..." class="input" style="padding: 0.75rem; font-size: 1rem; border: 2px solid var(--gray-300); border-radius: 0.5rem; flex: 1; min-width: 250px;" onkeypress="if(event.key==='Enter') buscarPorTextoGlobal()" />
                            </div>
                            <button onclick="buscarPorTextoGlobal()" class="btn" style="background: linear-gradient(135deg, var(--success), var(--success-light)); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-size: 1rem; font-weight: 700; cursor: pointer; box-shadow: var(--shadow-md); transition: all 0.3s ease;">
                                üîç BUSCAR TEXTO
                            </button>
                        </div>
                    </div>
                    
                    <!-- B√∫squeda por Fecha -->
                    <div style="margin-bottom: 1.5rem; padding: 1rem; background: white; border-radius: 0.75rem; border: 1px solid var(--gray-200);">
                        <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; justify-content: center;">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <label style="font-size: 1rem; font-weight: 700; color: var(--gray-800);">üìÖ DESDE:</label>
                                <input type="date" id="fechaDesde" class="input" style="padding: 0.75rem; font-size: 1rem; border: 2px solid var(--gray-300); border-radius: 0.5rem; min-width: 150px;" />
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <label style="font-size: 1rem; font-weight: 700; color: var(--gray-800);">üìÖ HASTA:</label>
                                <input type="date" id="fechaHasta" class="input" style="padding: 0.75rem; font-size: 1rem; border: 2px solid var(--gray-300); border-radius: 0.5rem; min-width: 150px;" />
                            </div>
                            <button onclick="buscarPorFechaGlobal()" class="btn" style="background: linear-gradient(135deg, var(--primary-blue), var(--primary-blue-light)); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-size: 1rem; font-weight: 700; cursor: pointer; box-shadow: var(--shadow-md); transition: all 0.3s ease;">
                                üìÖ BUSCAR POR FECHA
                            </button>
                        </div>
                    </div>
                    
                    <!-- Botones de Acci√≥n -->
                    <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; justify-content: center;">
                        <button onclick="buscarCombinado()" class="btn" style="background: linear-gradient(135deg, var(--warning), var(--warning-light)); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-size: 1rem; font-weight: 700; cursor: pointer; box-shadow: var(--shadow-md); transition: all 0.3s ease;">
                            üîç BUSCAR COMBINADO
                        </button>
                        <button onclick="limpiarBusquedaGlobal()" class="btn" style="background: linear-gradient(135deg, var(--gray-500), var(--gray-600)); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-size: 1rem; font-weight: 700; cursor: pointer; box-shadow: var(--shadow-md); transition: all 0.3s ease;">
                            üóëÔ∏è LIMPIAR B√öSQUEDA
                        </button>
                    </div>
                </div>


            </div>
        </div>

        <div class="grid-container">
            <div class="section-card">
                <div class="section-header">
                    <h3>
                        <div class="section-icon-wrapper">
                            <svg class="icon" viewBox="0 0 24 24" style="width: 20px; height: 20px;">
                                <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 2 2h8c1.1 0 2-.9 2-2V8l-6-6zm4 18H6V4h7v5h5v11z"/>
                            </svg>
                        </div>
                        Expedientes Creados
                    </h3>

                </div>
                
                
                <div class="section-content" id="expedientesCreados">
                    <div class="empty-state" id="emptyExpedientes" style="display: block;">
                        <div class="empty-icon">üìÑ</div>
                        <p>No hay expedientes creados</p>
                    </div>
                </div>
            </div>

            <div class="section-card">
                <div class="section-header">
                    <h3>
                        <div class="section-icon-wrapper">
                            <svg class="icon" viewBox="0 0 24 24" style="width: 20px; height: 20px;">
                                <path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.22.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zM5 11l1.5-4.5h11L19 11H5z"/>
                            </svg>
                        </div>
                        Parque Automotor Ejecutivo
                    </h3>
                </div>
                <div class="section-content" id="executiveSection">
                    <div class="empty-state" id="emptyExecutive" style="display: block;">
                        <div class="empty-icon">üöó</div>
                        <p>No hay expedientes ejecutivos</p>
                    </div>
                </div>
            </div>

            <div class="section-card">
                <div class="section-header">
                    <h3>
                        <div class="section-icon-wrapper">
                            <svg class="icon" viewBox="0 0 24 24" style="width: 20px; height: 20px;">
                                <path d="M7 18c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12L8.1 13h7.45c.75 0 1.41-.41 1.75-1.03L21.7 4H5.21l-.94-2H1zm16 16c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
                            </svg>
                        </div>
                        Centro de Compras
                    </h3>
                </div>
                <div class="section-content">
                    <!-- Contenedor para expedientes de compras -->
                </div>
            </div>

            <div class="section-card">
                <div class="section-header">
                    <h3>
                        <div class="section-icon-wrapper">
                            <svg class="icon" viewBox="0 0 24 24" style="width: 20px; height: 20px;">
                                <path d="M19 8h-1V3H6v5H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zM8 5h8v3H8V5zm8 12.5h2v-2h-2v2zm0-4h2v-2h-2v2zm-3 0h2v-2h-2v2zm0-4h2v-2h-2v2zm-3 4h2v-2h-2v2zm0-4h2v-2h-2v2zm-3 4h2v-2H7v-2zm0-4h2v-2H7v-2z"/>
                            </svg>
                        </div>
                        Hospitales
                    </h3>
                </div>
                <div class="section-content" id="hospitalesSection">
                    <div class="empty-state" id="emptyHospitales" style="display: block;">
                        <div class="empty-icon">üè•</div>
                        <p>No hay expedientes de hospitales</p>
                    </div>
                </div>
            </div>

            <div class="section-card">
                <div class="section-header">
                    <h3>
                        <div class="section-icon-wrapper">
                            <svg class="icon" viewBox="0 0 24 24" style="width: 20px; height: 20px;">
                                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                            </svg>
                        </div>
                        Otros
                    </h3>
                </div>
                <div class="section-content" id="otrosSection">
                    <div class="empty-state" id="emptyOtros" style="display: block;">
                        <div class="empty-icon">üìã</div>
                        <p>No hay expedientes de otros</p>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- ROLE PENDING PAGE -->
    <div class="form-page" id="rolePendingPage">
        <div class="form-container" style="max-width: 560px;">
            <div class="form-header">
                <h2>
                    <div class="icon-wrapper" style="width: 40px; height: 40px;">
                        <svg class="icon" viewBox="0 0 24 24" style="width: 20px; height: 20px;">
                            <path d="M12,2A10,10 0 1,0 22,12A10,10 0 0,0 12,2M11,6H13V13H11V6M11,16H13V18H11V16Z"/>
                        </svg>
                    </div>
                    ROL PENDIENTE
                </h2>
            </div>
            <div class="form-content" style="text-align:center;">
                <p style="color: var(--gray-700); margin-bottom: 1rem;">SU USUARIO A√öN NO TIENE ROL ASIGNADO.</p>
                                        <p style="color: var(--gray-600);">CONTACTE AL ADMIN PARA CONTINUAR.</p>
            </div>
        </div>
    </div>

    <!-- Form Page -->
    <div class="form-page" id="formPage">
        <div class="form-container">
            <div class="form-header">
                <h2>
                    <div class="icon-wrapper" style="width: 40px; height: 40px;">
                        <svg class="icon" viewBox="0 0 24 24" style="width: 20px; height: 20px;">
                            <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 2 2h8c1.1 0 2-.9 2-2V8l-6-6zm4 18H6V4h7v5h5v11z"/>
                        </svg>
                    </div>
                    Nuevo Expediente - Parque Automotor
                </h2>
                <button class="close-btn" onclick="closeForm()" title="Cerrar">‚úï</button>
            </div>
            
            <div class="form-content">
                <form id="expedienteForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">
                                # C√ìDIGO DE EXPEDIENTE <span class="required">*</span>
                            </label>
                            <input type="text" name="codigo" class="form-input" placeholder="Ej: EXP-001" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                üìã N√öMERO DE EXPEDIENTE <span style="color: var(--gray-600); font-size: 0.8rem;">(Solo n√∫meros, sin l√≠mite de d√≠gitos)</span>
                            </label>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <input type="text" name="numero" id="numeroInput" class="form-input" placeholder="Ej: 001, 12345, 999999" pattern="[0-9]*" inputmode="numeric" style="flex: 1;">
                                <button type="button" onclick="sugerirYEstablecerNumero()" class="btn" style="background: var(--primary-blue); color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.375rem; font-size: 0.85rem; font-weight: 600; cursor: pointer; white-space: nowrap;">
                                    üí° SUGERIR
                                </button>
                            </div>
                            <small style="color: var(--gray-600); font-size: 0.75rem; margin-top: 0.25rem; display: block;">
                                ‚ö†Ô∏è Este n√∫mero debe ser √∫nico y contener solo d√≠gitos
                            </small>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                üìÖ A√ëO
                            </label>
                            <input type="number" name="anio" class="form-input" value="2025" min="2020" max="2030">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                üè¢ CORRESPONDE
                            </label>
                            <input type="text" name="corresponde" class="form-input" placeholder="Ej: Flota Ejecutiva">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                üìã TIPO DE EXPEDIENTE
                            </label>
                            <select name="tipo" class="form-select" required>
                                <option value="">Seleccionar tipo</option>
                                <option value="Combustible">Combustible</option>
                                <option value="Seguros">Seguros</option>
                                <option value="Personal">Personal</option>
                                <option value="Reparacion">Reparaci√≥n</option>
                                <option value="Choferes">Choferes</option>
                                <option value="Patrimonio">Patrimonio</option>
                                <option value="Comisiones">Comisiones</option>
                                <option value="Otros">Otros</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                üë§ DERIVADO A PERSONA
                            </label>
                            <input type="text" name="derivado" class="form-input" placeholder="Ej: Juan P√©rez">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                üìÖ FECHA DE INGRESO
                            </label>
                            <input type="date" name="fechaIngreso" class="form-input" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                üìÖ FECHA DE DERIVACI√ìN
                            </label>
                            <input type="date" name="fechaDerivacion" class="form-input">
                        </div>
                        
                        <div class="form-group full-width">
                            <label class="form-label">
                                üìù DETALLE
                            </label>
                            <textarea name="detalle" class="form-textarea" placeholder="Descripci√≥n detallada del expediente"></textarea>
                        </div>
                        
                        <div class="form-group full-width">
                            <label class="form-label">
                                üí≠ OBSERVACI√ìN
                            </label>
                            <textarea name="observacion" class="form-textarea" placeholder="Observaciones adicionales del expediente"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                ‚è≥ D√çAS DE TR√ÅMITE
                            </label>
                            <input type="number" name="diasTramite" class="form-input" value="0" min="0" readonly style="background-color: #f1f5f9; color: #64748b;" title="Se calcula autom√°ticamente desde la fecha de ingreso">
                            <small style="color: #64748b; font-size: 0.75rem; margin-top: 0.25rem; display: block;">Se calcula autom√°ticamente por d√≠a transcurrido</small>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeForm()">
                            ‚úï Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary">
                            ‚úì Confirmar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- P√°gina de Configuraci√≥n -->
    <div id="configPage" class="config-page" style="display: none;">
        <div class="config-container">
            <div class="config-header">
                <h2>CONFIGURACI√ìN</h2>
                <button class="close-btn" onclick="hideConfig()">‚Üê VOLVER</button>
            </div>
            
            <div class="config-content">
                <div class="config-sidebar">
                    <div class="config-tabs" id="configTabs">
                        <button class="tab-btn active" data-tab="usuario">üë§ USUARIO</button>
                        <button class="tab-btn" data-tab="perfil">üìã PERFIL</button>
                        <button class="tab-btn" data-tab="pendiente">‚è≥ PENDIENTE</button>
                        <button class="tab-btn" data-tab="roles">üîê ROLES</button>
                    </div>
                </div>
                
                <div class="config-main">
                    <div id="usuarioTab" class="tab-content active">
                        <div class="user-info">
                            <h3>Informaci√≥n del Usuario</h3>
                            <div class="info-item">
                                <strong>DNI:</strong> <span id="userDNI">-</span>
                            </div>
                            <div class="info-item">
                                <strong>NOMBRE:</strong> <span id="userNombre">-</span>
                            </div>
                            <div class="info-item">
                                <strong>APELLIDO:</strong> <span id="userApellido">-</span>
                            </div>
                            <div class="info-item">
                                <strong>ROL:</strong> <span id="userRol">-</span>
                            </div>
                        </div>
                        
                        <div class="password-section">
                            <h3>CAMBIAR CONTRASE√ëA</h3>
                            <form id="passwordForm">
                                <div class="form-group">
                                    <label>CONTRASE√ëA ACTUAL</label>
                                    <input type="password" id="currentPassword" class="form-input" required>
                                </div>
                                <div class="form-group">
                                    <label>NUEVA CONTRASE√ëA</label>
                                    <input type="password" id="newPassword" class="form-input" required minlength="6">
                                </div>
                                <div class="form-group">
                                    <label>CONFIRMAR NUEVA CONTRASE√ëA</label>
                                    <input type="password" id="confirmPassword" class="form-input" required minlength="6">
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    üíæ GUARDAR
                                </button>
                            </form>
                        </div>
                    </div>
                    
                    <div id="perfilTab" class="tab-content">
                        <h3>Configuraci√≥n de Perfil</h3>
                        <p>Configuraci√≥n de perfil del usuario.</p>
                    </div>
                    
                    <div id="pendienteTab" class="tab-content">
                        <h3>Expedientes Pendientes</h3>
                        <p>Gesti√≥n de expedientes pendientes.</p>
                    </div>
                    
                    <div id="rolesTab" class="tab-content">
                        <h3>GESTI√ìN DE ROLES</h3>
                        <p style="color: var(--gray-600); margin-bottom: 1.5rem;">Administraci√≥n de roles y permisos del sistema.</p>
                        
                        <div class="roles-section">
                            <h4>üë• Usuarios del Sistema</h4>
                            <div id="usersList" class="users-list">
                                <!-- Los usuarios se cargar√°n din√°micamente -->
                            </div>
                        </div>
                        
                        <div class="roles-section">
                            <h4>üîß Gesti√≥n de Roles</h4>
                            <div class="role-management">
                                <div class="role-form">
                                    <h5>Cambiar Rol de Usuario</h5>
                                    <div class="form-row">
                                        <select id="userSelect" class="form-select">
                                            <option value="">Seleccionar usuario...</option>
                                        </select>
                                        <select id="roleSelect" class="form-select">
                                            <option value="">Seleccionar rol...</option>
                                            <option value="ADMIN">Administrador</option>
                                            <option value="MESA_DE_ENTRADA">Mesa de Entrada</option>
                                            <option value="PERSONAL">Personal</option>
                                        </select>
                                        <button onclick="cambiarRolUsuario()" class="btn" style="background: var(--primary-blue); color: white;">
                                            üîÑ Cambiar Rol
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="roles-section">
                            <h4>üîê Roles Disponibles</h4>
                            <div class="roles-info">
                                <div class="role-item">
                                    <strong>ADMIN</strong>
                                    <span class="role-badge admin">Administrador</span>
                                    <p>Acceso completo al sistema. Puede modificar cualquier expediente.</p>
                                </div>
                                <div class="role-item">
                                    <strong>MESA_DE_ENTRADA</strong>
                                    <span class="role-badge mesa">Mesa de Entrada</span>
                                    <p>Puede crear y gestionar expedientes. Solo modifica sus propios expedientes.</p>
                                </div>
                                <div class="role-item">
                                    <strong>PERSONAL</strong>
                                    <span class="role-badge personal">Personal</span>
                                    <p>Acceso limitado. Solo puede ver y modificar sus propios expedientes.</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="roles-section">
                            <h4>üìä Estad√≠sticas de Usuarios</h4>
                            <div id="userStats" class="user-stats">
                                <!-- Las estad√≠sticas se cargar√°n din√°micamente -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <script>
        // --- SISTEMA DE BASE DE DATOS √öNICA REAL CON FIREBASE ---
        
        // Configuraci√≥n de Firebase (Reemplaza con tu configuraci√≥n)
        const firebaseConfig = {
            apiKey: "AIzaSyB_-cqRyOGZd7nH663Y-5ddwisEFldsdYA",
            authDomain: "parque-automotor-db88c.firebaseapp.com",
            projectId: "parque-automotor-db88c",
            storageBucket: "parque-automotor-db88c.firebasestorage.app",
            messagingSenderId: "418834641605",
            appId: "1:418834641605:web:cafb3339898e2fc488f6ac",
            measurementId: "G-GCLMPTZ9X6",
            // ‚úÖ Realtime Database URL (se activa autom√°ticamente al crear la base de datos)
            databaseURL: "https://parque-automotor-db88c-default-rtdb.firebaseio.com/"
        };
        
        // ‚úÖ ACTIVAR FIREBASE PARA BASE DE DATOS REAL COMPARTIDA
        const useFirebase = true; // ¬°Ahora Firebase est√° activo!
        
        // Variables globales
        const CENTRAL_DATABASE_KEY = 'PARQUE_AUTOMOTOR_CENTRAL_DB';
        const DEVICE_ID = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        
        let centralDatabase = null;
        let firebaseDB = null;
        let isFirebaseConnected = false;
        
        // INICIALIZAR FIREBASE PARA BASE DE DATOS REAL COMPARTIDA
        async function initializeFirebase() {
            if (!useFirebase) {
                console.log('‚ö†Ô∏è Firebase deshabilitado. Usando sistema local.');
                return false;
            }
            
            try {
                console.log('üî• Inicializando Firebase...');
                
                // Inicializar Firebase
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                
                // Obtener referencia a la base de datos
                firebaseDB = firebase.database();
                
                // Configurar listeners en tiempo real
                setupFirebaseListeners();
                
                isFirebaseConnected = true;
                console.log('‚úÖ Firebase conectado exitosamente');
                
                // Cargar datos iniciales desde Firebase
                await loadInitialFirebaseData();
                
                // Migrar datos locales a Firebase si es necesario
                await migrateToFirebase();
                
                return true;
                
            } catch (error) {
                console.error('‚ùå Error conectando a Firebase:', error);
                isFirebaseConnected = false;
                return false;
            }
        }
        
        // Cargar datos iniciales desde Firebase
        async function loadInitialFirebaseData() {
            if (!isFirebaseConnected) return;
            
            try {
                console.log('üì• Cargando datos iniciales desde Firebase...');
                
                const categories = ['expedientesCreados', 'expedientesFinalizados', 'expedientesEjecutivo', 'expedientesCompras'];
                
                for (const category of categories) {
                    const data = await getFromFirebase(category);
                    centralCache[category] = data;
                    console.log(`üìä [FIREBASE] ${category}: ${data.length} expedientes cargados`);
                }
                
                centralCache.lastUpdate = new Date().toISOString();
                console.log('‚úÖ Datos iniciales de Firebase cargados');
                
            } catch (error) {
                console.error('‚ùå Error cargando datos iniciales de Firebase:', error);
            }
        }
        
        // SISTEMA DE BASE DE DATOS CENTRAL - UNA SOLA FUENTE PARA TODOS
        async function initializeCentralDatabase() {
            try {
                console.log('üóÑÔ∏è Inicializando base de datos central...');
                
                // PRIMERO: Intentar Firebase (base de datos real compartida)
                const firebaseReady = await initializeFirebase();
                
                if (firebaseReady) {
                    console.log('üî• Firebase inicializado correctamente');
                    // Firebase est√° activo, no necesitamos fallback
                } else {
                    // FALLBACK: Usar IndexedDB local
                    if ('indexedDB' in window) {
                        centralDatabase = await openIndexedDB();
                        console.log('‚úÖ Base de datos IndexedDB inicializada (fallback)');
                    } else {
                        // √öLTIMO RECURSO: localStorage
                        centralDatabase = {
                            type: 'localStorage',
                            key: CENTRAL_DATABASE_KEY
                        };
                        console.log('‚úÖ Base de datos localStorage inicializada (fallback)');
                    }
                }
                
                // Migrar datos existentes a la base central si es necesario
                await migrateToCentralDatabase();
                
                // Cargar datos iniciales en cach√©
                await loadAllCentralData();
                
            } catch (error) {
                console.error('‚ùå Error inicializando base de datos central:', error);
                // Fallback to localStorage
                centralDatabase = {
                    type: 'localStorage',
                    key: CENTRAL_DATABASE_KEY
                };
            }
        }
        
        function openIndexedDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('ParqueAutomotorDB', 1);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve(request.result);
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    
                    // Crear tabla de expedientes si no existe
                    if (!db.objectStoreNames.contains('expedientes')) {
                        const store = db.createObjectStore('expedientes', { keyPath: 'id' });
                        store.createIndex('categoria', 'categoria', { unique: false });
                        store.createIndex('codigo', 'codigo', { unique: false });
                    }
                };
            });
        }
        
        // Leer expedientes de la base de datos central
        async function getCentralExpedientes(category) {
            try {
                console.log(`üóÑÔ∏è [CENTRAL DB] Leyendo ${category}...`);
                
                // PRIORIDAD 1: Intentar leer de Firebase (base de datos real compartida)
                if (isFirebaseConnected) {
                    const firebaseData = await getFromFirebase(category);
                    if (firebaseData && Array.isArray(firebaseData)) {
                        console.log(`üî• [FIREBASE] ${category}: ${firebaseData.length} expedientes`);
                        // Actualizar cach√© local
                        centralCache[category] = firebaseData;
                        return firebaseData;
                    }
                }
                
                // FALLBACK: Usar sistema local
                if (centralDatabase && centralDatabase.type === 'indexedDB') {
                    // Usar IndexedDB
                    return await getFromIndexedDB(category);
                } else {
                    // Usar localStorage central
                    return getFromCentralLocalStorage(category);
                }
            } catch (error) {
                console.error('‚ùå Error leyendo base central:', error);
                return [];
            }
        }
        
        async function getFromIndexedDB(category) {
            return new Promise((resolve, reject) => {
                const transaction = centralDatabase.transaction(['expedientes'], 'readonly');
                const store = transaction.objectStore('expedientes');
                const index = store.index('categoria');
                const request = index.getAll(category);
                
                request.onsuccess = () => {
                    const expedientes = request.result.map(item => item.data);
                    console.log(`üìä [IndexedDB] ${category}: ${expedientes.length} expedientes`);
                    resolve(expedientes);
                };
                
                request.onerror = () => reject(request.error);
            });
        }
        
        function getFromCentralLocalStorage(category) {
            try {
                // Usar solo localStorage central (Firebase se maneja en getCentralExpedientes)
                const centralKey = `${CENTRAL_DATABASE_KEY}_${category}`;
                const data = localStorage.getItem(centralKey);
                const expedientes = data ? JSON.parse(data) : [];
                console.log(`üìä [Central LocalStorage] ${category}: ${expedientes.length} expedientes`);
                return expedientes;
            } catch (error) {
                console.error('‚ùå Error leyendo localStorage central:', error);
                return [];
            }
        }
        
        
        // Wrapper para mantener compatibilidad
        function getGlobalExpedientes(category) {
            // PRIORIDAD 1: Intentar Firebase si est√° conectado
            if (isFirebaseConnected) {
                console.log(`üî• [FIREBASE] Obteniendo ${category} desde Firebase...`);
                // Firebase se maneja de forma as√≠ncrona, pero para compatibilidad usamos cach√©
                return centralCache[category] || [];
            }
            
            // FALLBACK: Usar localStorage central
            console.log(`üìä [FALLBACK] Obteniendo ${category} desde localStorage...`);
            return getFromCentralLocalStorage(category);
        }
        
        let centralCache = {
            expedientesCreados: [],
            expedientesFinalizados: [],
            expedientesEjecutivo: [],
            expedientesCompras: [],
            lastUpdate: null
        };
        
        function getCachedCentralData(category) {
            return centralCache[category] || [];
        }
        
        async function updateCentralCache(category) {
            try {
                const data = await getCentralExpedientes(category);
                centralCache[category] = data;
                centralCache.lastUpdate = new Date().toISOString();
            } catch (error) {
                console.error('‚ùå Error actualizando cach√© central:', error);
            }
        }
        
        // Migrar datos existentes de localStorage individual a base central
        async function migrateToCentralDatabase() {
            try {
                console.log('üîÑ Migrando datos existentes a base de datos central...');
                
                const categories = ['expedientesCreados', 'expedientesFinalizados', 'expedientesEjecutivo', 'expedientesCompras'];
                let migratedAny = false;
                
                for (const category of categories) {
                    // Verificar si ya existe en base central
                    const centralData = await getCentralExpedientes(category);
                    
                    if (centralData.length === 0) {
                        // No hay datos centrales, migrar desde localStorage local
                        const localData = JSON.parse(localStorage.getItem(category) || '[]');
                        const oldGlobalData = JSON.parse(localStorage.getItem('SISTEMA_PARQUE_AUTOMOTOR_GLOBAL') || '{}')[category] || [];
                        
                        // Combinar datos locales con datos globales antiguos
                        const allLocalData = [...localData, ...oldGlobalData];
                        
                        if (allLocalData.length > 0) {
                            console.log(`üì¶ Migrando ${category}: ${allLocalData.length} expedientes`);
                            await setCentralExpedientes(category, allLocalData);
                            migratedAny = true;
                        }
                    }
                }
                
                if (migratedAny) {
                    console.log('‚úÖ Migraci√≥n completada - todos los expedientes ahora est√°n en la base central');
                } else {
                    console.log('‚ÑπÔ∏è No hab√≠a datos para migrar o ya est√°n en la base central');
                }
                
            } catch (error) {
                console.error('‚ùå Error durante migraci√≥n:', error);
            }
        }
        
        // Cargar todos los datos centrales en cach√©
        async function loadAllCentralData() {
            try {
                console.log('üì• Cargando datos centrales en cach√©...');
                
                // Firebase maneja la sincronizaci√≥n autom√°ticamente
                
                // DESPU√âS: Cargar datos restantes del cach√©
                const categories = ['expedientesCreados', 'expedientesFinalizados', 'expedientesEjecutivo', 'expedientesCompras'];
                
                for (const category of categories) {
                    await updateCentralCache(category);
                }
                
                console.log('‚úÖ Cach√© central cargado completamente');
                
            } catch (error) {
                console.error('‚ùå Error cargando datos centrales:', error);
            }
        }
        
        // Actualizar listeners para base de datos central
        function setupCentralDatabaseListeners() {
            // Escuchar eventos de actualizaci√≥n de base central
            window.addEventListener('centralDatabaseUpdate', async (event) => {
                if (event.detail.deviceId !== DEVICE_ID) {
                    console.log('üîÑ Actualizando desde otro dispositivo (central DB):', event.detail);
                    await updateCentralCache(event.detail.category);
                    refreshAllSections();
                }
            });
            
            // BroadcastChannel para comunicaci√≥n cross-tab
            if (typeof BroadcastChannel !== 'undefined') {
                const channel = new BroadcastChannel('central_db_sync');
                channel.addEventListener('message', async (event) => {
                    if (event.data.type === 'database_update' && event.data.deviceId !== DEVICE_ID) {
                        console.log('üìª Mensaje central DB recibido:', event.data);
                        await updateCentralCache(event.data.category);
                        refreshAllSections();
                    }
                });
            }
            
            console.log('‚úÖ Listeners de base de datos central configurados');
        }
        
        function getFromLocalStorage(category) {
            try {
                // Usar localStorage central en lugar del antiguo GLOBAL_STORAGE_KEY
                return getFromCentralLocalStorage(category);
            } catch {
                return [];
            }
        }
        
        function getFromSharedStorage(category) {
            try {
                // Use sessionStorage as a secondary source (shared across tabs)
                const sharedKey = `SHARED_${CENTRAL_DATABASE_KEY}`;
                const sharedStorage = JSON.parse(sessionStorage.getItem(sharedKey) || '{}');
                return sharedStorage[category] || [];
            } catch {
                return [];
            }
        }
        
        function getFromUrlHash(category) {
            try {
                // Try to read data from URL hash (for cross-device sharing)
                const hashData = window.location.hash.substr(1);
                if (hashData && hashData.startsWith('data=')) {
                    const encoded = hashData.substr(5);
                    const decoded = JSON.parse(atob(encoded));
                    return decoded[category] || [];
                }
                return [];
            } catch {
                return [];
            }
        }
        
        function mergeExpedienteSources(sources) {
            const expedientesMap = new Map();
            
            // Merge all sources, using codigo as unique key
            sources.forEach(source => {
                if (Array.isArray(source)) {
                    source.forEach(exp => {
                        if (exp && exp.codigo) {
                            // Use the most recent version (by fechaCreacion or fechaModificacion)
                            const existing = expedientesMap.get(exp.codigo);
                            if (!existing || (exp.fechaModificacion || exp.fechaCreacion) > (existing.fechaModificacion || existing.fechaCreacion)) {
                                expedientesMap.set(exp.codigo, exp);
                            }
                        }
                    });
                }
            });
            
            return Array.from(expedientesMap.values());
        }
        
        // GUARDAR EN BASE DE DATOS CENTRAL - UNA SOLA FUENTE PARA TODOS
        // FUNCIONES DE FIREBASE PARA BASE DE DATOS REAL COMPARTIDA
        async function saveToFirebase(category, data) {
            if (!isFirebaseConnected) return false;
            
            try {
                console.log(`üî• Guardando en Firebase ${category}:`, data.length, 'expedientes');
                
                const timestampedData = data.map(exp => ({
                    ...exp,
                    fechaModificacion: new Date().toISOString(),
                    lastDevice: DEVICE_ID
                }));
                
                // Guardar en Firebase Realtime Database
                await firebaseDB.ref(`expedientes/${category}`).set(timestampedData);
                
                console.log(`‚úÖ [FIREBASE] ${category} guardado exitosamente`);
                return true;
                
            } catch (error) {
                console.error(`‚ùå Error guardando en Firebase ${category}:`, error);
                return false;
            }
        }
        
        async function getFromFirebase(category) {
            if (!isFirebaseConnected) return [];
            
            try {
                console.log(`üî• Leyendo de Firebase ${category}...`);
                
                const snapshot = await firebaseDB.ref(`expedientes/${category}`).once('value');
                const data = snapshot.val() || [];
                
                console.log(`üìä [FIREBASE] ${category}: ${Array.isArray(data) ? data.length : 0} expedientes`);
                return Array.isArray(data) ? data : [];
                
            } catch (error) {
                console.error(`‚ùå Error leyendo de Firebase ${category}:`, error);
                return [];
            }
        }
        
        function setupFirebaseListeners() {
            if (!isFirebaseConnected) return;
            
            console.log('üëÇ Configurando listeners de Firebase...');
            
            const categories = ['expedientesCreados', 'expedientesFinalizados', 'expedientesEjecutivo', 'expedientesCompras'];
            
            categories.forEach(category => {
                firebaseDB.ref(`expedientes/${category}`).on('value', (snapshot) => {
                    const data = snapshot.val() || [];
                    console.log(`üîÑ [FIREBASE LISTENER] ${category} actualizado:`, Array.isArray(data) ? data.length : 0, 'expedientes');
                    
                    // Actualizar cach√© local
                    centralCache[category] = Array.isArray(data) ? data : [];
                    centralCache.lastUpdate = new Date().toISOString();
                    
                    // Refrescar interface
                    refreshAllSections();
                });
            });
            
            console.log('‚úÖ Listeners de Firebase configurados');
        }
        
        async function migrateToFirebase() {
            if (!isFirebaseConnected) return;
            
            console.log('üì¶ Migrando datos locales a Firebase...');
            
            const categories = ['expedientesCreados', 'expedientesFinalizados', 'expedientesEjecutivo', 'expedientesCompras'];
            
            for (const category of categories) {
                try {
                    // Verificar si ya hay datos en Firebase
                    const firebaseData = await getFromFirebase(category);
                    
                    if (firebaseData.length === 0) {
                        // No hay datos en Firebase, migrar desde localStorage
                        const localData = JSON.parse(localStorage.getItem(`${CENTRAL_DATABASE_KEY}_${category}`) || '[]');
                        
                        if (localData.length > 0) {
                            console.log(`üì§ Migrando ${category} a Firebase:`, localData.length, 'expedientes');
                            await saveToFirebase(category, localData);
                        }
                    }
                } catch (error) {
                    console.error(`‚ùå Error migrando ${category} a Firebase:`, error);
                }
            }
            
            console.log('‚úÖ Migraci√≥n a Firebase completada');
        }
        
        async function setCentralExpedientes(category, data) {
            try {
                console.log(`üíæ [CENTRAL DB] Guardando ${category}:`, data.length, 'expedientes');
                
                // Add timestamp to each expediente
                const timestampedData = data.map(exp => ({
                    ...exp,
                    fechaModificacion: new Date().toISOString(),
                    lastDevice: DEVICE_ID
                }));
                
                // PRIORIDAD 1: Intentar guardar en Firebase (base de datos real compartida)
                const firebaseSaved = await saveToFirebase(category, timestampedData);
                
                if (!firebaseSaved) {
                    // FALLBACK: Guardar en sistema local
                    if (centralDatabase && centralDatabase.type === 'indexedDB') {
                        await saveToCentralIndexedDB(category, timestampedData);
                    } else {
                        saveToCentralLocalStorage(category, timestampedData);
                    }
                }
                
                // Actualizar cach√© local inmediatamente
                centralCache[category] = timestampedData;
                centralCache.lastUpdate = new Date().toISOString();
                
                // Trigger eventos para otros tabs (solo si no es Firebase)
                if (!firebaseSaved) {
                    triggerCentralDatabaseUpdate(category, timestampedData);
                }
                
                // Firebase maneja la sincronizaci√≥n autom√°ticamente
                
                console.log(`‚úÖ [CENTRAL DB] ${category} guardado exitosamente`);
                
            } catch (error) {
                console.error('‚ùå Error guardando en base central:', error);
                // Fallback to localStorage
                saveToCentralLocalStorage(category, data);
            }
        }
        
        async function saveToCentralIndexedDB(category, data) {
            return new Promise((resolve, reject) => {
                const transaction = centralDatabase.transaction(['expedientes'], 'readwrite');
                const store = transaction.objectStore('expedientes');
                
                // Limpiar datos existentes de esta categor√≠a
                const index = store.index('categoria');
                const deleteRequest = index.openCursor(category);
                
                deleteRequest.onsuccess = (event) => {
                    const cursor = event.target.result;
                    if (cursor) {
                        cursor.delete();
                        cursor.continue();
                    } else {
                        // Agregar nuevos datos
                        data.forEach((expediente, index) => {
                            store.add({
                                id: `${category}_${expediente.codigo}_${Date.now()}_${index}`,
                                categoria: category,
                                codigo: expediente.codigo,
                                data: expediente
                            });
                        });
                        resolve();
                    }
                };
                
                deleteRequest.onerror = () => reject(deleteRequest.error);
            });
        }
        
        function saveToCentralLocalStorage(category, data) {
            try {
                const centralKey = `${CENTRAL_DATABASE_KEY}_${category}`;
                localStorage.setItem(centralKey, JSON.stringify(data));
                console.log(`‚úÖ [Central LocalStorage] ${category} guardado`);
                
                // Firebase maneja la sincronizaci√≥n autom√°ticamente
            } catch (error) {
                console.error('‚ùå Error guardando en localStorage central:', error);
            }
        }
        
        
        function triggerCentralDatabaseUpdate(category, data) {
            // Evento para otros tabs
            window.dispatchEvent(new CustomEvent('centralDatabaseUpdate', {
                detail: { category, data, timestamp: new Date().toISOString(), deviceId: DEVICE_ID }
            }));
            
            // BroadcastChannel para comunicaci√≥n cross-tab
            if (typeof BroadcastChannel !== 'undefined') {
                const channel = new BroadcastChannel('central_db_sync');
                channel.postMessage({
                    type: 'database_update',
                    category,
                    data,
                    timestamp: new Date().toISOString(),
                    deviceId: DEVICE_ID
                });
            }
        }
        
        // Wrapper para mantener compatibilidad
        function setGlobalExpedientes(category, data) {
            // Llamar a la nueva funci√≥n central de forma as√≠ncrona
            setCentralExpedientes(category, data).catch(error => {
                console.error('‚ùå Error en setGlobalExpedientes:', error);
            });
        }
        
        function saveToLocalStorage(category, data) {
            try {
                // Usar el sistema central en lugar del antiguo global storage
                saveToCentralLocalStorage(category, data);
            } catch (error) {
                console.error('Error saving to localStorage:', error);
            }
        }
        
        function saveToSharedStorage(category, data) {
            try {
                const sharedKey = `SHARED_${CENTRAL_DATABASE_KEY}`;
                const sharedStorage = JSON.parse(sessionStorage.getItem(sharedKey) || '{}');
                sharedStorage[category] = data;
                sharedStorage.lastUpdated = new Date().toISOString();
                sharedStorage.deviceId = DEVICE_ID;
                sessionStorage.setItem(sharedKey, JSON.stringify(sharedStorage));
            } catch (error) {
                console.error('Error saving to sessionStorage:', error);
            }
        }
        
        function saveToUrlHash(category, data) {
            try {
                // Create a shareable URL with data encoded in hash
                const allData = getAllGlobalExpedientes();
                allData[category] = data;
                allData.lastUpdated = new Date().toISOString();
                allData.deviceId = DEVICE_ID;
                
                // Encode data in URL hash for sharing
                const encoded = btoa(JSON.stringify(allData));
                const newHash = `#data=${encoded}`;
                
                // Update URL without triggering page reload
                if (window.location.hash !== newHash) {
                    window.history.replaceState(null, '', newHash);
                    console.log(`üîó [${DEVICE_ID}] URL actualizada para sincronizaci√≥n cross-device`);
                }
            } catch (error) {
                console.error('Error saving to URL hash:', error);
            }
        }
        
        function triggerCrossDeviceSync(category, data) {
            try {
                // Trigger update event for other tabs/windows
                window.dispatchEvent(new CustomEvent('expedientesUpdated', { 
                    detail: { category, data, timestamp: new Date().toISOString(), deviceId: DEVICE_ID } 
                }));
                
                // Try to use BroadcastChannel for cross-tab communication
                if (typeof BroadcastChannel !== 'undefined') {
                    const channel = new BroadcastChannel('expedientes_sync');
                    channel.postMessage({
                        type: 'expediente_update',
                        category,
                        data,
                        timestamp: new Date().toISOString(),
                        deviceId: DEVICE_ID
                    });
                }
                
                // Show cross-device sharing instructions
                showCrossDeviceInstructions();
                
            } catch (error) {
                console.error('Error triggering cross-device sync:', error);
            }
        }
        
        function showCrossDeviceInstructions() {
            if (!window.crossDeviceInstructionsShown) {
                console.log('üì±üíª SINCRONIZACI√ìN CROSS-DEVICE ACTIVA:');
                console.log('  1. Copia la URL actual completa (incluye #data=...)');
                console.log('  2. Pega la URL en otro dispositivo/navegador');
                console.log('  3. Los expedientes se sincronizar√°n autom√°ticamente');
                console.log('  üîó URL actual:', window.location.href);
                window.crossDeviceInstructionsShown = true;
            }
        }
        
        function getAllGlobalExpedientes() {
            try {
                // Usar el cach√© central en lugar de localStorage individual
                const data = {
                    creados: centralCache.expedientesCreados || [],
                    finalizados: centralCache.expedientesFinalizados || [],
                    ejecutivo: centralCache.expedientesEjecutivo || [],
                    compras: centralCache.expedientesCompras || [],
                    lastUpdated: centralCache.lastUpdate,
                    version: centralCache.version || 1 // Usar versi√≥n estable del cach√©
                };
                
                // Calcular hash simple basado en contenido para versi√≥n estable
                const contentString = JSON.stringify({
                    creados: data.creados.length,
                    finalizados: data.finalizados.length,
                    ejecutivo: data.ejecutivo.length,
                    compras: data.compras.length,
                    lastUpdate: data.lastUpdated
                });
                data.version = hashSimple(contentString);
                
                return data;
            } catch (error) {
                console.error('Error reading all global expedientes:', error);
                return { creados: [], finalizados: [], ejecutivo: [], compras: [], version: 1 };
            }
        }
        
        function hashSimple(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32bit integer
            }
            return Math.abs(hash);
        }

        // --- Persistencia con localStorage ---
        function parseJSONSafe(text, fallback) {
            try { return JSON.parse(text || ''); } catch { return fallback; }
        }

        // Global storage functions - now all expedientes are shared across all users and browsers
        async function getStoredCreated() {
            // Usar directamente la base de datos central (Firebase)
            const centralData = await getCentralExpedientes('expedientesCreados');
            if (centralData && centralData.length > 0) {
                return centralData;
            }
            
            // Fallback a localStorage local
            const localData = parseJSONSafe(localStorage.getItem('expedientesCreados'), []);
            if (localData.length > 0) {
                setGlobalExpedientes('expedientesCreados', localData);
                return localData;
            }
            return centralData || [];
        }
        function setStoredCreated(list) {
            setGlobalExpedientes('expedientesCreados', list);
            // Also keep in localStorage for compatibility
            localStorage.setItem('expedientesCreados', JSON.stringify(list));
            
            // Force update sync URL whenever expedientes are modified
            setTimeout(() => {
                // Firebase maneja la sincronizaci√≥n autom√°ticamente
            }, 100);
        }

        async function getStoredFinalizados() {
            const centralData = await getCentralExpedientes('expedientesFinalizados');
            if (centralData && centralData.length > 0) {
                return centralData;
            }
            
            const localData = parseJSONSafe(localStorage.getItem('expedientesFinalizados'), []);
            if (localData.length > 0) {
                setGlobalExpedientes('expedientesFinalizados', localData);
                return localData;
            }
            return centralData || [];
        }
        function setStoredFinalizados(list) {
            setGlobalExpedientes('expedientesFinalizados', list);
            localStorage.setItem('expedientesFinalizados', JSON.stringify(list));
        }

        async function getStoredEjecutivo() {
            const centralData = await getCentralExpedientes('expedientesEjecutivo');
            if (centralData && centralData.length > 0) {
                return centralData;
            }
            
            const localData = parseJSONSafe(localStorage.getItem('expedientesEjecutivo'), []);
            if (localData.length > 0) {
                setGlobalExpedientes('expedientesEjecutivo', localData);
                return localData;
            }
            return centralData || [];
        }
        function setStoredEjecutivo(list) {
            setGlobalExpedientes('expedientesEjecutivo', list);
            localStorage.setItem('expedientesEjecutivo', JSON.stringify(list));
            
            // Force update sync URL whenever expedientes are modified
            setTimeout(() => {
                // Firebase maneja la sincronizaci√≥n autom√°ticamente
            }, 100);
        }

        async function getStoredCompras() {
            const centralData = await getCentralExpedientes('expedientesCompras');
            if (centralData && centralData.length > 0) {
                return centralData;
            }
            
            const localData = parseJSONSafe(localStorage.getItem('expedientesCompras'), []);
            if (localData.length > 0) {
                setGlobalExpedientes('expedientesCompras', localData);
                return localData;
            }
            return centralData || [];
        }
        function setStoredCompras(list) {
            setGlobalExpedientes('expedientesCompras', list);
            localStorage.setItem('expedientesCompras', JSON.stringify(list));
            
            // Force update sync URL whenever expedientes are modified
            setTimeout(() => {
                // Firebase maneja la sincronizaci√≥n autom√°ticamente
            }, 100);
        }

        // Funciones para Hospitales
        async function getStoredHospitales() {
            const centralData = await getCentralExpedientes('expedientesHospitales');
            if (centralData && centralData.length > 0) {
                return centralData;
            }
            
            const localData = parseJSONSafe(localStorage.getItem('expedientesHospitales'), []);
            if (localData.length > 0) {
                setGlobalExpedientes('expedientesHospitales', localData);
                return localData;
            }
            return centralData || [];
        }
        function setStoredHospitales(list) {
            setGlobalExpedientes('expedientesHospitales', list);
            localStorage.setItem('expedientesHospitales', JSON.stringify(list));
            
            // Force update sync URL whenever expedientes are modified
            setTimeout(() => {
                // Firebase maneja la sincronizaci√≥n autom√°ticamente
            }, 100);
        }

        // Funciones para Otros
        async function getStoredOtros() {
            const centralData = await getCentralExpedientes('expedientesOtros');
            if (centralData && centralData.length > 0) {
                return centralData;
            }
            
            const localData = parseJSONSafe(localStorage.getItem('expedientesOtros'), []);
            if (localData.length > 0) {
                setGlobalExpedientes('expedientesOtros', localData);
                return localData;
            }
            return centralData || [];
        }
        function setStoredOtros(list) {
            setGlobalExpedientes('expedientesOtros', list);
            localStorage.setItem('expedientesOtros', JSON.stringify(list));
            
            // Force update sync URL whenever expedientes are modified
            setTimeout(() => {
                // Firebase maneja la sincronizaci√≥n autom√°ticamente
            }, 100);
        }

        async function renderAllInCreated() {
            console.log('üöÄ INICIANDO renderAllInCreated...');
            // SOLO mostrar expedientes que est√°n en "creados" - no mezclar con otras secciones
            const createdList = await getStoredCreated();
            console.log('üìä Datos obtenidos de creados:', createdList);
            const finList = await getStoredFinalizados();

            const expedientesCreados = document.getElementById('expedientesCreados');
            const emptyExpedientes = document.getElementById('emptyExpedientes');
            
            // Clear current list items
            const itemsToRemove = expedientesCreados.querySelectorAll('.expediente-item');
            Array.from(itemsToRemove).forEach(n => n.remove());

            // Solo procesar expedientes creados
            const entries = createdList || [];
            console.log('üìä Entries a procesar:', entries.length);
            
            if (!entries.length) {
                console.log('üì¶ No hay expedientes en creados para renderizar');
                if (emptyExpedientes) emptyExpedientes.style.display = 'block';
                return;
            }
            
            if (emptyExpedientes) emptyExpedientes.style.display = 'none';
            
            entries.forEach((data, index) => {
                
                const item = document.createElement('div');
                item.className = 'expediente-item';
                const isFinal = data.estado === 'FINALIZADO';
                console.log(`    üìä Estado: ${isFinal ? 'FINALIZADO' : 'PENDIENTE'} (C√≥digo: ${data.codigo})`);
                
                item.innerHTML = `
                    <div class="status-badge ${isFinal ? 'status-finalizado' : 'status-pendiente'}">${isFinal ? 'FINALIZADO' : 'PENDIENTE'}</div>
                    <div class="expediente-header">${data.codigo} - ${data.detalle || 'Sin descripci√≥n'}</div>
                    <div class="expediente-details">
                        <strong>üìÖ ${formatDateEs(new Date(data.fechaIngreso || new Date()))}</strong><br>
                        <strong>C√≥digo:</strong> ${data.codigo}<br>
                        <strong>N√∫mero:</strong> ${data.numero || 'N/A'}/${data.anio || '2025'}<br>
                        <strong>Corresponde:</strong> ${data.corresponde || 'N/A'}<br>
                        <strong>Derivado a:</strong> ${data.derivado || 'N/A'}<br>
                        <strong>D√≠as de tr√°mite:</strong> ${data.diasTramite || 0} d√≠as
                        ${data.observacion ? '<br><strong>Observaci√≥n:</strong> ' + data.observacion : ''}
                        ${data.creadoPorNombre ? '<br><strong>üë§ Creado por:</strong> ' + data.creadoPorNombre : ''}
                    </div>
                    ${!isFinal ? `
                    <div class="item-actions">
                        <label style="display:flex;align-items:center;gap:0.4rem;color:var(--gray-700);">
                            <input type="checkbox" class="select-checkbox" /> Seleccionar
                        </label>
                        <select class="inline-select" aria-label="Mover a" disabled>
                            <option value="">Enviar a...</option>
                            <option value="ejecutivo">Parque Automotor Ejecutivo</option>
                            <option value="compra">Compras</option>
                            <option value="hospitales">Hospitales</option>
                            <option value="otros">Otros</option>
                        </select>
                        <button class="send-btn" disabled>Enviar</button>
                        <button class="finalize-btn" onclick="finalizeExpediente('${data.codigo}', this)" title="Finalizar expediente">‚úÖ Finalizar</button>
                        <button class="edit-btn" onclick="editExpediente('${data.codigo}')" title="Modificar expediente">‚úèÔ∏è</button>
                        <button class="delete-btn" onclick="deleteExpedienteCreado('${data.codigo}')" title="Eliminar expediente">üóëÔ∏è</button>
                    </div>
                    ` : `
                    <div class="item-actions" style="opacity: 0.6; pointer-events: none;">
                    </div>
                    `}
                `;
                
                console.log(`    üîß Agregando handlers para:`, data.codigo);
                attachExpedienteItemHandlers(item, data);
                
                console.log(`    üìç Insertando en DOM:`, data.codigo);
                expedientesCreados.insertBefore(item, emptyExpedientes);
                console.log(`    ‚úÖ Expediente ${data.codigo} renderizado exitosamente`);
            });
            
            console.log('üéâ Renderizado completado. Total de expedientes en DOM:', expedientesCreados.querySelectorAll('.expediente-item').length);
        }

        function buildFinalizadoItem(data) {
            const back = document.createElement('div');
            back.className = 'expediente-item';
            back.innerHTML = `
                <div class="status-badge status-finalizado">FINALIZADO</div>
                <div class="expediente-header">${data.codigo} - ${data.detalle || 'Sin descripci√≥n'}</div>
                <div class="expediente-details">
                    <strong>üìÖ ${formatDateEs(new Date(data.fechaIngreso))}</strong><br>
                    <strong>C√≥digo:</strong> ${data.codigo}<br>
                    <strong>N√∫mero:</strong> ${data.numero || 'N/A'}/${data.anio || '2025'}<br>
                    <strong>Corresponde:</strong> ${data.corresponde || 'N/A'}<br>
                    <strong>Derivado a:</strong> ${data.derivado || 'N/A'}<br>
                    <strong>D√≠as de tr√°mite:</strong> ${data.diasTramite || 0} d√≠as
                    ${data.observacion ? '<br><strong>Observaci√≥n:</strong> ' + data.observacion : ''}
                </div>
            `;
            return back;
        }

        // renderStoredFinalizados ya no se usa, centralizamos en renderAllInCreated

        function ensureCompraContainer() {
            let compraContainer = document.getElementById('compraContainer');
            if (!compraContainer) {
                compraContainer = document.createElement('div');
                compraContainer.id = 'compraContainer';
                compraContainer.className = 'compras-container';
                const compraSection = document.querySelector('.section-card:nth-of-type(3) .section-content');
                if (compraSection) {
                compraSection.appendChild(compraContainer);
                }
            }
            return compraContainer;
        }

        async function renderStoredEjecutivo() {
            const list = await getStoredEjecutivo();
            const execSection = document.getElementById('executiveSection');
            const emptyExec = document.getElementById('emptyExecutive');
            
            // Limpiar elementos existentes (excepto emptyExec)
            const existingItems = execSection.querySelectorAll('.executive-item');
            existingItems.forEach(item => item.remove());
            
            if (!Array.isArray(list) || list.length === 0) {
                console.log('üè¢ No hay expedientes en ejecutivo para renderizar');
                if (emptyExec) emptyExec.style.display = 'block';
                return;
            }
            
            console.log(`üè¢ Renderizando ${list.length} expedientes en ejecutivo (incluyendo finalizados)...`);
            if (emptyExec) emptyExec.style.display = 'none';
            
            list.forEach(d => {
                const el = buildExecutiveItemSimple(d);
                execSection.insertBefore(el, emptyExec);
                console.log(`‚úÖ Expediente ${d.codigo} (${d.estado || 'PENDIENTE'}) renderizado en ejecutivo`);
            });
        }

        // Funci√≥n para renderizar expedientes finalizados
        async function renderStoredFinalizados() {
            console.log('üöÄ INICIANDO renderStoredFinalizados...');
            const list = await getStoredFinalizados();
            console.log('üìä Datos obtenidos de finalizados:', list);
            
            // Crear o encontrar el contenedor de finalizados
            let finalizadosContainer = document.getElementById('finalizadosContainer');
            if (!finalizadosContainer) {
                finalizadosContainer = document.createElement('div');
                finalizadosContainer.id = 'finalizadosContainer';
                finalizadosContainer.className = 'finalizados-container';
                
                // Buscar la secci√≥n de finalizados en el HTML
                const finalizadosSection = document.querySelector('.section-card:nth-of-type(4) .section-content');
                if (finalizadosSection) {
                    finalizadosSection.appendChild(finalizadosContainer);
                }
            }
            
            finalizadosContainer.innerHTML = '';
            
            if (!Array.isArray(list) || list.length === 0) {
                console.log('üì¶ No hay expedientes finalizados para renderizar');
                return;
            }
            
            console.log(`üì¶ Renderizando ${list.length} expedientes finalizados...`);
            list.forEach(d => {
                const item = buildFinalizadoItem(d);
                finalizadosContainer.appendChild(item);
                console.log(`‚úÖ Expediente ${d.codigo} renderizado en finalizados`);
            });
            
            console.log('üéâ Renderizado de finalizados completado');
        }

        async function renderStoredCompras() {
            console.log('üöÄ INICIANDO renderStoredCompras...');
            const list = await getStoredCompras();
            console.log('üìä Datos obtenidos de compras:', list);
            
            // Obtener o crear contenedor
            const compraContainer = ensureCompraContainer();
            
            // Limpiar contenedor antes de renderizar
            compraContainer.innerHTML = '';
            
            if (!Array.isArray(list) || list.length === 0) {
                console.log('üì¶ No hay expedientes en compras para renderizar');
                return;
            }
            
            console.log(`üì¶ Renderizando ${list.length} expedientes en compras (incluyendo finalizados)...`);
            list.forEach(d => {
                const item = buildCompraItemSimple(d);
                compraContainer.appendChild(item);
                console.log(`‚úÖ Expediente ${d.codigo} (${d.estado || 'PENDIENTE'}) renderizado en compras`);
            });
            console.log('üéâ Renderizado de compras completado');
        }

        // Funci√≥n para renderizar expedientes de hospitales
        async function renderStoredHospitales() {
            console.log('üöÄ INICIANDO renderStoredHospitales...');
            const list = await getStoredHospitales();
            console.log('üìä Datos obtenidos de hospitales:', list);
            
            const hospitalesSection = document.getElementById('hospitalesSection');
            const emptyHospitales = document.getElementById('emptyHospitales');
            
            // Limpiar elementos existentes (excepto emptyHospitales)
            const existingItems = hospitalesSection.querySelectorAll('.hospital-item');
            existingItems.forEach(item => item.remove());
            
            if (!Array.isArray(list) || list.length === 0) {
                console.log('üè• No hay expedientes en hospitales para renderizar');
                if (emptyHospitales) emptyHospitales.style.display = 'block';
                return;
            }
            
            if (emptyHospitales) emptyHospitales.style.display = 'none';
            
            console.log(`üè• Renderizando ${list.length} expedientes en hospitales...`);
            list.forEach(d => {
                const item = buildHospitalItemSimple(d);
                hospitalesSection.insertBefore(item, emptyHospitales);
                console.log(`‚úÖ Expediente ${d.codigo} renderizado en hospitales`);
            });
            console.log('üéâ Renderizado de hospitales completado');
        }

        // Funci√≥n para renderizar expedientes de otros
        async function renderStoredOtros() {
            console.log('üöÄ INICIANDO renderStoredOtros...');
            const list = await getStoredOtros();
            console.log('üìä Datos obtenidos de otros:', list);
            
            const otrosSection = document.getElementById('otrosSection');
            const emptyOtros = document.getElementById('emptyOtros');
            
            // Limpiar elementos existentes (excepto emptyOtros)
            const existingItems = otrosSection.querySelectorAll('.otros-item');
            existingItems.forEach(item => item.remove());
            
            if (!Array.isArray(list) || list.length === 0) {
                console.log('üìã No hay expedientes en otros para renderizar');
                if (emptyOtros) emptyOtros.style.display = 'block';
                return;
            }
            
            if (emptyOtros) emptyOtros.style.display = 'none';
            
            console.log(`üìã Renderizando ${list.length} expedientes en otros...`);
            list.forEach(d => {
                const item = buildOtrosItemSimple(d);
                otrosSection.insertBefore(item, emptyOtros);
                console.log(`‚úÖ Expediente ${d.codigo} renderizado en otros`);
            });
            console.log('üéâ Renderizado de otros completado');
        }

        // Funci√≥n para formatear fecha en espa√±ol
        function formatDateEs(date) {
            return date.toLocaleDateString('es-ES');
        }

        // Funci√≥n para calcular d√≠as de tr√°mite
        function calculateDays(startDate, endDate = new Date()) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            const diffTime = Math.abs(end - start);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        }

        // Funci√≥n para actualizar estad√≠sticas
        async function updateStats() {
            try {
                // Obtener datos reales de todas las secciones
                const creados = await getStoredCreated();
                const ejecutivo = await getStoredEjecutivo();
                const compras = await getStoredCompras();
                const hospitales = await getStoredHospitales();
                const otros = await getStoredOtros();
                
                // Contar todos los expedientes
                const totalExpedientes = creados.length + ejecutivo.length + compras.length + hospitales.length + otros.length;
                
                // Contar expedientes finalizados
                const finalizados = [...creados, ...ejecutivo, ...compras, ...hospitales, ...otros].filter(exp => exp.estado === 'FINALIZADO').length;
                
                // Contar expedientes pendientes
                const pendientes = totalExpedientes - finalizados;

                console.log(`üìä Estad√≠sticas actualizadas: Total: ${totalExpedientes}, Finalizados: ${finalizados}, Pendientes: ${pendientes}`);

            const totalEl = document.getElementById('totalExpedientes');
            const finalizadosEl = document.getElementById('finalizados');
            const pendientesEl = document.getElementById('pendientes');
            
            if (totalEl) totalEl.textContent = String(totalExpedientes);
            if (finalizadosEl) finalizadosEl.textContent = String(finalizados);
            if (pendientesEl) pendientesEl.textContent = String(pendientes);
            } catch (error) {
                console.error('‚ùå Error al actualizar estad√≠sticas:', error);
            }
        }

        // Funci√≥n para crear item de expediente
        function createExpedienteItem(data) {
            const item = document.createElement('div');
            item.className = 'expediente-item';
            item.dataset.codigo = data.codigo;
            
            const fechaIngreso = new Date(data.fechaIngreso);
            const diasTramite = data.diasTramite || calculateDays(fechaIngreso);
            
            item.innerHTML = `
                <div class="status-badge status-pendiente">PENDIENTE</div>
                <div class="expediente-header">${data.codigo} - ${data.detalle || 'Sin descripci√≥n'}</div>
                <div class="expediente-details">
                    <strong>üìÖ ${formatDateEs(fechaIngreso)}</strong><br>
                    <strong>C√≥digo:</strong> ${data.codigo}<br>
                    <strong>N√∫mero:</strong> ${data.numero || 'N/A'}/${data.anio || '2025'}<br>
                    <strong>Corresponde:</strong> ${data.corresponde || 'N/A'}<br>
                    <strong>Derivado a:</strong> ${data.derivado || 'N/A'}<br>
                    <strong>D√≠as de tr√°mite:</strong> ${diasTramite} d√≠as
                    ${data.observacion ? '<br><strong>Observaci√≥n:</strong> ' + data.observacion : ''}
                </div>
                <div class="item-actions">
                    <label style="display:flex;align-items:center;gap:0.4rem;color:var(--gray-700);">
                        <input type="checkbox" class="select-checkbox" /> Seleccionar
                    </label>
                    <select class="inline-select" aria-label="Mover a" disabled>
                        <option value="">Enviar a...</option>
                        <option value="ejecutivo">Parque Automotor Ejecutivo</option>
                        <option value="compra">Compras</option>
                    </select>
                    <button class="send-btn" disabled>Enviar</button>
                </div>
            `;
            attachExpedienteItemHandlers(item, data);
            
            return item;
        }

        function attachExpedienteItemHandlers(item, data) {
            // Verificar si el expediente est√° finalizado
            const isFinalizado = item.querySelector('.status-badge')?.textContent === 'FINALIZADO';
            
            // Si est√° finalizado, no agregar handlers
            if (isFinalizado) {
                console.log(`üîí Expediente ${data.codigo} ya est√° finalizado, omitiendo handlers`);
                return;
            }
            
            console.log(`üîß Agregando handlers para expediente ${data.codigo}`);
            
            const checkbox = item.querySelector('.select-checkbox');
            const select = item.querySelector('.inline-select');
            const sendBtn = item.querySelector('.send-btn');
            
            // Si no hay elementos de acci√≥n, no continuar
            if (!checkbox || !select || !sendBtn) {
                return;
            }
            
            // Preselecci√≥n seg√∫n tipo de expediente
            const tipo = (data.tipo || '').toString().toLowerCase();
            if (tipo.includes('ejecutivo')) {
                select.value = 'ejecutivo';
            } else if (tipo.includes('compra')) {
                select.value = 'compra';
            }
            
            checkbox.addEventListener('change', () => {
                const enabled = checkbox.checked;
                select.disabled = !enabled;
                sendBtn.disabled = !enabled;
            });
            
            sendBtn.addEventListener('click', () => {
                let destino = select.value;
                if (!destino) {
                    // Usar mapeo por tipo si no eligi√≥ manualmente
                    if (tipo.includes('ejecutivo')) destino = 'ejecutivo';
                    if (tipo.includes('compra')) destino = 'compra';
                }
                if (!destino) {
                    alert('Seleccione un destino (Ejecutivo o Compras).');
                    return;
                }
                moveBidirectionalExpediente(data, 'creados', destino, item);
                checkbox.checked = false;
                select.value = '';
                select.disabled = true;
                sendBtn.disabled = true;
            });
        }

        function buildExecutiveItemSimple(data) {
            const newItem = document.createElement('div');
            newItem.className = 'executive-item';
            newItem.dataset.codigo = data.codigo;
            const isFinal = data.estado === 'FINALIZADO';
            newItem.innerHTML = `
                <div class="status-badge ${isFinal ? 'status-finalizado' : 'status-pendiente'}">${isFinal ? 'FINALIZADO' : 'PENDIENTE'}</div>
                <div class="expediente-header">${data.codigo} - ${data.detalle || ''}</div>
                <div class="expediente-details">
                    <strong>üìÖ ${formatDateEs(new Date(data.fechaIngreso))}</strong><br>
                    <strong>C√≥digo:</strong> ${data.codigo}<br>
                    <strong>N√∫mero:</strong> ${data.numero || 'N/A'}/${data.anio || '2025'}<br>
                    <strong>Corresponde:</strong> ${data.corresponde || 'N/A'}<br>
                    <strong>Derivado a:</strong> ${data.derivado || 'N/A'}<br>
                    <strong>D√≠as de tr√°mite:</strong> ${data.diasTramite || 0} d√≠as
                    ${data.creadoPorNombre ? '<br><strong>üë§ Creado por:</strong> ' + data.creadoPorNombre : ''}
                </div>
                ${!isFinal ? `
                <div class="item-actions">
                    <label style="display:flex;align-items:center;gap:0.4rem;color:var(--gray-700);">
                        <input type="checkbox" class="select-checkbox" /> Seleccionar
                    </label>
                    <select class="inline-select" aria-label="Mover a" disabled>
                        <option value="">Enviar a...</option>
                        <option value="creados">Expedientes Creados</option>
                        <option value="compra">Compras</option>
                        <option value="hospitales">Hospitales</option>
                        <option value="otros">Otros</option>
                    </select>
                    <button class="send-btn" disabled>Enviar</button>
                    <button class="finalize-btn" onclick="finalizeExpediente('${data.codigo}', this)" title="Finalizar expediente">‚úÖ FINALIZAR</button>
                    <button class="delete-btn" onclick="deleteExecutive(this)" title="Eliminar expediente">üóëÔ∏è</button>
                </div>
                ` : `
                <div class="item-actions" style="opacity: 0.6; pointer-events: none;">
                    <span style="color: var(--success); font-weight: bold;">EXPEDIENTE FINALIZADO</span>
                </div>
                `}
            `;
            attachBidirectionalHandler(newItem, data, 'ejecutivo');
            return newItem;
        }

        // Funci√≥n para crear elemento de finalizado
        function buildFinalizadoItem(data) {
            const el = document.createElement('div');
            el.className = 'finalizado-item';
            el.innerHTML = `
                <div class="status-badge status-finalizado">FINALIZADO</div>
                <div class="expediente-header">${data.codigo} - ${data.corresponde}</div>
                <div class="expediente-details">
                    <div><strong>N√∫mero:</strong> ${data.numero}</div>
                    <div><strong>A√±o:</strong> ${data.anio}</div>
                    <div><strong>Derivado:</strong> ${data.derivado}</div>
                    <div><strong>Detalle:</strong> ${data.detalle}</div>
                    <div><strong>Observaci√≥n:</strong> ${data.observacion}</div>
                    <div><strong>D√≠as de tr√°mite:</strong> ${data.diasTramite || 'N/A'}</div>
                    <div><strong>Fecha finalizaci√≥n:</strong> ${data.fechaFinalizacion ? new Date(data.fechaFinalizacion).toLocaleDateString() : 'N/A'}</div>
                </div>
                <div class="item-actions">
                    <button class="view-btn" onclick="viewFinalizado('${data.codigo}')" title="Ver detalles">üëÅÔ∏è Ver</button>
                </div>
            `;
            return el;
        }

        function buildCompraItemSimple(data) {
            const newItem = document.createElement('div');
            newItem.className = 'executive-item';
            newItem.dataset.codigo = data.codigo;
            const isFinal = data.estado === 'FINALIZADO';
            newItem.innerHTML = `
                <div class="status-badge ${isFinal ? 'status-finalizado' : 'status-pendiente'}">${isFinal ? 'FINALIZADO' : 'PENDIENTE'}</div>
                <div class="expediente-header">${data.codigo} - ${data.detalle || ''}</div>
                <div class="expediente-details">
                    <strong>üìÖ ${formatDateEs(new Date(data.fechaIngreso))}</strong><br>
                    <strong>C√≥digo:</strong> ${data.codigo}<br>
                    <strong>N√∫mero:</strong> ${data.numero || 'N/A'}/${data.anio || '2025'}<br>
                    <strong>Corresponde:</strong> ${data.corresponde || 'N/A'}<br>
                    <strong>Derivado a:</strong> ${data.derivado || 'N/A'}<br>
                    <strong>D√≠as de tr√°mite:</strong> ${data.diasTramite || 0} d√≠as
                    ${data.creadoPorNombre ? '<br><strong>üë§ Creado por:</strong> ' + data.creadoPorNombre : ''}
                </div>
                ${!isFinal ? `
                <div class="item-actions">
                    <label style="display:flex;align-items:center;gap:0.4rem;color:var(--gray-700);">
                        <input type="checkbox" class="select-checkbox" /> Seleccionar
                    </label>
                    <select class="inline-select" aria-label="Mover a" disabled>
                        <option value="">Enviar a...</option>
                        <option value="creados">Expedientes Creados</option>
                        <option value="ejecutivo">Parque Automotor Ejecutivo</option>
                        <option value="compras">Centro de Compras</option>
                        <option value="hospitales">Hospitales</option>
                        <option value="otros">Otros</option>
                    </select>
                    <button class="send-btn" disabled>Enviar</button>
                    <button class="finalize-btn" onclick="finalizeExpediente('${data.codigo}', this)" title="Finalizar expediente">‚úÖ FINALIZAR</button>
                    <button class="delete-btn" onclick="deleteExecutive(this)" title="Eliminar expediente">üóëÔ∏è</button>
                </div>
                ` : `
                <div class="item-actions" style="opacity: 0.6; pointer-events: none;">
                    <span style="color: var(--success); font-weight: bold;">EXPEDIENTE FINALIZADO</span>
                </div>
                `}
            `;
            attachBidirectionalHandler(newItem, data, 'compras');
            return newItem;
        }

        // Funci√≥n para construir items de hospitales
        function buildHospitalItemSimple(data) {
            const newItem = document.createElement('div');
            newItem.className = 'hospital-item';
            newItem.dataset.codigo = data.codigo;
            const isFinal = data.estado === 'FINALIZADO';
            newItem.innerHTML = `
                <div class="status-badge ${isFinal ? 'status-finalizado' : 'status-pendiente'}">${isFinal ? 'FINALIZADO' : 'PENDIENTE'}</div>
                <div class="expediente-header">${data.codigo} - ${data.detalle || ''}</div>
                <div class="expediente-details">
                    <strong>üìÖ ${formatDateEs(new Date(data.fechaIngreso))}</strong><br>
                    <strong>C√≥digo:</strong> ${data.codigo}<br>
                    <strong>N√∫mero:</strong> ${data.numero || 'N/A'}/${data.anio || '2025'}<br>
                    <strong>Corresponde:</strong> ${data.corresponde || 'N/A'}<br>
                    <strong>Derivado a:</strong> ${data.derivado || 'N/A'}<br>
                    <strong>D√≠as de tr√°mite:</strong> ${data.diasTramite || 0} d√≠as
                    ${data.creadoPorNombre ? '<br><strong>üë§ Creado por:</strong> ' + data.creadoPorNombre : ''}
                </div>
                ${!isFinal ? `
                <div class="item-actions">
                    <label style="display:flex;align-items:center;gap:0.4rem;color:var(--gray-700);">
                        <input type="checkbox" class="select-checkbox" /> Seleccionar
                    </label>
                    <select class="inline-select" aria-label="Mover a" disabled>
                        <option value="">Enviar a...</option>
                        <option value="creados">Expedientes Creados</option>
                        <option value="ejecutivo">Parque Automotor Ejecutivo</option>
                        <option value="compras">Centro de Compras</option>
                        <option value="hospitales">Hospitales</option>
                        <option value="otros">Otros</option>
                        <option value="compras">Centro de Compras</option>
                        <option value="otros">Otros</option>
                    </select>
                    <button class="send-btn" disabled>Enviar</button>
                    <button class="finalize-btn" onclick="finalizeExpediente('${data.codigo}', this)" title="Finalizar expediente">‚úÖ FINALIZAR</button>
                    <button class="delete-btn" onclick="deleteExecutive(this)" title="Eliminar expediente">üóëÔ∏è</button>
                </div>
                ` : `
                <div class="item-actions" style="opacity: 0.6; pointer-events: none;">
                    <span style="color: var(--success); font-weight: bold;">EXPEDIENTE FINALIZADO</span>
                </div>
                `}
            `;
            attachBidirectionalHandler(newItem, data, 'hospitales');
            return newItem;
        }

        // Funci√≥n para construir items de otros
        function buildOtrosItemSimple(data) {
            const newItem = document.createElement('div');
            newItem.className = 'otros-item';
            newItem.dataset.codigo = data.codigo;
            const isFinal = data.estado === 'FINALIZADO';
            newItem.innerHTML = `
                <div class="status-badge ${isFinal ? 'status-finalizado' : 'status-pendiente'}">${isFinal ? 'FINALIZADO' : 'PENDIENTE'}</div>
                <div class="expediente-header">${data.codigo} - ${data.detalle || ''}</div>
                <div class="expediente-details">
                    <strong>üìÖ ${formatDateEs(new Date(data.fechaIngreso))}</strong><br>
                    <strong>C√≥digo:</strong> ${data.codigo}<br>
                    <strong>N√∫mero:</strong> ${data.numero || 'N/A'}/${data.anio || '2025'}<br>
                    <strong>Corresponde:</strong> ${data.corresponde || 'N/A'}<br>
                    <strong>Derivado a:</strong> ${data.derivado || 'N/A'}<br>
                    <strong>D√≠as de tr√°mite:</strong> ${data.diasTramite || 0} d√≠as
                    ${data.creadoPorNombre ? '<br><strong>üë§ Creado por:</strong> ' + data.creadoPorNombre : ''}
                </div>
                ${!isFinal ? `
                <div class="item-actions">
                    <label style="display:flex;align-items:center;gap:0.4rem;color:var(--gray-700);">
                        <input type="checkbox" class="select-checkbox" /> Seleccionar
                    </label>
                    <select class="inline-select" aria-label="Mover a" disabled>
                        <option value="">Enviar a...</option>
                        <option value="creados">Expedientes Creados</option>
                        <option value="ejecutivo">Parque Automotor Ejecutivo</option>
                        <option value="compras">Centro de Compras</option>
                        <option value="hospitales">Hospitales</option>
                        <option value="otros">Otros</option>
                        <option value="compras">Centro de Compras</option>
                        <option value="hospitales">Hospitales</option>
                    </select>
                    <button class="send-btn" disabled>Enviar</button>
                    <button class="finalize-btn" onclick="finalizeExpediente('${data.codigo}', this)" title="Finalizar expediente">‚úÖ FINALIZAR</button>
                    <button class="delete-btn" onclick="deleteExecutive(this)" title="Eliminar expediente">üóëÔ∏è</button>
                </div>
                ` : `
                <div class="item-actions" style="opacity: 0.6; pointer-events: none;">
                    <span style="color: var(--success); font-weight: bold;">EXPEDIENTE FINALIZADO</span>
                </div>
                `}
            `;
            attachBidirectionalHandler(newItem, data, 'otros');
            return newItem;
        }

        function moveExpediente(data, destino, itemEl) {
            // Verificar que el expediente no est√© finalizado
            if (itemEl && itemEl.querySelector('.status-badge')?.textContent === 'FINALIZADO') {
                alert('‚ùå No se puede mover un expediente FINALIZADO');
                return;
            }
            
            // Remover de expedientes creados (y storage) si va a otro destino
            const expedientesCreados = document.getElementById('expedientesCreados');
            const emptyExpedientes = document.getElementById('emptyExpedientes');
            if (itemEl && itemEl.parentElement === expedientesCreados) {
                itemEl.remove();
                const stored = getStoredCreated().filter(x => x.codigo !== data.codigo);
                setStoredCreated(stored);
                if (expedientesCreados.querySelectorAll('.expediente-item').length === 0 && emptyExpedientes) {
                    emptyExpedientes.style.display = 'block';
                }
            }

            if (destino === 'ejecutivo') {
                const execSection = document.getElementById('executiveSection');
                const emptyExec = document.getElementById('emptyExecutive');
                if (emptyExec) emptyExec.style.display = 'none';
                execSection.insertBefore(buildExecutiveItemSimple(data), emptyExec);
                const ejList = getStoredEjecutivo();
                ejList.push(data);
                setStoredEjecutivo(ejList);
            } else if (destino === 'compra') {
                // Reusar contenedor de compras: agregar debajo del preview
                let compraContainer = document.getElementById('compraContainer');
                if (!compraContainer) {
                    compraContainer = document.createElement('div');
                    compraContainer.id = 'compraContainer';
                    const compraSection = document.querySelector('.section-card:nth-of-type(3) .section-content');
                    compraSection.appendChild(compraContainer);
                }
                compraContainer.prepend(buildCompraItemSimple(data));
                const cList = getStoredCompras();
                cList.push(data);
                setStoredCompras(cList);
            } else if (destino === 'hospitales') {
                const hospitalesSection = document.getElementById('hospitalesSection');
                const emptyHospitales = document.getElementById('emptyHospitales');
                if (emptyHospitales) emptyHospitales.style.display = 'none';
                hospitalesSection.insertBefore(buildHospitalItemSimple(data), emptyHospitales);
                const hList = getStoredHospitales();
                hList.push(data);
                setStoredHospitales(hList);
            } else if (destino === 'otros') {
                const otrosSection = document.getElementById('otrosSection');
                const emptyOtros = document.getElementById('emptyOtros');
                if (emptyOtros) emptyOtros.style.display = 'none';
                otrosSection.insertBefore(buildOtrosItemSimple(data), emptyOtros);
                const oList = getStoredOtros();
                oList.push(data);
                setStoredOtros(oList);
            }
            // Activar alerta si pasan 2 d√≠as sin finalizar
            scheduleTwoDayAlert();

            updateStats();
        }

        // New bidirectional handler for all sections
        function attachBidirectionalHandler(wrapper, data, currentSection) {
            const checkbox = wrapper.querySelector('.select-checkbox');
            const sendBtn = wrapper.querySelector('.send-btn');
            const select = wrapper.querySelector('.inline-select');
            
            if (!checkbox || !sendBtn || !select) {
                console.log('‚ö†Ô∏è Elementos de control no encontrados, usando handler legacy');
                attachReturnHandler(wrapper, data);
                return;
            }
            
            checkbox.addEventListener('change', () => {
                if (checkbox.checked) {
                    sendBtn.disabled = false;
                    select.disabled = false;
                } else {
                    sendBtn.disabled = true;
                    select.disabled = true;
                }
            });
            
            sendBtn.addEventListener('click', () => {
                const destino = select.value;
                if (!destino) {
                    alert('‚ùå Selecciona un destino para enviar el expediente');
                    return;
                }
                
                console.log(`üì§ Enviando expediente ${data.codigo} desde ${currentSection} hacia ${destino}`);
                moveBidirectionalExpediente(data, currentSection, destino, wrapper);
                
                // Reset form
                checkbox.checked = false;
                select.value = '';
                sendBtn.disabled = true;
                select.disabled = true;
            });
        }

        // Enhanced bidirectional movement function
        async function moveBidirectionalExpediente(data, fromSection, toSection, itemEl) {
            console.log(`üîÑ Moviendo expediente ${data.codigo}: ${fromSection} ‚Üí ${toSection}`);
            
            // Verificar que el expediente no est√© finalizado
            if (itemEl && itemEl.querySelector('.status-badge')?.textContent === 'FINALIZADO') {
                alert('‚ùå No se puede mover un expediente FINALIZADO');
                return;
            }
            
            // Remove from current section
            await removeFromSection(data.codigo, fromSection, itemEl);
            
            // Add to destination section  
            await addToSection(data, toSection);
            
            // Update statistics and alerts
            updateStats();
            scheduleTwoDayAlert();
            
            alert(`‚úÖ Expediente ${data.codigo} movido exitosamente de ${getSectionDisplayName(fromSection)} a ${getSectionDisplayName(toSection)}`);
        }
        
        async function removeFromSection(codigo, section, itemEl) {
            console.log(`üóëÔ∏è Removiendo expediente ${codigo} de ${section}`);
            
            // Remove from DOM
            if (itemEl) {
                itemEl.remove();
            }
            
            // Remove from storage
            switch(section) {
                case 'creados':
                    const storedCreados = await getStoredCreated();
                    const filteredCreados = storedCreados.filter(x => x.codigo !== codigo);
                    setStoredCreated(filteredCreados);
                    // Show empty state if needed
                    const expedientesCreados = document.getElementById('expedientesCreados');
                    const emptyExpedientes = document.getElementById('emptyExpedientes');
                    if (expedientesCreados && expedientesCreados.querySelectorAll('.expediente-item').length === 0 && emptyExpedientes) {
                        emptyExpedientes.style.display = 'block';
                    }
                    break;
                case 'ejecutivo':
                    const storedEjecutivo = await getStoredEjecutivo();
                    const filteredEjecutivo = storedEjecutivo.filter(x => x.codigo !== codigo);
                    setStoredEjecutivo(filteredEjecutivo);
                    // Show empty state if needed
                    const execSection = document.getElementById('executiveSection');
                    const emptyExec = document.getElementById('emptyExecutive');
                    if (execSection && execSection.querySelectorAll('.executive-item').length === 0 && emptyExec) {
                        emptyExec.style.display = 'block';
                    }
                    break;
                case 'compra':
                    const storedCompras = await getStoredCompras();
                    const filteredCompras = storedCompras.filter(x => x.codigo !== codigo);
                    setStoredCompras(filteredCompras);
                    // Clean up empty container
                    const compraContainer = document.getElementById('compraContainer');
                    if (compraContainer && compraContainer.children.length === 0) {
                        compraContainer.remove();
                    }
                    break;
                case 'hospitales':
                    const storedHospitales = await getStoredHospitales();
                    const filteredHospitales = storedHospitales.filter(x => x.codigo !== codigo);
                    setStoredHospitales(filteredHospitales);
                    // Show empty state if needed
                    const hospitalesSection = document.getElementById('hospitalesSection');
                    const emptyHospitales = document.getElementById('emptyHospitales');
                    if (hospitalesSection && hospitalesSection.querySelectorAll('.hospital-item').length === 0 && emptyHospitales) {
                        emptyHospitales.style.display = 'block';
                    }
                    break;
                case 'otros':
                    const storedOtros = await getStoredOtros();
                    const filteredOtros = storedOtros.filter(x => x.codigo !== codigo);
                    setStoredOtros(filteredOtros);
                    // Show empty state if needed
                    const otrosSection = document.getElementById('otrosSection');
                    const emptyOtros = document.getElementById('emptyOtros');
                    if (otrosSection && otrosSection.querySelectorAll('.otros-item').length === 0 && emptyOtros) {
                        emptyOtros.style.display = 'block';
                    }
                    break;
            }
        }
        
        async function addToSection(data, section) {
            console.log(`‚ûï Agregando expediente ${data.codigo} a ${section}`);
            console.log('üîç DEBUG addToSection - data:', data);
            console.log('üîç DEBUG addToSection - section:', section);
            
            switch(section) {
                case 'creados':
                    // Add to expedientes creados
                    const expedientesCreados = document.getElementById('expedientesCreados');
                    const emptyExpedientes = document.getElementById('emptyExpedientes');
                    if (emptyExpedientes) emptyExpedientes.style.display = 'none';
                    
                    // Check if expediente already exists to avoid duplication
                    const existingCreateds = await getStoredCreated();
                    const alreadyExists = existingCreateds.some(exp => exp.codigo === data.codigo);
                    
                    if (!alreadyExists) {
                        existingCreateds.push(data);
                        setStoredCreated(existingCreateds);
                        renderAllInCreated(); // Refresh the entire section
                    } else {
                        console.log(`‚ö†Ô∏è Expediente ${data.codigo} ya existe en creados, evitando duplicaci√≥n`);
                    }
                    break;
                    
                case 'ejecutivo':
                    // Check if expediente already exists to avoid duplication
                    const existingEjecutivo = await getStoredEjecutivo();
                    const alreadyExistsEjecutivo = existingEjecutivo.some(exp => exp.codigo === data.codigo);
                    
                    if (!alreadyExistsEjecutivo) {
                        existingEjecutivo.push(data);
                        setStoredEjecutivo(existingEjecutivo);
                        
                        // Renderizar desde Firebase
                        renderStoredEjecutivo();
                    } else {
                        console.log(`‚ö†Ô∏è Expediente ${data.codigo} ya existe en ejecutivo, evitando duplicaci√≥n`);
                    }
                    break;
                    
                case 'compra':
                    console.log('üõí Procesando expediente para compras...');
                    const existingCompras = await getStoredCompras();
                    const alreadyExistsCompras = existingCompras.some(exp => exp.codigo === data.codigo);
                    
                    if (!alreadyExistsCompras) {
                        console.log('‚ûï Agregando expediente a compras...');
                        existingCompras.push(data);
                        setStoredCompras(existingCompras);
                        renderStoredCompras();
                        console.log(`‚úÖ Expediente ${data.codigo} agregado exitosamente a compras`);
                    } else {
                        console.log(`‚ö†Ô∏è Expediente ${data.codigo} ya existe en compras, evitando duplicaci√≥n`);
                    }
                    break;
                    
                case 'hospitales':
                    console.log('üè• Procesando expediente para hospitales...');
                    const existingHospitales = await getStoredHospitales();
                    const alreadyExistsHospitales = existingHospitales.some(exp => exp.codigo === data.codigo);
                    
                    if (!alreadyExistsHospitales) {
                        console.log('‚ûï Agregando expediente a hospitales...');
                        existingHospitales.push(data);
                        setStoredHospitales(existingHospitales);
                        renderStoredHospitales();
                        console.log(`‚úÖ Expediente ${data.codigo} agregado exitosamente a hospitales`);
                    } else {
                        console.log(`‚ö†Ô∏è Expediente ${data.codigo} ya existe en hospitales, evitando duplicaci√≥n`);
                    }
                    break;
                    
                case 'otros':
                    console.log('üìã Procesando expediente para otros...');
                    const existingOtros = await getStoredOtros();
                    const alreadyExistsOtros = existingOtros.some(exp => exp.codigo === data.codigo);
                    
                    if (!alreadyExistsOtros) {
                        console.log('‚ûï Agregando expediente a otros...');
                        existingOtros.push(data);
                        setStoredOtros(existingOtros);
                        renderStoredOtros();
                        console.log(`‚úÖ Expediente ${data.codigo} agregado exitosamente a otros`);
                    } else {
                        console.log(`‚ö†Ô∏è Expediente ${data.codigo} ya existe en otros, evitando duplicaci√≥n`);
                    }
                    break;
            }
        }
        
        function getSectionDisplayName(section) {
            const names = {
                'creados': 'Expedientes Creados',
                'ejecutivo': 'Parque Automotor Ejecutivo', 
                'compras': 'Compras',
                'hospitales': 'Hospitales',
                'otros': 'Otros'
            };
            return names[section] || section;
        }

        function attachReturnHandler(wrapper, data) {
            // Casilla para volver a "Expedientes Creados" como FINALIZADO
            const checkbox = wrapper.querySelector('.select-checkbox');
            const sendBackBtn = wrapper.querySelector('.send-back-btn');
            if (checkbox && sendBackBtn) {
                checkbox.addEventListener('change', () => {
                    sendBackBtn.disabled = !checkbox.checked;
                });
                sendBackBtn.addEventListener('click', () => {
                    if (!checkbox.checked) return;
                    const created = document.getElementById('expedientesCreados');
                    const empty = document.getElementById('emptyExpedientes');
                    if (empty) empty.style.display = 'none';
                    const back = buildFinalizadoItem(data);
                    created.insertBefore(back, empty);
                    setStoredFinalizados([...getStoredFinalizados(), data]);
                    const inExec = wrapper.closest('#executiveSection');
                    if (inExec) setStoredEjecutivo(getStoredEjecutivo().filter(x => x.codigo !== data.codigo));
                    const compraCont = document.getElementById('compraContainer');
                    if (compraCont && compraCont.contains(wrapper)) {
                        setStoredCompras(getStoredCompras().filter(x => x.codigo !== data.codigo));
                    }
                    wrapper.remove();
                    updateStats();
                });
            }
            const badge = wrapper.querySelector('.status-badge');
            if (badge) badge.title = 'Pendiente: se volver√° rojo si pasan 2 d√≠as sin finalizar';
        }

        function scheduleTwoDayAlert() {
            // Recorre todos los pendientes (creados, ejecutivo, compra) y marca alerta si >2 d√≠as
            const now = new Date();
            document.querySelectorAll('.status-badge.status-pendiente').forEach(badge => {
                const wrapper = badge.closest('.expediente-item, .executive-item');
                if (!wrapper) return;
                const dateText = (wrapper.querySelector('.expediente-details strong')?.textContent || '').replace('üìÖ', '').trim();
                // intentar parsear DD/MM/YYYY o similar
                let parts = dateText.split('/').map(x => x.trim());
                let parsed = null;
                if (parts.length === 3) {
                    const [dd, mm, yyyy] = parts;
                    parsed = new Date(parseInt(yyyy,10), parseInt(mm,10)-1, parseInt(dd,10));
                } else {
                    parsed = new Date(dateText);
                }
                if (parsed instanceof Date && !isNaN(parsed.getTime())) {
                    const diffDays = Math.ceil(Math.abs(now - parsed) / (1000*60*60*24));
                    if (diffDays > 2) {
                        badge.classList.add('status-alert');
                        badge.textContent = 'ALERTA (PENDIENTE)';
                    }
                }
            });
        }

        // FILTRO GLOBAL (APLICA A LAS TRES SECCIONES)
        function applyGlobalFilter(mode) {
            // mode: 'TODOS' | 'PENDIENTE' | 'CONFIRMADOS'
            const showAll = mode === 'TODOS';
            const showPend = mode === 'PENDIENTE';
            const showConf = mode === 'CONFIRMADOS';
            const allCards = document.querySelectorAll('#expedientesCreados .expediente-item, #executiveSection .executive-item, #compraContainer .executive-item');
            allCards.forEach(card => {
                const isPend = !!card.querySelector('.status-badge.status-pendiente');
                const isFin = !!card.querySelector('.status-badge.status-finalizado');
                let visible = true;
                if (!showAll) {
                    if (showPend) visible = isPend;
                    if (showConf) visible = isFin;
                }
                card.style.display = visible ? '' : 'none';
            });
            // Botones activos
            document.querySelectorAll('.filter-btn').forEach(b => {
                b.classList.toggle('active', b.dataset.filter === mode);
            });
        }

        // Funci√≥n para obtener el usuario actual
        function getCurrentUser() {
            try {
                const authUser = localStorage.getItem('authUser');
                if (authUser) {
                    return JSON.parse(authUser);
                }
                return null;
            } catch (error) {
                console.error('‚ùå Error obteniendo usuario actual:', error);
                return null;
            }
        }

        // Funci√≥n para verificar si el usuario actual es ADMIN
        function isCurrentUserAdmin() {
            const currentUser = getCurrentUser();
            return currentUser && currentUser.role === 'ADMIN';
        }

        // Funci√≥n para verificar si el usuario actual puede modificar/eliminar un expediente
        function canUserModifyExpediente(expediente) {
            const currentUser = getCurrentUser();
            
            if (!currentUser) {
                console.log('‚ùå No hay usuario logueado');
                return false;
            }
            
            // Si es ADMIN, puede modificar cualquier expediente
            if (isCurrentUserAdmin()) {
                console.log('‚úÖ Usuario ADMIN - puede modificar cualquier expediente');
                return true;
            }
            
            // Verificaci√≥n adicional: Si el expediente fue creado por un ADMIN y el usuario actual no es ADMIN, no puede modificarlo
            if (expediente.creadoPorRol === 'ADMIN' && currentUser.role !== 'ADMIN') {
                console.log('üîí Expediente creado por ADMIN - solo ADMIN puede modificarlo');
                return false;
            }
            
            // Si no es ADMIN, solo puede modificar expedientes que √©l cre√≥
            // Verificar m√∫ltiples campos para mayor seguridad
            const canModify = expediente.creadoPor === currentUser.username || 
                             expediente.creadoPor === currentUser.dni ||
                             expediente.creadoPor === `${currentUser.nombre} ${currentUser.apellido}` ||
                             expediente.creadoPor === currentUser.nombre ||
                             expediente.creadoPor === currentUser.apellido ||
                             expediente.creadoPor === getCurrentUserIdentifier();
            
            console.log(`üîç Verificando permisos para expediente ${expediente.codigo}:`, {
                expediente: {
                    codigo: expediente.codigo,
                    creadoPor: expediente.creadoPor,
                    creadoPorNombre: expediente.creadoPorNombre,
                    creadoPorRol: expediente.creadoPorRol
                },
                usuarioActual: {
                    username: currentUser.username,
                    dni: currentUser.dni,
                    nombre: currentUser.nombre,
                    apellido: currentUser.apellido,
                    nombreCompleto: `${currentUser.nombre} ${currentUser.apellido}`,
                    rol: currentUser.role,
                    identificador: getCurrentUserIdentifier()
                },
                comparaciones: {
                    username: expediente.creadoPor === currentUser.username,
                    dni: expediente.creadoPor === currentUser.dni,
                    nombreCompleto: expediente.creadoPor === `${currentUser.nombre} ${currentUser.apellido}`,
                    nombre: expediente.creadoPor === currentUser.nombre,
                    apellido: expediente.creadoPor === currentUser.apellido,
                    identificador: expediente.creadoPor === getCurrentUserIdentifier()
                },
                puedeModificar: canModify
            });
            
            return canModify;
        }

        // Funci√≥n para obtener el identificador del usuario actual
        function getCurrentUserIdentifier() {
            const currentUser = getCurrentUser();
            if (!currentUser) return 'Sistema';
            
            // Usar username como identificador principal
            return currentUser.username || currentUser.dni || `${currentUser.nombre} ${currentUser.apellido}`;
        }

        // Funci√≥n para migrar expedientes existentes que no tengan creadoPorRol
        async function migrarExpedientesExistentes() {
            try {
                console.log('üîÑ Migrando expedientes existentes para incluir informaci√≥n del creador...');
                
                const secciones = ['creados', 'ejecutivo', 'compras', 'hospitales', 'otros', 'finalizados'];
                let totalMigrados = 0;
                
                for (const seccion of secciones) {
                    const getFunction = window[`getStored${seccion.charAt(0).toUpperCase() + seccion.slice(1)}`];
                    const setFunction = window[`setStored${seccion.charAt(0).toUpperCase() + seccion.slice(1)}`];
                    
                    if (getFunction && setFunction) {
                        const expedientes = await getFunction();
                        let migrados = 0;
                        
                        expedientes.forEach(expediente => {
                            let necesitaActualizacion = false;
                            
                            // Si no tiene rol, asumir que fue creado por un usuario normal
                            if (!expediente.creadoPorRol) {
                                expediente.creadoPorRol = 'MESA_DE_ENTRADA';
                                necesitaActualizacion = true;
                            }
                            
                            // Si no tiene nombre del creador, intentar obtenerlo del identificador
                            if (!expediente.creadoPorNombre) {
                                if (expediente.creadoPor) {
                                    // Si tiene creadoPor pero no creadoPorNombre, usar el identificador como nombre
                                    expediente.creadoPorNombre = expediente.creadoPor;
                                } else {
                                    // Si no tiene nada, usar "Usuario del Sistema"
                                    expediente.creadoPor = 'Sistema';
                                    expediente.creadoPorNombre = 'Usuario del Sistema';
                                }
                                necesitaActualizacion = true;
                            }
                            
                            if (necesitaActualizacion) {
                                migrados++;
                                console.log(`üîß Migrando expediente ${expediente.codigo}: creadoPorNombre = "${expediente.creadoPorNombre}"`);
                            }
                        });
                        
                        if (migrados > 0) {
                            await setFunction(expedientes);
                            console.log(`‚úÖ ${seccion}: ${migrados} expedientes migrados`);
                            totalMigrados += migrados;
                        }
                    }
                }
                
                if (totalMigrados > 0) {
                    console.log(`üéâ Migraci√≥n completada: ${totalMigrados} expedientes actualizados`);
                } else {
                    console.log('‚úÖ Todos los expedientes ya tienen informaci√≥n del creador');
                }
                
            } catch (error) {
                console.error('‚ùå Error en migraci√≥n de expedientes:', error);
            }
        }

        // Funci√≥n para corregir estados inconsistentes de expedientes
        async function corregirEstadosExpedientes() {
            try {
                console.log('üîß Corrigiendo estados inconsistentes de expedientes...');
                
                const secciones = ['creados', 'ejecutivo', 'compras', 'hospitales', 'otros', 'finalizados'];
                let totalCorregidos = 0;
                
                for (const seccion of secciones) {
                    const getFunction = window[`getStored${seccion.charAt(0).toUpperCase() + seccion.slice(1)}`];
                    const setFunction = window[`setStored${seccion.charAt(0).toUpperCase() + seccion.slice(1)}`];
                    
                    if (getFunction && setFunction) {
                        const expedientes = await getFunction();
                        let corregidos = 0;
                        
                        expedientes.forEach(expediente => {
                            // Si el expediente tiene fechaFinalizacion pero no tiene estado FINALIZADO
                            if (expediente.fechaFinalizacion && expediente.estado !== 'FINALIZADO') {
                                console.log(`üîß Corrigiendo estado de ${expediente.codigo}: ${expediente.estado} ‚Üí FINALIZADO`);
                                expediente.estado = 'FINALIZADO';
                                corregidos++;
                            }
                            // Si el expediente no tiene estado definido, establecer como PENDIENTE
                            else if (!expediente.estado) {
                                console.log(`üîß Estableciendo estado de ${expediente.codigo}: undefined ‚Üí PENDIENTE`);
                                expediente.estado = 'PENDIENTE';
                                corregidos++;
                            }
                        });
                        
                        if (corregidos > 0) {
                            await setFunction(expedientes);
                            console.log(`‚úÖ ${seccion}: ${corregidos} expedientes corregidos`);
                            totalCorregidos += corregidos;
                        }
                    }
                }
                
                if (totalCorregidos > 0) {
                    console.log(`üéâ Correcci√≥n completada: ${totalCorregidos} expedientes corregidos`);
                    // Re-renderizar todas las secciones despu√©s de la correcci√≥n
                    await renderAllInCreated();
                    await renderStoredEjecutivo();
                    await renderStoredCompras();
                    await renderStoredHospitales();
                    await renderStoredOtros();
                    updateStats();
                } else {
                    console.log('‚úÖ Todos los expedientes ya tienen estados consistentes');
                }
                
            } catch (error) {
                console.error('‚ùå Error corrigiendo estados de expedientes:', error);
            }
        }

        // Funci√≥n global para corregir manualmente desde la consola
        window.corregirEstados = corregirEstadosExpedientes;
        window.migrarExpedientes = migrarExpedientesExistentes;

        // Funciones para la p√°gina de configuraci√≥n
        function showConfig() {
            // Si viene de navegaci√≥n por URL, no cambiar la URL de nuevo
            if (window.location.pathname !== '/config') {
                navigateTo('/config');
            } else {
                document.getElementById('configPage').style.display = 'block';
                loadUserInfo();
            }
        }

        function hideConfig() {
            navigateTo('/dashboard');
        }

        function loadUserInfo() {
            const currentUser = getCurrentUser();
            if (currentUser) {
                document.getElementById('userDNI').textContent = currentUser.dni || '-';
                document.getElementById('userNombre').textContent = currentUser.nombre || '-';
                document.getElementById('userApellido').textContent = currentUser.apellido || '-';
                document.getElementById('userRol').textContent = currentUser.role || '-';
            }
        }

        function loadRolesInfo() {
            loadUsersList();
            loadUserStats();
            loadUserSelect();
        }

        function loadUsersList() {
            try {
                const users = JSON.parse(localStorage.getItem('users') || '[]');
                const usersList = document.getElementById('usersList');
                
                if (users.length === 0) {
                    usersList.innerHTML = '<p style="color: var(--gray-500); text-align: center; padding: 1rem;">No hay usuarios registrados</p>';
                    return;
                }
                
                usersList.innerHTML = users.map(user => `
                    <div class="user-item">
                        <div class="user-info">
                            <div class="user-name">${user.nombre} ${user.apellido}</div>
                            <div class="user-details">
                                DNI: ${user.dni} | Username: ${user.username}
                            </div>
                        </div>
                        <span class="role-badge ${user.role?.toLowerCase() || 'personal'}">
                            ${getRoleDisplayName(user.role)}
                        </span>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error cargando lista de usuarios:', error);
                document.getElementById('usersList').innerHTML = '<p style="color: var(--danger); text-align: center; padding: 1rem;">Error al cargar usuarios</p>';
            }
        }

        function loadUserStats() {
            try {
                const users = JSON.parse(localStorage.getItem('users') || '[]');
                const userStats = document.getElementById('userStats');
                
                const stats = {
                    total: users.length,
                    admin: users.filter(u => u.role === 'ADMIN').length,
                    mesa: users.filter(u => u.role === 'MESA_DE_ENTRADA').length,
                    personal: users.filter(u => u.role === 'PERSONAL').length,
                    activos: users.filter(u => !u.blocked).length,
                    bloqueados: users.filter(u => u.blocked).length
                };
                
                userStats.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-number">${stats.total}</div>
                        <div class="stat-label">Total Usuarios</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.admin}</div>
                        <div class="stat-label">Administradores</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.mesa}</div>
                        <div class="stat-label">Mesa de Entrada</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.personal}</div>
                        <div class="stat-label">Personal</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.activos}</div>
                        <div class="stat-label">Usuarios Activos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.bloqueados}</div>
                        <div class="stat-label">Usuarios Bloqueados</div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error cargando estad√≠sticas de usuarios:', error);
                document.getElementById('userStats').innerHTML = '<p style="color: var(--danger); text-align: center; padding: 1rem;">Error al cargar estad√≠sticas</p>';
            }
        }

        function getRoleDisplayName(role) {
            const roleNames = {
                'ADMIN': 'Administrador',
                'MESA_DE_ENTRADA': 'Mesa de Entrada',
                'PERSONAL': 'Personal'
            };
            return roleNames[role] || 'Sin Rol';
        }

        function loadUserSelect() {
            try {
                const users = JSON.parse(localStorage.getItem('users') || '[]');
                const userSelect = document.getElementById('userSelect');
                
                userSelect.innerHTML = '<option value="">Seleccionar usuario...</option>';
                
                users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.username;
                    option.textContent = `${user.nombre} ${user.apellido} (${user.username}) - ${getRoleDisplayName(user.role)}`;
                    userSelect.appendChild(option);
                });
                
            } catch (error) {
                console.error('Error cargando select de usuarios:', error);
            }
        }

        function cambiarRolUsuario() {
            const userSelect = document.getElementById('userSelect');
            const roleSelect = document.getElementById('roleSelect');
            
            if (!userSelect.value || !roleSelect.value) {
                alert('‚ùå Por favor selecciona un usuario y un rol');
                return;
            }
            
            const username = userSelect.value;
            const nuevoRol = roleSelect.value;
            
            if (confirm(`¬øEst√°s seguro de cambiar el rol del usuario "${username}" a "${getRoleDisplayName(nuevoRol)}"?`)) {
                try {
                    const users = JSON.parse(localStorage.getItem('users') || '[]');
                    const userIndex = users.findIndex(u => u.username === username);
                    
                    if (userIndex === -1) {
                        alert('‚ùå Usuario no encontrado');
                        return;
                    }
                    
                    const usuarioAnterior = users[userIndex];
                    users[userIndex].role = nuevoRol;
                    
                    // Guardar cambios
                    localStorage.setItem('users', JSON.stringify(users));
                    
                    // Actualizar usuario actual si es el mismo
                    const currentUser = getCurrentUser();
                    if (currentUser && currentUser.username === username) {
                        currentUser.role = nuevoRol;
                        localStorage.setItem('authUser', JSON.stringify(currentUser));
                    }
                    
                    // Recargar informaci√≥n
                    loadUsersList();
                    loadUserStats();
                    loadUserSelect();
                    
                    alert(`‚úÖ Rol cambiado exitosamente\n\nUsuario: ${usuarioAnterior.nombre} ${usuarioAnterior.apellido}\nRol anterior: ${getRoleDisplayName(usuarioAnterior.role)}\nNuevo rol: ${getRoleDisplayName(nuevoRol)}`);
                    
                } catch (error) {
                    console.error('Error cambiando rol:', error);
                    alert('‚ùå Error al cambiar el rol del usuario');
                }
            }
        }

        // Manejo de pesta√±as de configuraci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            const tabButtons = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');

            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const targetTab = this.dataset.tab;
                    
                    // Remover clase active de todos los botones y contenidos
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    // Agregar clase active al bot√≥n clickeado y su contenido
                    this.classList.add('active');
                    document.getElementById(targetTab + 'Tab').classList.add('active');
                    
                    // Cargar datos espec√≠ficos seg√∫n la pesta√±a
                    if (targetTab === 'roles') {
                        loadRolesInfo();
                    }
                });
            });

            // Manejo del formulario de cambio de contrase√±a
            const passwordForm = document.getElementById('passwordForm');
            if (passwordForm) {
                passwordForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const currentPassword = document.getElementById('currentPassword').value;
                    const newPassword = document.getElementById('newPassword').value;
                    const confirmPassword = document.getElementById('confirmPassword').value;
                    
                    if (newPassword !== confirmPassword) {
                        alert('‚ùå Las contrase√±as nuevas no coinciden');
                        return;
                    }
                    
                    if (newPassword.length < 6) {
                        alert('‚ùå La nueva contrase√±a debe tener al menos 6 caracteres');
                        return;
                    }
                    
                    // Aqu√≠ puedes agregar la l√≥gica para cambiar la contrase√±a
                    alert('‚úÖ Contrase√±a cambiada exitosamente');
                    
                    // Limpiar formulario
                    passwordForm.reset();
                });
            }
        });

        // Funci√≥n para verificar si un n√∫mero de expediente ya existe
        async function verificarNumeroExpedienteExistente(numero) {
            try {
                console.log('üîç Verificando si el n√∫mero de expediente ya existe:', numero);
                
                // Obtener todos los expedientes de todas las secciones
                const todosExpedientes = [
                    ...(await getStoredCreated()),
                    ...(await getStoredEjecutivo()),
                    ...(await getStoredCompras()),
                    ...(await getStoredHospitales()),
                    ...(await getStoredOtros()),
                    ...(await getStoredFinalizados())
                ];
                
                // Buscar si el n√∫mero ya existe
                const numeroExistente = todosExpedientes.find(exp => 
                    exp.numero && exp.numero.toString().trim() === numero.toString().trim()
                );
                
                if (numeroExistente) {
                    console.log('‚ùå N√∫mero de expediente ya existe:', numeroExistente);
                    return {
                        existe: true,
                        expediente: numeroExistente
                    };
                }
                
                console.log('‚úÖ N√∫mero de expediente disponible');
                return { existe: false };
                
            } catch (error) {
                console.error('‚ùå Error verificando n√∫mero de expediente:', error);
                return { existe: false, error: error.message };
            }
        }

        // Funci√≥n para validar que el n√∫mero sea solo d√≠gitos
        function validarNumeroSoloDigitos(numero) {
            // Verificar que sea solo n√∫meros (sin l√≠mite de d√≠gitos)
            const soloNumeros = /^\d+$/.test(numero.toString().trim());
            return soloNumeros;
        }

        // Funci√≥n para sugerir el siguiente n√∫mero disponible
        async function sugerirSiguienteNumero() {
            try {
                console.log('üí° Sugiriendo siguiente n√∫mero disponible...');
                
                // Obtener todos los expedientes de todas las secciones
                const todosExpedientes = [
                    ...(await getStoredCreated()),
                    ...(await getStoredEjecutivo()),
                    ...(await getStoredCompras()),
                    ...(await getStoredHospitales()),
                    ...(await getStoredOtros()),
                    ...(await getStoredFinalizados())
                ];
                
                // Obtener todos los n√∫meros existentes
                const numerosExistentes = todosExpedientes
                    .filter(exp => exp.numero && exp.numero.toString().trim())
                    .map(exp => parseInt(exp.numero.toString().trim()))
                    .filter(num => !isNaN(num))
                    .sort((a, b) => a - b);
                
                console.log('üìä N√∫meros existentes:', numerosExistentes);
                
                // Encontrar el siguiente n√∫mero disponible
                let siguienteNumero = 1;
                for (const numero of numerosExistentes) {
                    if (numero === siguienteNumero) {
                        siguienteNumero++;
                    } else {
                        break;
                    }
                }
                
                console.log('‚úÖ Siguiente n√∫mero sugerido:', siguienteNumero);
                return siguienteNumero;
                
            } catch (error) {
                console.error('‚ùå Error sugiriendo siguiente n√∫mero:', error);
                return 1; // Valor por defecto
            }
        }

        // Funci√≥n para sugerir y establecer el n√∫mero autom√°ticamente
        async function sugerirYEstablecerNumero() {
            try {
                console.log('üí° Sugiriendo y estableciendo n√∫mero...');
                
                const siguienteNumero = await sugerirSiguienteNumero();
                const numeroInput = document.getElementById('numeroInput');
                
                if (numeroInput) {
                    numeroInput.value = siguienteNumero;
                    numeroInput.focus();
                    console.log(`‚úÖ N√∫mero sugerido establecido: ${siguienteNumero}`);
                    
                    // Mostrar mensaje de confirmaci√≥n
                    alert(`üí° N√∫mero sugerido: ${siguienteNumero}\n\nEste es el siguiente n√∫mero disponible. Puedes cambiarlo si lo deseas.`);
                } else {
                    console.error('‚ùå No se encontr√≥ el campo de n√∫mero');
                    alert('‚ùå Error: No se pudo encontrar el campo de n√∫mero');
                }
                
            } catch (error) {
                console.error('‚ùå Error sugiriendo n√∫mero:', error);
                alert('‚ùå Error al sugerir n√∫mero. Por favor, ingrese un n√∫mero manualmente.');
            }
        }

        // Funci√≥n para abrir el formulario
        function openNewExpedienteForm() {
            console.log('üöÄ Abriendo formulario de nuevo expediente...');
            
            // Si viene de navegaci√≥n por URL, no cambiar la URL de nuevo
            if (window.location.pathname !== '/nuevo-expediente') {
                navigateTo('/nuevo-expediente');
                return;
            }
            
            const mainPage = document.getElementById('mainPage');
            const formPage = document.getElementById('formPage');
            
            if (!formPage) {
                console.error('‚ùå No se encontr√≥ el elemento formPage');
                return;
            }
            
            console.log('üìã FormPage encontrado:', formPage);
            
            // Establecer fecha actual por defecto
            const today = new Date().toISOString().split('T')[0];
            const fechaIngresoInput = document.querySelector('input[name="fechaIngreso"]');
            if (fechaIngresoInput) {
                fechaIngresoInput.value = today;
                console.log('üìÖ Fecha establecida:', today);
            }
            
            // Agregar validaci√≥n en tiempo real al campo de n√∫mero
            const numeroInput = document.querySelector('input[name="numero"]');
            if (numeroInput) {
                // Remover listeners anteriores para evitar duplicados
                const newNumeroInput = numeroInput.cloneNode(true);
                numeroInput.parentNode.replaceChild(newNumeroInput, numeroInput);
                
                newNumeroInput.addEventListener('blur', async function() {
                    const numero = this.value.trim();
                    if (numero) {
                        // Validar que sea solo n√∫meros
                        if (!validarNumeroSoloDigitos(numero)) {
                            alert('‚ùå El n√∫mero de expediente debe contener solo n√∫meros (sin letras, espacios o s√≠mbolos)');
                            this.focus();
                            return;
                        }
                        
                        // Verificar si ya existe
                        const verificacion = await verificarNumeroExpedienteExistente(numero);
                        if (verificacion.existe) {
                            alert(`‚ùå El n√∫mero de expediente "${numero}" ya existe en el expediente: ${verificacion.expediente.codigo}`);
                            this.focus();
                            this.select();
                        }
                    }
                });
            }
            
            // Mostrar formulario
            formPage.classList.add('active');
            document.body.style.overflow = 'hidden';
            console.log('‚úÖ Formulario mostrado');
            
            // Verificar que el bot√≥n de confirmar est√© presente
            const confirmButton = formPage.querySelector('button[type="submit"]');
            if (confirmButton) {
                console.log('‚úÖ Bot√≥n de confirmar encontrado:', confirmButton.textContent);
            } else {
                console.error('‚ùå No se encontr√≥ el bot√≥n de confirmar');
            }
            
            // Enfocar en el primer campo
            setTimeout(() => {
                const firstInput = formPage.querySelector('input[name="codigo"]');
                if (firstInput) {
                    firstInput.focus();
                    console.log('üéØ Enfoque establecido en primer campo');
                } else {
                    console.error('‚ùå No se encontr√≥ el primer campo de entrada');
                }
            }, 100);
        }

        // Funci√≥n para cerrar el formulario
        function closeForm() {
            const formPage = document.getElementById('formPage');
            formPage.classList.remove('active');
            document.body.style.overflow = '';
            
            // Limpiar formulario
            const form = document.getElementById('expedienteForm');
            if (form) form.reset();
            
            // Volver al dashboard
            if (window.location.pathname === '/nuevo-expediente') {
                navigateTo('/dashboard');
            }
        }

        // Funci√≥n para eliminar expediente ejecutivo
        function deleteExecutive(button) {
            if (confirm('¬øEst√° seguro de que desea eliminar este expediente?')) {
                const item = button.closest('.executive-item');
                if (item) item.remove();
                if (item && item.dataset && item.dataset.default === 'true') {
                    localStorage.setItem('hideDefaultExecutive', '1');
                }
                
                const executiveSection = document.getElementById('executiveSection');
                const items = executiveSection.querySelectorAll('.executive-item');
                const emptyState = document.getElementById('emptyExecutive');
                if (items.length === 0 && emptyState) {
                    emptyState.style.display = 'block';
                }
                // Actualizar storage seg√∫n la secci√≥n de la que proviene
                const codigo = item?.dataset?.codigo;
                if (codigo) {
                    if (executiveSection.contains(item)) {
                        setStoredEjecutivo(getStoredEjecutivo().filter(x => x.codigo !== codigo));
                    } else {
                        const compraContainer = document.getElementById('compraContainer');
                        if (compraContainer && compraContainer.contains(item)) {
                            setStoredCompras(getStoredCompras().filter(x => x.codigo !== codigo));
                        }
                    }
                }
                updateStats();
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', async function() {
            // Initialize central database system first
            await initializeGlobalSystem();
            
            // Migrar expedientes existentes para incluir rol del creador
            await migrarExpedientesExistentes();
            
            // Corregir estados inconsistentes de expedientes
            await corregirEstadosExpedientes();
            
            // Start real-time synchronization
            startExpedienteWatcher();
            
            // Render inicial (consolidada por defecto)
            renderStoredEjecutivo();
            renderStoredCompras();
            renderAllInCreated();
            
            // Show global status
            showAllExpedientesGlobal();

            // Ocultar item ejecutivo por defecto si fue eliminado previamente
            if (localStorage.getItem('hideDefaultExecutive') === '1') {
                const def = document.querySelector('#executiveSection .executive-item[data-default="true"]');
                if (def) def.remove();
                const executiveSection = document.getElementById('executiveSection');
                const items = executiveSection.querySelectorAll('.executive-item');
                const emptyState = document.getElementById('emptyExecutive');
                if (items.length === 0 && emptyState) {
                    emptyState.style.display = 'block';
                }
            }

            updateStats();
            scheduleTwoDayAlert();

            // Filtro: eventos
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => applyGlobalFilter(btn.dataset.filter));
            });
            // Estado inicial: TODOS
            applyGlobalFilter('TODOS');

            // Limpiar datos duplicados al inicializar
            limpiarDatosDuplicados();
            
            // Render inicial: todos los expedientes en Expedientes Creados
            renderAllInCreated();
            
            // Configurar el formulario
            const form = document.getElementById('expedienteForm');
            if (form) {
                form.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const formData = new FormData(form);
                    const data = {};
                    for (let [key, value] of formData.entries()) {
                        data[key] = value.toString().trim();
                    }

                    // Calcular d√≠as de tr√°mite autom√°ticamente
                    const fechaIngreso = new Date(data.fechaIngreso);
                    if (!Number.isFinite(fechaIngreso.getTime())) {
                        alert('Fecha de ingreso inv√°lida.');
                        return;
                    }
                    data.diasTramite = calculateDays(data.fechaIngreso);
                    
                    // Validar campos requeridos
                    if (!data.codigo || !data.fechaIngreso) {
                        alert('Por favor complete todos los campos obligatorios.');
                        return;
                    }
                    
                    // Validar n√∫mero de expediente si se proporciona
                    if (data.numero && data.numero.trim()) {
                        // Validar que sea solo n√∫meros
                        if (!validarNumeroSoloDigitos(data.numero)) {
                            alert('‚ùå El n√∫mero de expediente debe contener solo n√∫meros (sin letras, espacios o s√≠mbolos)');
                            return;
                        }
                        
                        // Verificar que el n√∫mero no est√© duplicado
                        const verificacion = await verificarNumeroExpedienteExistente(data.numero);
                        if (verificacion.existe) {
                            alert(`‚ùå El n√∫mero de expediente "${data.numero}" ya existe en el expediente: ${verificacion.expediente.codigo}. Por favor, use un n√∫mero diferente.`);
                            return;
                        }
                    }
                    
                    // Crear nuevo expediente
                    const expedientesCreados = await getStoredCreated();
                    console.log('üìù Expedientes existentes antes de agregar:', expedientesCreados.length);
                    
                    const currentUser = getCurrentUser();
                    const nuevoExpediente = {
                        codigo: data.codigo,
                        numero: data.numero || '',
                        anio: data.anio || '',
                        corresponde: data.corresponde || '',
                        derivado: data.derivado || '',
                        fechaIngreso: data.fechaIngreso,
                        fechaDerivacion: data.fechaDerivacion || '',
                        detalle: data.detalle || '',
                        observacion: data.observacion || '',
                        diasTramite: data.diasTramite || 0,
                        tipo: data.tipo || 'Otros',
                        status: 'CREADO',
                        fechaCreacion: new Date().toISOString(),
                        creadoPor: getCurrentUserIdentifier(),
                        creadoPorNombre: currentUser ? `${currentUser.nombre} ${currentUser.apellido}` : 'Sistema',
                        creadoPorRol: currentUser ? currentUser.role : 'SISTEMA'
                    };
                    
                    expedientesCreados.push(nuevoExpediente);
                    console.log('üìù Expedientes despu√©s de agregar:', expedientesCreados.length);
                    console.log('üìù Nuevo expediente creado:', nuevoExpediente);
                    
                    await setStoredCreated(expedientesCreados);
                    console.log('üìù Expedientes guardados en storage');

                    await renderAllInCreated();
                    console.log('üìù Renderizado completado');
                    updateStats();

                    closeForm();

                    setTimeout(() => {
                        alert('Expediente creado exitosamente');
                    }, 300);
                });
            }
            
            // Cerrar formulario con ESC
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const formPage = document.getElementById('formPage');
                    if (formPage && formPage.classList.contains('active')) {
                        closeForm();
                    }
                }
            });
            
            // Efectos visuales
            document.querySelectorAll('.section-card').forEach(card => {
                card.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-4px)';
                });
                card.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0)';
                });
            });
        });

        // Historia de URL (simulaci√≥n b√°sica)
        window.addEventListener('popstate', function() {
            closeForm();
        });

        // ==================== SISTEMA DE ENRUTAMIENTO CON URLs ====================
        
        // Definir rutas disponibles
        const ROUTES = {
            '/': 'loginPage',
            '/login': 'loginPage',
            '/register': 'registerPage',
            '/dashboard': 'mainPage',
            '/config': 'configPage',
            '/nuevo-expediente': 'newExpedienteModal',
            '/rol-pendiente': 'rolePendingPage'
        };

        // Funci√≥n para navegar a una ruta
        function navigateTo(path) {
            // Actualizar URL sin recargar
            window.history.pushState({}, '', path);
            // Renderizar la ruta
            renderRoute(path);
        }

        // Funci√≥n para renderizar una ruta
        function renderRoute(path) {
            console.log('üîó Navegando a:', path);
            
            // Ocultar todas las p√°ginas y modales
            document.getElementById('loginPage').classList.remove('active');
            document.getElementById('registerPage').classList.remove('active');
            document.getElementById('mainPage').style.display = 'none';
            document.getElementById('configPage').style.display = 'none';
            const newExpModal = document.getElementById('newExpedienteModal');
            if (newExpModal) newExpModal.classList.remove('active');
            const rolePending = document.getElementById('rolePendingPage');
            if (rolePending) rolePending.classList.remove('active');

            // Verificar autenticaci√≥n
            const auth = JSON.parse(localStorage.getItem('authUser') || 'null');
            
            // Rutas p√∫blicas (sin autenticaci√≥n)
            if (path === '/' || path === '/login') {
                if (auth && auth.role && auth.role.trim()) {
                    // Si ya est√° autenticado, redirigir al dashboard
                    navigateTo('/dashboard');
                } else {
                    document.getElementById('loginPage').classList.add('active');
                }
                return;
            }
            
            if (path === '/register') {
                document.getElementById('registerPage').classList.add('active');
                return;
            }

            // Rutas que requieren autenticaci√≥n
            if (!auth) {
                console.log('‚ùå No autenticado, redirigiendo a login');
                navigateTo('/login');
                return;
            }

            // Verificar si tiene rol asignado
            const hasRole = !!(auth.role && auth.role.trim());
            
            if (path === '/rol-pendiente') {
                if (!hasRole && rolePending) {
                    rolePending.classList.add('active');
                } else {
                    navigateTo('/dashboard');
                }
                return;
            }

            // Si no tiene rol y no est√° en la p√°gina de rol pendiente, redirigir
            if (!hasRole) {
                navigateTo('/rol-pendiente');
                return;
            }

            // Rutas protegidas (requieren autenticaci√≥n y rol)
            switch(path) {
                case '/dashboard':
                    document.getElementById('mainPage').style.display = '';
                    applyRoleUI(auth.role);
                    break;
                
                case '/config':
                    document.getElementById('mainPage').style.display = '';
                    showConfig();
                    break;
                
                case '/nuevo-expediente':
                    document.getElementById('mainPage').style.display = '';
                    openNewExpedienteForm();
                    break;
                
                default:
                    // Ruta no encontrada, redirigir al dashboard
                    console.log('‚ö†Ô∏è Ruta no encontrada:', path);
                    navigateTo('/dashboard');
                    break;
            }
        }

        // Escuchar cambios en el historial (bot√≥n atr√°s/adelante)
        window.addEventListener('popstate', function(event) {
            const currentPath = window.location.pathname;
            renderRoute(currentPath);
        });

        // Inicializar ruta al cargar la p√°gina
        window.addEventListener('load', function() {
            const currentPath = window.location.pathname;
            // Si es la ra√≠z, determinar la ruta inicial
            if (currentPath === '/' || currentPath === '') {
                const auth = JSON.parse(localStorage.getItem('authUser') || 'null');
                if (auth && auth.role && auth.role.trim()) {
                    navigateTo('/dashboard');
                } else if (auth && !auth.role) {
                    navigateTo('/rol-pendiente');
                } else {
                    navigateTo('/login');
                }
            } else {
                renderRoute(currentPath);
            }
        });

        // AUTH B√ÅSICO (LOCALSTORAGE) - Actualizado con navegaci√≥n por URL
        function showRegister(){
            navigateTo('/register');
        }
        function showLogin(){
            navigateTo('/login');
        }
        function logout(){
            localStorage.removeItem('authUser');
            navigateTo('/login');
        }

        // INIT AUTH EVENTS
        (function initAuth(){
            // Crear admin por defecto si no existe
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const adminExists = users.find(u => u.username === '35477889');
            if (!adminExists) {
                users.push({
                    username: '35477889',
                    dni: '35477889',
                    nombre: 'ADMIN',
                    apellido: 'SISTEMA',
                    password: '35477889',
                    role: 'ADMIN',
                    blocked: false
                });
                localStorage.setItem('users', JSON.stringify(users));
                console.log('Admin creado autom√°ticamente');
            }
            
            const auth = JSON.parse(localStorage.getItem('authUser') || 'null');
            // No hacer nada aqu√≠, el sistema de enrutamiento se encargar√° de la navegaci√≥n inicial
            
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const fd = new FormData(loginForm);
                    const username = (fd.get('username')||'').toString().trim();
                    const password = (fd.get('password')||'').toString().trim();
                    if (!username || !password) return alert('COMPLETE USUARIO (DNI) Y CONTRASE√ëA');
                    const users = JSON.parse(localStorage.getItem('users')||'[]');
                    const found = users.find(u => (u.username === username || u.dni === username) && u.password === password);
                    if (!found) {
                        alert('USUARIO O CONTRASE√ëA INCORRECTOS');
                        return;
                    }
                    if (found.blocked) {
                        alert('CUENTA BLOQUEADA. CONTACTE AL ADMIN.');
                        return;
                    }
                    localStorage.setItem('authUser', JSON.stringify({ username: found.username, dni: found.dni, nombre: found.nombre, apellido: found.apellido, role: (found.role||'').trim() }));
                    const hasRole = !!((found.role||'').trim());
                    
                    // Usar el sistema de enrutamiento para navegar
                    if (!hasRole) {
                        navigateTo('/rol-pendiente');
                    } else {
                        navigateTo('/dashboard');
                    }
                });
            }
            const registerForm = document.getElementById('registerForm');
            if (registerForm) {
                registerForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const fd = new FormData(registerForm);
                    const pw = (fd.get('password')||'').toString();
                    const cpw = (fd.get('confirmPassword')||'').toString();
                    const dni = (fd.get('dni')||'').toString().trim();
                    if (!/^\d{7,9}$/.test(dni)) return alert('DNI INV√ÅLIDO. USE SOLO N√öMEROS (7 A 9 D√çGITOS)');
                    if (pw !== cpw) return alert('LAS CONTRASE√ëAS NO COINCIDEN');
                    // Guardar usuario con rol por defecto
                    const user = { username: dni, dni, nombre: (fd.get('nombre')||'').toString(), apellido: (fd.get('apellido')||'').toString(), password: pw, role: 'PERSONAL' };
                    const users = JSON.parse(localStorage.getItem('users')||'[]');
                    if (users.find(u => u.username === user.username)) {
                        return alert('YA EXISTE UN USUARIO CON ESE DNI');
                    }
                    users.push(user);
                    localStorage.setItem('users', JSON.stringify(users));
                    alert('USUARIO REGISTRADO');
                    showLogin();
                });
                // Autocompletar USERNAME con DNI
                const dniInput = document.querySelector('#registerForm [name="dni"]');
                const userInput = document.querySelector('#registerForm [name="username"]');
                if (dniInput && userInput) {
                    const sync = () => { userInput.value = dniInput.value.trim(); };
                    dniInput.addEventListener('input', sync);
                    dniInput.addEventListener('change', sync);
                }
            }
        })();

        function applyRoleUI(role){
            console.log('üîê Aplicando rol:', role);
            
            // Todos los usuarios pueden ver expedientes - no hay restricciones de visualizaci√≥n
            // Solo se mantienen restricciones para funciones administrativas
            
            // Bot√≥n de agregar expediente - solo ADMIN y MESA_DE_ENTRADA pueden crear
            const addBtn = document.querySelector('.add-btn');
            if (addBtn) {
                if (role === 'PERSONAL') {
                    addBtn.style.display = 'none';
                } else {
                    addBtn.style.display = '';
                }
            }
            
            // Configuraci√≥n de pesta√±as seg√∫n rol
            const configTabs = document.querySelectorAll('#configTabs .tab-btn');
            if (configTabs.length > 0) {
                if (role === 'ADMIN') {
                    // ADMIN: ve todas las pesta√±as
                    configTabs.forEach(tab => tab.style.display = '');
                } else {
                    // MESA_DE_ENTRADA y PERSONAL: solo ven USUARIO
                    configTabs.forEach(tab => {
                        if (tab.dataset.tab === 'usuario') {
                            tab.style.display = '';
                        } else {
                            tab.style.display = 'none';
                        }
                    });
                }
            }
            
            // IMPORTANTE: Todos los usuarios pueden VER expedientes
            // No hay restricciones de visualizaci√≥n por rol
            console.log('‚úÖ Expedientes visibles para todos los usuarios independientemente del rol');
        }

        // Funci√≥n para refrescar expedientes manualmente
        function refreshExpedientes() {
            console.log('üîÑ Refrescando expedientes...');
            renderAllInCreated();
            alert('Expedientes actualizados');
        }

        // Enhanced cross-device synchronization system
        function startExpedienteWatcher() {
            console.log('üöÄ Iniciando sistema de sincronizaci√≥n cross-device de expedientes...');
            
            // Listen for updates from other tabs/windows
            window.addEventListener('expedientesUpdated', (event) => {
                console.log('üì° Expedientes actualizados en otra pesta√±a:', event.detail);
                if (event.detail.deviceId !== DEVICE_ID) {
                    console.log('üîÑ Actualizando desde otro dispositivo...');
                    refreshAllSections();
                }
            });
            
            // Listen for storage events (cross-tab communication)
            window.addEventListener('storage', (event) => {
                if (event.key === CENTRAL_DATABASE_KEY || event.key.includes('SHARED_') || event.key.includes('PARQUE_AUTOMOTOR_CENTRAL_DB')) {
                    console.log('üîÑ Cambios detectados en almacenamiento central, sincronizando...');
                    refreshAllSections();
                }
            });
            
            // Listen for URL hash changes (cross-device sharing)
            window.addEventListener('hashchange', () => {
                console.log('üîó URL hash cambi√≥, verificando datos compartidos...');
                loadFromUrlIfAvailable();
            });
            
            // BroadcastChannel for cross-tab communication
            if (typeof BroadcastChannel !== 'undefined') {
                const channel = new BroadcastChannel('expedientes_sync');
                channel.addEventListener('message', (event) => {
                    console.log('üìª Mensaje recibido via BroadcastChannel:', event.data);
                    if (event.data.type === 'expediente_update' && event.data.deviceId !== DEVICE_ID) {
                        console.log('üîÑ Sincronizando desde BroadcastChannel...');
                        refreshAllSections();
                    }
                });
            }
            
            // Periodic sync check every 10 seconds for cross-device updates (reduced frequency)
            setInterval(() => {
                checkForCrossDeviceUpdates();
            }, 10000);
            
            // Check for data in URL on initial load
            loadFromUrlIfAvailable();
            
            // Initialize counters
            const initialData = getAllGlobalExpedientes();
            window.lastExpedienteCount = initialData.creados.length + initialData.ejecutivo.length + initialData.compras.length + initialData.finalizados.length;
            window.lastGlobalVersion = initialData.version;
            
            console.log('‚úÖ Sistema de sincronizaci√≥n cross-device activo');
        }
        
        function refreshAllSections() {
            console.log('üîÑ Refrescando todas las secciones...');
                    renderAllInCreated();
            renderStoredEjecutivo();
            renderStoredCompras();
        }
        
        function checkForCrossDeviceUpdates() {
            const allData = getAllGlobalExpedientes();
            const currentCount = allData.creados.length + allData.ejecutivo.length + allData.compras.length + allData.finalizados.length;
            
            // Solo actualizar si hay cambios REALES en el conteo
            const countChanged = window.lastExpedienteCount !== currentCount;
            const versionChanged = window.lastGlobalVersion !== allData.version;
            
            if (countChanged) {
                console.log('üìù Cambio REAL detectado en cantidad de expedientes:', window.lastExpedienteCount, '->', currentCount);
                window.lastExpedienteCount = currentCount;
                window.lastGlobalVersion = allData.version;
                refreshAllSections();
            } else if (versionChanged && !window.lastGlobalVersion) {
                // Solo en la primera carga
                console.log('üìù Inicializando versi√≥n:', allData.version);
                window.lastExpedienteCount = currentCount;
                window.lastGlobalVersion = allData.version;
            }
        }
        
        function loadFromUrlIfAvailable() {
            try {
                const hashData = window.location.hash.substr(1);
                if (hashData && hashData.startsWith('data=')) {
                    console.log('üîó Datos encontrados en URL, cargando...');
                    const encoded = hashData.substr(5);
                    const decoded = JSON.parse(atob(encoded));
                    
                    console.log('üì• Datos decodificados desde URL:', decoded);
                    
                    // Load data from URL into local storage
                    const categories = ['expedientesCreados', 'expedientesFinalizados', 'expedientesEjecutivo', 'expedientesCompras'];
                    let hasData = false;
                    
                    categories.forEach(category => {
                        if (decoded[category] && Array.isArray(decoded[category]) && decoded[category].length > 0) {
                            console.log(`üì• Cargando ${category} desde URL:`, decoded[category].length, 'items');
                            saveToLocalStorage(category, decoded[category]);
                            saveToSharedStorage(category, decoded[category]);
                            hasData = true;
                        }
                    });
                    
                    if (hasData) {
                        // Refresh display
                        refreshAllSections();
                        console.log('‚úÖ Datos cargados exitosamente desde URL compartida');
                        
                        // Show success message
                        alert('üì±üíª ¬°Datos sincronizados exitosamente desde otro dispositivo!');
                    } else {
                        console.log('‚ö†Ô∏è No hay datos v√°lidos en la URL');
                    }
                } else {
                    console.log('üîç No se encontraron datos de sincronizaci√≥n en la URL');
                }
            } catch (error) {
                console.error('Error loading data from URL:', error);
                alert('‚ùå Error al cargar datos de sincronizaci√≥n. Verifica que la URL sea correcta.');
            }
        }

        // Initialize central database system and migrate existing data
        async function initializeGlobalSystem() {
            console.log('üöÄ Inicializando sistema central de expedientes...');
            
            // Inicializar base de datos central primero
            await initializeCentralDatabase();
            
            // Configurar listeners
            setupCentralDatabaseListeners();
            
            // Check if we need to migrate from old localStorage system
            const hasLocalData = localStorage.getItem('expedientesCreados') || 
                                localStorage.getItem('expedientesFinalizados') || 
                                localStorage.getItem('expedientesEjecutivo') || 
                                localStorage.getItem('expedientesCompras');
                                
            const hasGlobalData = localStorage.getItem('SISTEMA_PARQUE_AUTOMOTOR_GLOBAL');
            
            if (hasLocalData && !hasGlobalData) {
                console.log('üì¶ Migrando datos locales al sistema global...');
                
                // Trigger migration by calling the get functions (they handle migration internally)
                getStoredCreated();
                getStoredFinalizados();
                getStoredEjecutivo();
                getStoredCompras();
                
                console.log('‚úÖ Migraci√≥n completada - todos los expedientes ahora son globales');
            }
            
            // Show global status in console
            const globalData = getAllGlobalExpedientes();
            console.log('üåê Estado del sistema global:');
            console.log('  - Expedientes creados:', globalData.creados.length);
            console.log('  - Expedientes finalizados:', globalData.finalizados.length);
            console.log('  - Expedientes ejecutivo:', globalData.ejecutivo.length);
            console.log('  - Expedientes compras:', globalData.compras.length);
            console.log('  - √öltima actualizaci√≥n:', globalData.lastUpdated);
            console.log('  - Versi√≥n:', globalData.version);
            
            console.log('‚úÖ Sistema global inicializado - expedientes accesibles desde cualquier navegador/usuario');
            
            // Actualizar indicador de estado
            updateDatabaseStatusIndicator();
            
            // Generate and show sync URL
            generateSyncUrl();
        }
        
        // Generate URL for cross-device synchronization
        function generateSyncUrl() {
            // Firebase maneja la sincronizaci√≥n autom√°ticamente
            console.log('üî• Firebase activo - sincronizaci√≥n autom√°tica en tiempo real');
        }
        
        function addSyncUrlDisplay(syncUrl) {
            // Firebase maneja la sincronizaci√≥n autom√°ticamente - no mostrar URL
        }
        
        // Global functions for sync URL management
        window.copySyncUrl = function() {
            const input = document.querySelector('#syncUrlDisplay input');
            if (input) {
                input.select();
                document.execCommand('copy');
                alert('üìã URL copiada al portapapeles! P√©gala en otro dispositivo para sincronizar.');
            }
        };
        
        window.toggleSyncInstructions = function() {
            const instructions = document.getElementById('syncInstructions');
            if (instructions) {
                instructions.style.display = instructions.style.display === 'none' ? 'block' : 'none';
            }
        };
        
        // Debug function to check central database status
        window.debugCentralDatabase = function() {
            console.log('üîç DEBUG: Estado de la Base de Datos Central');
            console.log('üì± Device ID:', DEVICE_ID);
            console.log('üóÑÔ∏è Tipo de base central:', centralDatabase ? centralDatabase.type || 'indexedDB' : 'No inicializada');
            
            // Check cache status
            console.log('üíæ Estado del cach√© central:');
            Object.keys(centralCache).forEach(key => {
                if (key !== 'lastUpdate') {
                    console.log(`  - ${key}: ${centralCache[key].length} expedientes`);
                }
            });
            console.log('  - √öltima actualizaci√≥n:', centralCache.lastUpdate);
            
            // Check localStorage central keys
            console.log('üîë Claves de localStorage central:');
            const centralKeys = Object.keys(localStorage).filter(key => key.startsWith(CENTRAL_DATABASE_KEY));
            centralKeys.forEach(key => {
                try {
                    const data = JSON.parse(localStorage.getItem(key));
                    console.log(`  - ${key}: ${Array.isArray(data) ? data.length : 'No es array'} items`);
                } catch (e) {
                    console.log(`  - ${key}: Error parseando datos`);
                }
            });
            
            // Test database read
            console.log('üß™ Probando lectura de base de datos...');
            ['expedientesCreados', 'expedientesFinalizados', 'expedientesEjecutivo', 'expedientesCompras'].forEach(async (category) => {
                try {
                    const data = await getCentralExpedientes(category);
                    console.log(`‚úÖ ${category}: ${data.length} expedientes le√≠dos correctamente`);
                } catch (error) {
                    console.error(`‚ùå Error leyendo ${category}:`, error);
                }
            });
        };
        
        // Debug function to check sync status (legacy)
        window.debugSyncStatus = function() {
            console.log('‚ÑπÔ∏è Esta funci√≥n ha sido reemplazada por debugCentralDatabase()');
            console.log('üîÑ Ejecutando debugCentralDatabase() en su lugar...');
            debugCentralDatabase();
        };
        
        
        // Funci√≥n para forzar sincronizaci√≥n cross-device
        window.forceCrossDeviceSync = function() {
            console.log('üîÑ Forzando sincronizaci√≥n cross-device...');
            
            if (isFirebaseConnected) {
                console.log('üî• Firebase est√° conectado - sincronizaci√≥n autom√°tica activa');
                alert('üî• Firebase est√° conectado!\n\n‚úÖ Sincronizaci√≥n autom√°tica en tiempo real activa.\n\nüì± Todos los usuarios ver√°n los mismos expedientes autom√°ticamente.');
            } else {
                console.log('‚ö†Ô∏è Firebase no conectado - usando sistema local');
                alert('‚ö†Ô∏è Firebase no conectado\n\nüì± Los expedientes solo se sincronizan en el mismo navegador.\n\nüîß Para sincronizaci√≥n entre dispositivos, configura Firebase.');
            }
        };
        
        // Actualizar indicador de estado de base de datos
        function updateDatabaseStatusIndicator() {
            const indicator = document.getElementById('dbStatusIndicator');
            const instructions = document.getElementById('firebaseInstructions');
            
            if (indicator) {
                if (isFirebaseConnected) {
                    indicator.style.background = 'linear-gradient(135deg, #059669, #047857)';
                    indicator.innerHTML = '‚úÖ Sistema sincronizado';
                    if (instructions) instructions.style.display = 'none';
                } else {
                    indicator.style.background = 'linear-gradient(135deg, #f59e0b, #d97706)';
                    indicator.innerHTML = '‚ö†Ô∏è MODO LOCAL - Cada usuario ve solo sus expedientes (configurar Firebase para compartir)';
                    if (instructions) instructions.style.display = 'block';
                }
            }
        }
        
        // Funci√≥n para activar Firebase f√°cilmente
        window.enableFirebase = function() {
            if (confirm('¬øQuieres activar Firebase para base de datos compartida?\n\nEsto requerir√° configurar tu proyecto Firebase primero.')) {
                alert('üìã PASOS PARA ACTIVAR FIREBASE:\n\n1. Ve a: https://console.firebase.google.com/\n2. Crea nuevo proyecto "parque-automotor"\n3. Activa "Realtime Database"\n4. Copia la configuraci√≥n\n5. Reemplaza firebaseConfig en el c√≥digo\n6. Cambia useFirebase = true\n\n¬°Y listo! Todos ver√°n los mismos expedientes.');
                window.open('https://console.firebase.google.com/', '_blank');
            }
        };

        // Function to show all expedientes from all categories and users
        function showAllExpedientesGlobal() {
            console.log('üåç Mostrando todos los expedientes globales...');
            
            const allData = getAllGlobalExpedientes();
            const totalCount = allData.creados.length + allData.finalizados.length + allData.ejecutivo.length + allData.compras.length;
            
            console.log('üìä Resumen global de expedientes:');
            console.log('  üÜï Creados:', allData.creados.length);
            console.log('  ‚úÖ Finalizados:', allData.finalizados.length);
            console.log('  üè¢ Ejecutivo:', allData.ejecutivo.length);
            console.log('  üõí Compras:', allData.compras.length);
            console.log('  üìà Total:', totalCount);
            
            // Update the page title to reflect global access
            document.title = `Parque Automotor - ${totalCount} expedientes globales`;
            
            // Show notification about global system
            if (window.globalSystemNotificationShown !== true) {
                console.log('üí° Sistema configurado para acceso global - todos los expedientes son visibles para todos los usuarios');
                window.globalSystemNotificationShown = true;
            }
            
            return {
                total: totalCount,
                creados: allData.creados.length,
                finalizados: allData.finalizados.length,
                ejecutivo: allData.ejecutivo.length,
                compras: allData.compras.length,
                lastUpdated: allData.lastUpdated
            };
        }


        // Funci√≥n para limpiar datos duplicados
        async function limpiarDatosDuplicados() {
            console.log('üßπ Limpiando datos duplicados...');
            
            // Obtener todos los expedientes de todas las secciones
            const creados = await getStoredCreated();
            const ejecutivo = await getStoredEjecutivo();
            const compras = await getStoredCompras();
            const hospitales = await getStoredHospitales();
            const otros = await getStoredOtros();
            const finalizados = await getStoredFinalizados();
            
            // NUNCA tocar los expedientes finalizados - son inmutables
            console.log(`üîí Protegiendo ${finalizados.length} expedientes finalizados de la limpieza`);
            
            // Crear un mapa de c√≥digos finalizados para verificaci√≥n
            const finalizadoSet = new Set(finalizados.map(e => e.codigo));
            
            // Contar expedientes finalizados en secciones activas
            const finalizadosEnActivas = [...creados, ...ejecutivo, ...compras, ...hospitales, ...otros].filter(exp => exp.estado === 'FINALIZADO');
            console.log(`üîí Encontrados ${finalizadosEnActivas.length} expedientes finalizados en secciones activas - PROTEGIDOS`);
            
            // Limpiar duplicados entre secciones activas
            const expedientesLimpios = {
                creados: [],
                ejecutivo: [],
                compras: [],
                hospitales: [],
                otros: []
            };
            
                const codigosProcesados = new Set();
                
            // Procesar en orden de prioridad: creados -> ejecutivo -> compras -> hospitales -> otros
                const secciones = [
                    { nombre: 'creados', datos: creados },
                    { nombre: 'ejecutivo', datos: ejecutivo },
                    { nombre: 'compras', datos: compras },
                { nombre: 'hospitales', datos: hospitales },
                { nombre: 'otros', datos: otros }
                ];
                
                secciones.forEach(seccion => {
                    const datosLimpios = seccion.datos.filter(exp => {
                    // PROTECCI√ìN ABSOLUTA: Si el expediente est√° finalizado, NUNCA lo tocar
                    if (exp.estado === 'FINALIZADO') {
                        console.log(`üîí Protegiendo expediente finalizado ${exp.codigo} en ${seccion.nombre}`);
                        return true; // SIEMPRE mantener expedientes finalizados
                    }
                    
                    // Si ya se proces√≥ este c√≥digo, es duplicado
                        if (codigosProcesados.has(exp.codigo)) {
                            console.log(`üóëÔ∏è Removiendo duplicado ${exp.codigo} de ${seccion.nombre}`);
                            return false;
                        }
                    
                        codigosProcesados.add(exp.codigo);
                        return true;
                    });
                    
                expedientesLimpios[seccion.nombre] = datosLimpios;
                });
                
                // Guardar datos limpios
            setStoredCreated(expedientesLimpios.creados);
            setStoredEjecutivo(expedientesLimpios.ejecutivo);
            setStoredCompras(expedientesLimpios.compras);
            setStoredHospitales(expedientesLimpios.hospitales);
            setStoredOtros(expedientesLimpios.otros);
            
            // Verificar que no se perdieron expedientes finalizados
            const finalizadosDespues = [...expedientesLimpios.creados, ...expedientesLimpios.ejecutivo, ...expedientesLimpios.compras, ...expedientesLimpios.hospitales, ...expedientesLimpios.otros].filter(exp => exp.estado === 'FINALIZADO');
            console.log(`üîí Verificaci√≥n: ${finalizadosDespues.length} expedientes finalizados preservados despu√©s de la limpieza`);
            
            if (finalizadosDespues.length < finalizadosEnActivas.length) {
                console.error('‚ùå ERROR: Se perdieron expedientes finalizados durante la limpieza!');
                console.error(`‚ùå Antes: ${finalizadosEnActivas.length}, Despu√©s: ${finalizadosDespues.length}`);
            }
            
            console.log('‚úÖ Duplicados eliminados - cada expediente solo en una secci√≥n');
            console.log(`üîí ${finalizados.length} expedientes finalizados protegidos`);
        }

        // Funci√≥n para eliminar expediente de cualquier secci√≥n
        async function deleteExpedienteCreado(codigo) {
            // Buscar el expediente en todas las secciones para verificar permisos
            let expediente = null;
            let seccionExpediente = '';
            
            // Buscar en todas las secciones
            const creados = await getStoredCreated();
            const ejecutivo = await getStoredEjecutivo();
            const compras = await getStoredCompras();
            const hospitales = await getStoredHospitales();
            const otros = await getStoredOtros();
            const finalizados = await getStoredFinalizados();
            
            expediente = creados.find(e => e.codigo === codigo);
            if (expediente) seccionExpediente = 'creados';
            
            if (!expediente) {
                expediente = ejecutivo.find(e => e.codigo === codigo);
                if (expediente) seccionExpediente = 'ejecutivo';
            }
            
            if (!expediente) {
                expediente = compras.find(e => e.codigo === codigo);
                if (expediente) seccionExpediente = 'compras';
            }
            
            if (!expediente) {
                expediente = hospitales.find(e => e.codigo === codigo);
                if (expediente) seccionExpediente = 'hospitales';
            }
            
            if (!expediente) {
                expediente = otros.find(e => e.codigo === codigo);
                if (expediente) seccionExpediente = 'otros';
            }
            
            if (!expediente) {
                expediente = finalizados.find(e => e.codigo === codigo);
                if (expediente) seccionExpediente = 'finalizados';
            }
            
            if (!expediente) {
                alert('‚ùå Expediente no encontrado');
                return;
            }
            
            // Verificar si el expediente est√° finalizado
            if (expediente.estado === 'FINALIZADO') {
                alert(`‚ùå El expediente ${codigo} est√° finalizado y no puede ser eliminado.`);
                return;
            }
            
            // Verificar permisos
            if (!canUserModifyExpediente(expediente)) {
                const currentUser = getCurrentUser();
                const mensaje = isCurrentUserAdmin() 
                    ? `‚ùå Error de permisos: No se puede eliminar el expediente ${codigo}`
                    : `‚ùå No tienes permisos para eliminar este expediente.\n\nSolo el usuario que lo cre√≥ (${expediente.creadoPorNombre}) o un ADMIN pueden eliminarlo.`;
                alert(mensaje);
                return;
            }

            if (confirm(`¬øEst√°s seguro de que quieres eliminar el expediente ${codigo}?\n\nCreado por: ${expediente.creadoPorNombre}`)) {
                console.log('üóëÔ∏è Eliminando expediente:', codigo);
                
                // Buscar y eliminar de todas las listas
                let eliminado = false;
                
                // Eliminar de creados
                const expedientesCreados = await getStoredCreated();
                const filteredCreados = expedientesCreados.filter(e => e.codigo !== codigo);
                if (filteredCreados.length !== expedientesCreados.length) {
                    setStoredCreated(filteredCreados);
                    eliminado = true;
                    console.log('‚úÖ Eliminado de Expedientes Creados');
                }
                
                // Eliminar de ejecutivo
                const expedientesEjecutivo = await getStoredEjecutivo();
                const filteredEjecutivo = expedientesEjecutivo.filter(e => e.codigo !== codigo);
                if (filteredEjecutivo.length !== expedientesEjecutivo.length) {
                    setStoredEjecutivo(filteredEjecutivo);
                    eliminado = true;
                    console.log('‚úÖ Eliminado de Parque Automotor Ejecutivo');
                }
                
                // Eliminar de compras
                const expedientesCompras = await getStoredCompras();
                const filteredCompras = expedientesCompras.filter(e => e.codigo !== codigo);
                if (filteredCompras.length !== expedientesCompras.length) {
                    setStoredCompras(filteredCompras);
                    eliminado = true;
                    console.log('‚úÖ Eliminado de Centro de Compras');
                }
                
                // Eliminar de hospitales
                const expedientesHospitales = await getStoredHospitales();
                const filteredHospitales = expedientesHospitales.filter(e => e.codigo !== codigo);
                if (filteredHospitales.length !== expedientesHospitales.length) {
                    setStoredHospitales(filteredHospitales);
                    eliminado = true;
                    console.log('‚úÖ Eliminado de Hospitales');
                }
                
                // Eliminar de otros
                const expedientesOtros = await getStoredOtros();
                const filteredOtros = expedientesOtros.filter(e => e.codigo !== codigo);
                if (filteredOtros.length !== expedientesOtros.length) {
                    setStoredOtros(filteredOtros);
                    eliminado = true;
                    console.log('‚úÖ Eliminado de Otros');
                }
                
                // Eliminar de finalizados
                const expedientesFinalizados = await getStoredFinalizados();
                const filteredFinalizados = expedientesFinalizados.filter(e => e.codigo !== codigo);
                if (filteredFinalizados.length !== expedientesFinalizados.length) {
                    setStoredFinalizados(filteredFinalizados);
                    eliminado = true;
                    console.log('‚úÖ Eliminado de Finalizados');
                }
                
                if (eliminado) {
                    // Forzar actualizaci√≥n de todas las secciones
                    renderAllInCreated();
                    renderStoredEjecutivo();
                    renderStoredCompras();
                    renderStoredHospitales();
                    renderStoredOtros();
                    updateStats();
                    alert('Expediente eliminado exitosamente');
                } else {
                    alert('Expediente no encontrado');
                }
            }
        }

        // Funci√≥n para finalizar expediente
        async function finalizeExpediente(codigo, button) {
            // Buscar el expediente para verificar permisos
            let expediente = null;
            
            const creados = await getStoredCreated();
            const ejecutivo = await getStoredEjecutivo();
            const compras = await getStoredCompras();
            const hospitales = await getStoredHospitales();
            const otros = await getStoredOtros();
            const finalizados = await getStoredFinalizados();
            
            expediente = creados.find(e => e.codigo === codigo);
            if (!expediente) expediente = ejecutivo.find(e => e.codigo === codigo);
            if (!expediente) expediente = compras.find(e => e.codigo === codigo);
            if (!expediente) expediente = hospitales.find(e => e.codigo === codigo);
            if (!expediente) expediente = otros.find(e => e.codigo === codigo);
            if (!expediente) expediente = finalizados.find(e => e.codigo === codigo);
            
            if (!expediente) {
                alert('‚ùå Expediente no encontrado');
                return;
            }
            
            // Verificar permisos
            if (!canUserModifyExpediente(expediente)) {
                const mensaje = isCurrentUserAdmin() 
                    ? `‚ùå Error de permisos: No se puede finalizar el expediente ${codigo}`
                    : `‚ùå No tienes permisos para finalizar este expediente.\n\nSolo el usuario que lo cre√≥ (${expediente.creadoPorNombre}) o un ADMIN pueden finalizarlo.`;
                alert(mensaje);
                return;
            }
            
            if (confirm(`¬øEst√° seguro de que desea finalizar el expediente ${codigo}?\n\nCreado por: ${expediente.creadoPorNombre}`)) {
                console.log('‚úÖ Finalizando expediente:', codigo);
                
                try {
                    // Buscar el expediente en todas las listas y marcarlo como finalizado
                let found = false;
                    let sourceList = '';
                
                // Buscar en creados
                const expedientesCreados = await getStoredCreated();
                    const expedienteCreados = expedientesCreados.find(e => e.codigo === codigo);
                    if (expedienteCreados) {
                        console.log('üìã Expediente encontrado en CREADOS - marcando como finalizado');
                        expedienteCreados.estado = 'FINALIZADO';
                        expedienteCreados.fechaFinalizacion = new Date().toISOString();
                        await setStoredCreated(expedientesCreados);
                    found = true;
                        sourceList = 'creados';
                }
                
                // Buscar en ejecutivo
                if (!found) {
                    const expedientesEjecutivo = await getStoredEjecutivo();
                        const expedienteEjecutivo = expedientesEjecutivo.find(e => e.codigo === codigo);
                        if (expedienteEjecutivo) {
                            console.log('üìã Expediente encontrado en EJECUTIVO - marcando como finalizado');
                            expedienteEjecutivo.estado = 'FINALIZADO';
                            expedienteEjecutivo.fechaFinalizacion = new Date().toISOString();
                            await setStoredEjecutivo(expedientesEjecutivo);
                        found = true;
                            sourceList = 'ejecutivo';
                    }
                }
                
                // Buscar en compras
                if (!found) {
                    const expedientesCompras = await getStoredCompras();
                        const expedienteCompras = expedientesCompras.find(e => e.codigo === codigo);
                        if (expedienteCompras) {
                            console.log('üìã Expediente encontrado en COMPRAS - marcando como finalizado');
                            expedienteCompras.estado = 'FINALIZADO';
                            expedienteCompras.fechaFinalizacion = new Date().toISOString();
                            await setStoredCompras(expedientesCompras);
                        found = true;
                            sourceList = 'compras';
                        }
                    }
                    
                    // Buscar en hospitales
                    if (!found) {
                        const expedientesHospitales = await getStoredHospitales();
                        const expedienteHospitales = expedientesHospitales.find(e => e.codigo === codigo);
                        if (expedienteHospitales) {
                            console.log('üìã Expediente encontrado en HOSPITALES - marcando como finalizado');
                            expedienteHospitales.estado = 'FINALIZADO';
                            expedienteHospitales.fechaFinalizacion = new Date().toISOString();
                            await setStoredHospitales(expedientesHospitales);
                            found = true;
                            sourceList = 'hospitales';
                        }
                    }
                    
                    // Buscar en otros
                    if (!found) {
                        const expedientesOtros = await getStoredOtros();
                        const expedienteOtros = expedientesOtros.find(e => e.codigo === codigo);
                        if (expedienteOtros) {
                            console.log('üìã Expediente encontrado en OTROS - marcando como finalizado');
                            expedienteOtros.estado = 'FINALIZADO';
                            expedienteOtros.fechaFinalizacion = new Date().toISOString();
                            await setStoredOtros(expedientesOtros);
                            found = true;
                            sourceList = 'otros';
                        }
                    }
                    
                    if (found) {
                        console.log(`‚úÖ Expediente ${codigo} finalizado en ${sourceList}`);
                    
                    // Actualizar la interfaz
                        await renderAllInCreated();
                        await renderStoredEjecutivo();
                        await renderStoredCompras();
                        await renderStoredHospitales();
                        await renderStoredOtros();
                    updateStats();
                    
                        alert(`Expediente ${codigo} finalizado exitosamente en ${sourceList}`);
                } else {
                        console.error('‚ùå Expediente no encontrado en ninguna lista');
                    alert('Expediente no encontrado');
                    }
                } catch (error) {
                    console.error('‚ùå Error durante la finalizaci√≥n:', error);
                    alert('Error al finalizar el expediente. Por favor, intente nuevamente.');
                }
            }
        }

        // Funci√≥n para editar expediente
        async function editExpediente(codigo) {
            console.log('‚úèÔ∏è Editando expediente:', codigo);
            
            // Buscar el expediente en todas las secciones
            let expediente = null;
            
            const creados = await getStoredCreated();
            const ejecutivo = await getStoredEjecutivo();
            const compras = await getStoredCompras();
            const hospitales = await getStoredHospitales();
            const otros = await getStoredOtros();
            const finalizados = await getStoredFinalizados();
            
            expediente = creados.find(e => e.codigo === codigo);
            if (!expediente) expediente = ejecutivo.find(e => e.codigo === codigo);
            if (!expediente) expediente = compras.find(e => e.codigo === codigo);
            if (!expediente) expediente = hospitales.find(e => e.codigo === codigo);
            if (!expediente) expediente = otros.find(e => e.codigo === codigo);
            if (!expediente) expediente = finalizados.find(e => e.codigo === codigo);
            
            if (!expediente) {
                alert('‚ùå Expediente no encontrado');
                return;
            }
            
            // Verificar si est√° finalizado
            if (expediente.estado === 'FINALIZADO') {
                alert(`‚ùå El expediente ${codigo} est√° finalizado y no puede ser modificado.`);
                return;
            }
            
            // Verificar permisos
            if (!canUserModifyExpediente(expediente)) {
                const mensaje = isCurrentUserAdmin() 
                    ? `‚ùå Error de permisos: No se puede editar el expediente ${codigo}`
                    : `‚ùå No tienes permisos para editar este expediente.\n\nSolo el usuario que lo cre√≥ (${expediente.creadoPorNombre}) o un ADMIN pueden editarlo.`;
                alert(mensaje);
                return;
            }
            
            if (expediente) {
                console.log('üìù Expediente encontrado:', expediente);
                
                // Crear URL con todos los datos del expediente
                const params = new URLSearchParams();
                Object.keys(expediente).forEach(key => {
                    if (expediente[key] !== null && expediente[key] !== undefined) {
                        params.append(key, expediente[key]);
                    }
                });
                
                const url = `/nuevo-expediente/?${params.toString()}`;
                console.log('üîó URL de edici√≥n:', url);
                
                // Redirigir a la p√°gina de edici√≥n
                window.location.href = url;
            } else {
                console.error('‚ùå Expediente no encontrado en ninguna lista:', codigo);
                alert('Expediente no encontrado');
            }
        }

        // Funci√≥n para debug de expedientes
        function debugExpedientes() {
            console.log('üêõ DEBUG EXPEDIENTES INICIADO');
            console.log('================================');
            
            // Verificar localStorage
            console.log('üì¶ localStorage completo:');
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const value = localStorage.getItem(key);
                console.log(`  ${key}:`, value);
            }
            
            // Verificar funciones de storage
            console.log('üîç Funciones de storage:');
            console.log('  - getStoredCreated():', getStoredCreated());
            console.log('  - getStoredEjecutivo():', getStoredEjecutivo());
            console.log('  - getStoredCompras():', getStoredCompras());
            console.log('  - getStoredFinalizados():', getStoredFinalizados());
            
            // Verificar DOM
            console.log('üéØ Estado del DOM:');
            const expedientesCreados = document.getElementById('expedientesCreados');
            const emptyExpedientes = document.getElementById('emptyExpedientes');
            console.log('  - expedientesCreados:', expedientesCreados);
            console.log('  - emptyExpedientes:', emptyExpedientes);
            console.log('  - Elementos .expediente-item:', expedientesCreados?.querySelectorAll('.expediente-item').length || 0);
            
            // Forzar renderizado
            console.log('üîÑ Forzando renderizado...');
            renderAllInCreated();
            
            alert('Debug completado. Revisa la consola del navegador (F12)');
        }

        // Funci√≥n para buscar expedientes por fecha en TODAS las secciones
        async function buscarPorFechaGlobal() {
            const fechaDesde = document.getElementById('fechaDesde').value;
            const fechaHasta = document.getElementById('fechaHasta').value;
            
            if (!fechaDesde && !fechaHasta) {
                alert('Por favor selecciona al menos una fecha (DESDE o HASTA)');
                return;
            }
            
            console.log('üîç Buscando expedientes por fecha en TODAS las secciones:', { fechaDesde, fechaHasta });
            
            try {
                // Obtener todos los expedientes de TODAS las secciones
            const todosExpedientes = [
                    ...(await getStoredCreated()),
                    ...(await getStoredEjecutivo()),
                    ...(await getStoredCompras()),
                    ...(await getStoredHospitales()),
                    ...(await getStoredOtros()),
                    ...(await getStoredFinalizados())
                ];
                
                console.log('üìä Total de expedientes en todas las secciones:', todosExpedientes.length);
            
            // Filtrar por fecha
            const expedientesFiltrados = todosExpedientes.filter(exp => {
                const fechaExpediente = new Date(exp.fechaIngreso || exp.fechaCreacion);
                
                if (fechaDesde && fechaHasta) {
                    const desde = new Date(fechaDesde);
                    const hasta = new Date(fechaHasta);
                    return fechaExpediente >= desde && fechaExpediente <= hasta;
                } else if (fechaDesde) {
                    const desde = new Date(fechaDesde);
                    return fechaExpediente >= desde;
                } else if (fechaHasta) {
                    const hasta = new Date(fechaHasta);
                    return fechaExpediente <= hasta;
                }
                
                return true;
            });
            
            console.log('üìä Expedientes encontrados:', expedientesFiltrados.length);
            
                // Renderizar solo los expedientes filtrados en todas las secciones
                await renderExpedientesFiltradosGlobal(expedientesFiltrados);
            
            // Mostrar resumen
                let mensaje = `üîç B√∫squeda completada: ${expedientesFiltrados.length} expedientes encontrados`;
            if (fechaDesde && fechaHasta) {
                mensaje += ` entre ${fechaDesde} y ${fechaHasta}`;
            } else if (fechaDesde) {
                mensaje += ` desde ${fechaDesde}`;
            } else if (fechaHasta) {
                mensaje += ` hasta ${fechaHasta}`;
            }
            
            alert(mensaje);
                
            } catch (error) {
                console.error('‚ùå Error en b√∫squeda global:', error);
                alert('‚ùå Error al buscar expedientes. Por favor, intente nuevamente.');
            }
        }

        // Funci√≥n para renderizar expedientes filtrados
        function renderExpedientesFiltrados(expedientes) {
            const expedientesCreados = document.getElementById('expedientesCreados');
            const emptyExpedientes = document.getElementById('emptyExpedientes');
            
            // Limpiar lista actual
            Array.from(expedientesCreados.querySelectorAll('.expediente-item')).forEach(n => n.remove());
            
            if (!expedientes.length) {
                if (emptyExpedientes) {
                    emptyExpedientes.style.display = 'block';
                    emptyExpedientes.innerHTML = `
                        <div class="empty-icon">üîç</div>
                        <p>No se encontraron expedientes en el rango de fechas seleccionado</p>
                    `;
                }
                return;
            }
            
            if (emptyExpedientes) emptyExpedientes.style.display = 'none';
            
            // Crear mapa para evitar duplicados
            const mapByCode = new Map();
            expedientes.forEach(exp => {
                if (!mapByCode.has(exp.codigo)) {
                    mapByCode.set(exp.codigo, exp);
                }
            });
            
            // Renderizar expedientes filtrados
            const finalizadoSet = new Set(getStoredFinalizados().map(e => e.codigo));
            
            Array.from(mapByCode.values()).forEach(data => {
                const item = document.createElement('div');
                item.className = 'expediente-item';
                const isFinal = finalizadoSet.has(data.codigo);
                
                item.innerHTML = `
                    <div class="status-badge ${isFinal ? 'status-finalizado' : 'status-pendiente'}">${isFinal ? 'FINALIZADO' : 'PENDIENTE'}</div>
                    <div class="expediente-header">${data.codigo} - ${data.detalle || 'Sin descripci√≥n'}</div>
                    <div class="expediente-details">
                        <strong>üìÖ ${formatDateEs(new Date(data.fechaIngreso || data.fechaCreacion))}</strong><br>
                        <strong>C√≥digo:</strong> ${data.codigo}<br>
                        <strong>N√∫mero:</strong> ${data.numero || 'N/A'}/${data.anio || '2025'}<br>
                        <strong>Corresponde:</strong> ${data.corresponde || 'N/A'}<br>
                        <strong>Derivado a:</strong> ${data.derivado || 'N/A'}<br>
                        <strong>D√≠as de tr√°mite:</strong> ${data.diasTramite || 0} d√≠as
                        ${data.observacion ? '<br><strong>Observaci√≥n:</strong> ' + data.observacion : ''}
                    </div>
                    ${!isFinal ? `
                    <div class="item-actions">
                        <label style="display:flex;align-items:center;gap:0.4rem;color:var(--gray-700);">
                            <input type="checkbox" class="select-checkbox" /> Seleccionar
                        </label>
                        <select class="inline-select" aria-label="Mover a" disabled>
                            <option value="">Enviar a...</option>
                            <option value="ejecutivo">Parque Automotor Ejecutivo</option>
                            <option value="compra">Compras</option>
                            <option value="hospitales">Hospitales</option>
                            <option value="otros">Otros</option>
                        </select>
                        <button class="send-btn" disabled>Enviar</button>
                        <button class="finalize-btn" onclick="finalizeExpediente('${data.codigo}', this)" title="Finalizar expediente">‚úÖ Finalizar</button>
                        <button class="edit-btn" onclick="editExpediente('${data.codigo}')" title="Modificar expediente">‚úèÔ∏è</button>
                        <button class="delete-btn" onclick="deleteExpedienteCreado('${data.codigo}')" title="Eliminar expediente">üóëÔ∏è</button>
                    </div>
                    ` : `
                    <div class="item-actions" style="opacity: 0.6; pointer-events: none;">
                    </div>
                    `}
                `;
                
                attachExpedienteItemHandlers(item, data);
                expedientesCreados.insertBefore(item, emptyExpedientes);
            });
        }

        // Funci√≥n para renderizar expedientes filtrados en TODAS las secciones
        async function renderExpedientesFiltradosGlobal(expedientesFiltrados) {
            console.log('üé® Renderizando expedientes filtrados en todas las secciones...');
            console.log('üìä Expedientes a renderizar:', expedientesFiltrados.length);
            
            try {
                // Crear un mapa de c√≥digos filtrados para verificaci√≥n r√°pida
                const codigosFiltrados = new Set(expedientesFiltrados.map(exp => exp.codigo));
                console.log('üîç C√≥digos filtrados:', Array.from(codigosFiltrados));
                
                // Limpiar todas las secciones primero
                await limpiarTodasLasSecciones();
                
                // Renderizar cada secci√≥n con solo los expedientes filtrados
                await renderSeccionConFiltroSimple('creados', codigosFiltrados);
                await renderSeccionConFiltroSimple('ejecutivo', codigosFiltrados);
                await renderSeccionConFiltroSimple('compras', codigosFiltrados);
                await renderSeccionConFiltroSimple('hospitales', codigosFiltrados);
                await renderSeccionConFiltroSimple('otros', codigosFiltrados);
                
                console.log('‚úÖ Renderizado filtrado completado en todas las secciones');
                
            } catch (error) {
                console.error('‚ùå Error en renderExpedientesFiltradosGlobal:', error);
                alert('‚ùå Error al mostrar resultados de b√∫squeda');
            }
        }

        // Funci√≥n auxiliar para limpiar todas las secciones
        async function limpiarTodasLasSecciones() {
            const secciones = ['creados', 'ejecutivo', 'compras', 'hospitales', 'otros'];
            
            for (const seccion of secciones) {
                const sectionElement = document.getElementById(seccion + 'Section') || document.getElementById('expedientes' + seccion.charAt(0).toUpperCase() + seccion.slice(1));
                if (sectionElement) {
                    const itemsToRemove = sectionElement.querySelectorAll('.expediente-item, .executive-item, .compra-item, .hospital-item, .otros-item');
                    Array.from(itemsToRemove).forEach(n => n.remove());
                }
            }
        }

        // Funci√≥n auxiliar para renderizar una secci√≥n con filtro (versi√≥n simple)
        async function renderSeccionConFiltroSimple(seccion, codigosFiltrados) {
            try {
                let expedientes = [];
                let sectionElement = null;
                let emptyElement = null;
                
                // Obtener expedientes de la secci√≥n correspondiente
                switch(seccion) {
                    case 'creados':
                        expedientes = await getStoredCreated();
                        sectionElement = document.getElementById('expedientesCreados');
                        emptyElement = document.getElementById('emptyExpedientes');
                        break;
                    case 'ejecutivo':
                        expedientes = await getStoredEjecutivo();
                        sectionElement = document.getElementById('expedientesEjecutivo');
                        emptyElement = document.getElementById('emptyEjecutivo');
                        break;
                    case 'compras':
                        expedientes = await getStoredCompras();
                        sectionElement = document.getElementById('expedientesCompras');
                        emptyElement = document.getElementById('emptyCompras');
                        break;
                    case 'hospitales':
                        expedientes = await getStoredHospitales();
                        sectionElement = document.getElementById('expedientesHospitales');
                        emptyElement = document.getElementById('emptyHospitales');
                        break;
                    case 'otros':
                        expedientes = await getStoredOtros();
                        sectionElement = document.getElementById('expedientesOtros');
                        emptyElement = document.getElementById('emptyOtros');
                        break;
                }
                
                // Filtrar expedientes que est√°n en la lista de filtrados
                const expedientesFiltradosSeccion = expedientes.filter(exp => codigosFiltrados.has(exp.codigo));
                console.log(`üìä ${seccion}: ${expedientesFiltradosSeccion.length} expedientes filtrados de ${expedientes.length} totales`);
                
                if (expedientesFiltradosSeccion.length > 0) {
                    // Ocultar estado vac√≠o
                    if (emptyElement) {
                        emptyElement.style.display = 'none';
                    }
                    
                    // Renderizar expedientes filtrados directamente en la secci√≥n
                    expedientesFiltradosSeccion.forEach((data, index) => {
                        const item = document.createElement('div');
                        item.className = seccion === 'creados' ? 'expediente-item' : 
                                        seccion === 'ejecutivo' ? 'executive-item' :
                                        seccion === 'compras' ? 'compra-item' :
                                        seccion === 'hospitales' ? 'hospital-item' : 'otros-item';
                        
                        const isFinal = data.estado === 'FINALIZADO';
                        
                        // Construir HTML seg√∫n la secci√≥n
                        if (seccion === 'creados') {
                            item.innerHTML = `
                                <div class="status-badge ${isFinal ? 'status-finalizado' : 'status-pendiente'}">${isFinal ? 'FINALIZADO' : 'PENDIENTE'}</div>
                                <div class="expediente-header">${data.codigo} - ${data.detalle || 'Sin descripci√≥n'}</div>
                                <div class="expediente-details">
                                    <strong>üìÖ ${formatDateEs(new Date(data.fechaIngreso || new Date()))}</strong><br>
                                    <strong>C√≥digo:</strong> ${data.codigo}<br>
                                    <strong>N√∫mero:</strong> ${data.numero || 'N/A'}/${data.anio || '2025'}<br>
                                    <strong>Corresponde:</strong> ${data.corresponde || 'N/A'}<br>
                                    <strong>Derivado a:</strong> ${data.derivado || 'N/A'}<br>
                                    <strong>D√≠as de tr√°mite:</strong> ${data.diasTramite || 0} d√≠as
                                    ${data.observacion ? '<br><strong>Observaci√≥n:</strong> ' + data.observacion : ''}
                                </div>
                    ${!isFinal ? `
                    <div class="item-actions">
                        <label style="display:flex;align-items:center;gap:0.4rem;color:var(--gray-700);">
                            <input type="checkbox" class="select-checkbox" /> Seleccionar
                        </label>
                        <select class="inline-select" aria-label="Mover a" disabled>
                            <option value="">Enviar a...</option>
                            <option value="ejecutivo">Parque Automotor Ejecutivo</option>
                            <option value="compra">Compras</option>
                            <option value="hospitales">Hospitales</option>
                            <option value="otros">Otros</option>
                        </select>
                        <button class="send-btn" disabled>Enviar</button>
                        ${canUserModifyExpediente(data) ? `
                        <button class="finalize-btn" onclick="finalizeExpediente('${data.codigo}', this)" title="Finalizar expediente">‚úÖ Finalizar</button>
                        <button class="edit-btn" onclick="editExpediente('${data.codigo}')" title="Modificar expediente">‚úèÔ∏è</button>
                        <button class="delete-btn" onclick="deleteExpedienteCreado('${data.codigo}')" title="Eliminar expediente">üóëÔ∏è</button>
                        ` : `
                        <span style="color: var(--gray-500); font-size: 0.8rem; padding: 0.5rem; background: var(--gray-100); border-radius: 0.25rem;">
                            üîí Solo ${data.creadoPorNombre || 'el creador'} puede modificar
                        </span>
                        `}
                    </div>
                    ` : `
                    <div class="item-actions" style="opacity: 0.6; pointer-events: none;">
                        <span style="color: var(--success); font-weight: bold;">EXPEDIENTE FINALIZADO</span>
                    </div>
                    `}
                            `;
                        } else {
                            // Para otras secciones, usar las funciones de construcci√≥n existentes
                            if (seccion === 'ejecutivo') {
                                item.innerHTML = buildExecutiveItemSimple(data);
                            } else if (seccion === 'compras') {
                                item.innerHTML = buildCompraItemSimple(data);
                            } else if (seccion === 'hospitales') {
                                item.innerHTML = buildHospitalItemSimple(data);
                            } else if (seccion === 'otros') {
                                item.innerHTML = buildOtrosItemSimple(data);
                            }
                        }
                        
                        // Agregar al DOM
                        if (sectionElement) {
                            sectionElement.appendChild(item);
                        }
                        
                        // Agregar handlers si no est√° finalizado
                        if (!isFinal) {
                            attachExpedienteItemHandlers(item, data);
                        }
                    });
                } else {
                    // Mostrar estado vac√≠o
                    if (emptyElement) {
                        emptyElement.style.display = 'block';
                    }
                }
                
            } catch (error) {
                console.error(`‚ùå Error renderizando secci√≥n ${seccion}:`, error);
            }
        }

        // Funci√≥n auxiliar para renderizar una secci√≥n con filtro (versi√≥n original - mantener para compatibilidad)
        async function renderSeccionConFiltro(seccion, codigosFiltrados) {
            try {
                let expedientes = [];
                let renderFunction = null;
                
                // Obtener expedientes de la secci√≥n correspondiente
                switch(seccion) {
                    case 'creados':
                        expedientes = await getStoredCreated();
                        renderFunction = renderAllInCreated;
                        break;
                    case 'ejecutivo':
                        expedientes = await getStoredEjecutivo();
                        renderFunction = renderStoredEjecutivo;
                        break;
                    case 'compras':
                        expedientes = await getStoredCompras();
                        renderFunction = renderStoredCompras;
                        break;
                    case 'hospitales':
                        expedientes = await getStoredHospitales();
                        renderFunction = renderStoredHospitales;
                        break;
                    case 'otros':
                        expedientes = await getStoredOtros();
                        renderFunction = renderStoredOtros;
                        break;
                }
                
                // Filtrar expedientes que est√°n en la lista de filtrados
                const expedientesFiltradosSeccion = expedientes.filter(exp => codigosFiltrados.has(exp.codigo));
                console.log(`üìä ${seccion}: ${expedientesFiltradosSeccion.length} expedientes filtrados de ${expedientes.length} totales`);
                
                if (expedientesFiltradosSeccion.length > 0) {
                    // Temporalmente reemplazar los datos de la secci√≥n con los filtrados
                    const datosOriginales = await getDatosSeccion(seccion);
                    await setDatosSeccion(seccion, expedientesFiltradosSeccion);
                    
                    // Renderizar la secci√≥n
                    await renderFunction();
                    
                    // Restaurar los datos originales
                    await setDatosSeccion(seccion, datosOriginales);
                } else {
                    // Mostrar estado vac√≠o
                    const emptyElement = document.getElementById('empty' + seccion.charAt(0).toUpperCase() + seccion.slice(1));
                    if (emptyElement) {
                        emptyElement.style.display = 'block';
                    }
                }
                
            } catch (error) {
                console.error(`‚ùå Error renderizando secci√≥n ${seccion}:`, error);
            }
        }

        // Funciones auxiliares para obtener y establecer datos de secciones
        async function getDatosSeccion(seccion) {
            switch(seccion) {
                case 'creados': return await getStoredCreated();
                case 'ejecutivo': return await getStoredEjecutivo();
                case 'compras': return await getStoredCompras();
                case 'hospitales': return await getStoredHospitales();
                case 'otros': return await getStoredOtros();
                default: return [];
            }
        }

        async function setDatosSeccion(seccion, datos) {
            switch(seccion) {
                case 'creados': return setStoredCreated(datos);
                case 'ejecutivo': return setStoredEjecutivo(datos);
                case 'compras': return setStoredCompras(datos);
                case 'hospitales': return setStoredHospitales(datos);
                case 'otros': return setStoredOtros(datos);
            }
        }

        // Funci√≥n para ver detalles de expediente finalizado
        function viewFinalizado(codigo) {
            alert(`Ver detalles del expediente finalizado: ${codigo}`);
        }

        // Funci√≥n para buscar expedientes por texto en TODAS las secciones
        async function buscarPorTextoGlobal() {
            const textoBusqueda = document.getElementById('textoBusqueda').value.trim();
            
            if (!textoBusqueda) {
                alert('Por favor ingresa una palabra o texto para buscar');
                return;
            }
            
            console.log('üîç Buscando expedientes por texto en TODAS las secciones:', textoBusqueda);
            
            // Mostrar indicador de carga
            const botonBuscar = document.querySelector('button[onclick="buscarPorTextoGlobal()"]');
            const textoOriginal = botonBuscar.textContent;
            botonBuscar.textContent = 'üîÑ BUSCANDO...';
            botonBuscar.disabled = true;
            
            try {
                // Obtener todos los expedientes de TODAS las secciones
                const todosExpedientes = [
                    ...(await getStoredCreated()),
                    ...(await getStoredEjecutivo()),
                    ...(await getStoredCompras()),
                    ...(await getStoredHospitales()),
                    ...(await getStoredOtros()),
                    ...(await getStoredFinalizados())
                ];
                
                console.log('üìä Total de expedientes en todas las secciones:', todosExpedientes.length);
                
                // Filtrar por texto (b√∫squeda insensible a may√∫sculas)
                const textoBusquedaLower = textoBusqueda.toLowerCase();
                const expedientesFiltrados = todosExpedientes.filter(exp => {
                    // Buscar en todos los campos de texto del expediente
                    const campos = [
                        exp.codigo || '',
                        exp.detalle || '',
                        exp.corresponde || '',
                        exp.derivado || '',
                        exp.observacion || '',
                        exp.numero || '',
                        exp.anio || '',
                        exp.tipo || ''
                    ];
                    
                    return campos.some(campo => 
                        campo.toLowerCase().includes(textoBusquedaLower)
                    );
                });
                
                console.log('üìä Expedientes encontrados por texto:', expedientesFiltrados.length);
                
                // Renderizar solo los expedientes filtrados en todas las secciones
                await renderExpedientesFiltradosGlobal(expedientesFiltrados);
                
                // Mostrar resumen
                const mensaje = `üîç B√∫squeda por texto completada: ${expedientesFiltrados.length} expedientes encontrados con "${textoBusqueda}"`;
                alert(mensaje);
                
            } catch (error) {
                console.error('‚ùå Error en b√∫squeda por texto:', error);
                alert('‚ùå Error al buscar expedientes por texto. Por favor, intente nuevamente.');
            } finally {
                // Restaurar bot√≥n
                botonBuscar.textContent = textoOriginal;
                botonBuscar.disabled = false;
            }
        }

        // Funci√≥n para b√∫squeda combinada (texto + fecha)
        async function buscarCombinado() {
            const textoBusqueda = document.getElementById('textoBusqueda').value.trim();
            const fechaDesde = document.getElementById('fechaDesde').value;
            const fechaHasta = document.getElementById('fechaHasta').value;
            
            if (!textoBusqueda && !fechaDesde && !fechaHasta) {
                alert('Por favor ingresa texto o selecciona fechas para buscar');
                return;
            }
            
            console.log('üîç B√∫squeda combinada:', { textoBusqueda, fechaDesde, fechaHasta });
            
            try {
                // Obtener todos los expedientes de TODAS las secciones
                const todosExpedientes = [
                    ...(await getStoredCreated()),
                    ...(await getStoredEjecutivo()),
                    ...(await getStoredCompras()),
                    ...(await getStoredHospitales()),
                    ...(await getStoredOtros()),
                    ...(await getStoredFinalizados())
                ];
                
                console.log('üìä Total de expedientes en todas las secciones:', todosExpedientes.length);
                
                // Filtrar por texto y fecha
                const expedientesFiltrados = todosExpedientes.filter(exp => {
                    let cumpleTexto = true;
                    let cumpleFecha = true;
                    
                    // Filtro por texto
                    if (textoBusqueda) {
                        const textoBusquedaLower = textoBusqueda.toLowerCase();
                        const campos = [
                            exp.codigo || '',
                            exp.detalle || '',
                            exp.corresponde || '',
                            exp.derivado || '',
                            exp.observacion || '',
                            exp.numero || '',
                            exp.anio || '',
                            exp.tipo || ''
                        ];
                        
                        cumpleTexto = campos.some(campo => 
                            campo.toLowerCase().includes(textoBusquedaLower)
                        );
                    }
                    
                    // Filtro por fecha
                    if (fechaDesde || fechaHasta) {
                        const fechaExpediente = new Date(exp.fechaIngreso || exp.fechaCreacion);
                        
                        if (fechaDesde && fechaHasta) {
                            const desde = new Date(fechaDesde);
                            const hasta = new Date(fechaHasta);
                            cumpleFecha = fechaExpediente >= desde && fechaExpediente <= hasta;
                        } else if (fechaDesde) {
                            const desde = new Date(fechaDesde);
                            cumpleFecha = fechaExpediente >= desde;
                        } else if (fechaHasta) {
                            const hasta = new Date(fechaHasta);
                            cumpleFecha = fechaExpediente <= hasta;
                        }
                    }
                    
                    return cumpleTexto && cumpleFecha;
                });
                
                console.log('üìä Expedientes encontrados en b√∫squeda combinada:', expedientesFiltrados.length);
                
                // Renderizar solo los expedientes filtrados en todas las secciones
                await renderExpedientesFiltradosGlobal(expedientesFiltrados);
                
                // Mostrar resumen
                let mensaje = `üîç B√∫squeda combinada completada: ${expedientesFiltrados.length} expedientes encontrados`;
                if (textoBusqueda) mensaje += ` con texto "${textoBusqueda}"`;
                if (fechaDesde && fechaHasta) mensaje += ` entre ${fechaDesde} y ${fechaHasta}`;
                else if (fechaDesde) mensaje += ` desde ${fechaDesde}`;
                else if (fechaHasta) mensaje += ` hasta ${fechaHasta}`;
                
                alert(mensaje);
                
            } catch (error) {
                console.error('‚ùå Error en b√∫squeda combinada:', error);
                alert('‚ùå Error al buscar expedientes. Por favor, intente nuevamente.');
            }
        }

        // Funci√≥n para limpiar b√∫squeda global y mostrar todos los expedientes
        async function limpiarBusquedaGlobal() {
            console.log('üóëÔ∏è Limpiando b√∫squeda global...');
            
            // Limpiar campos de b√∫squeda
            document.getElementById('textoBusqueda').value = '';
            document.getElementById('fechaDesde').value = '';
            document.getElementById('fechaHasta').value = '';
            
            // Renderizar todas las secciones con todos los expedientes
            await renderAllInCreated();
            await renderStoredEjecutivo();
            await renderStoredCompras();
            await renderStoredHospitales();
            await renderStoredOtros();
            
            // Actualizar estad√≠sticas
            updateStats();
            
            console.log('‚úÖ B√∫squeda global limpiada - mostrando todos los expedientes');
            alert('‚úÖ B√∫squeda limpiada. Mostrando todos los expedientes en todas las secciones.');
        }

        // Funci√≥n para limpiar b√∫squeda (mantener compatibilidad)
        function limpiarBusqueda() {
            document.getElementById('fechaDesde').value = '';
            document.getElementById('fechaHasta').value = '';
            renderAllInCreated();
            alert('B√∫squeda limpiada. Mostrando todos los expedientes.');
        }



        // FORZAR CREACI√ìN DE USUARIOS DE PRUEBA
        (function() {
            console.log('Creando usuarios de prueba...');
            
            // Solo crear si no existen
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            
            // Admin
            if (!users.find(u => u.username === '35477889')) {
                users.push({
                    username: '35477889',
                    dni: '35477889',
                    nombre: 'ADMIN',
                    apellido: 'SISTEMA',
                    password: '35477889',
                    role: 'ADMIN',
                    blocked: false
                });
                console.log('‚úÖ Admin creado');
            }
            
            // Mesa de Entrada
            if (!users.find(u => u.username === '12345678')) {
                users.push({
                    username: '12345678',
                    dni: '12345678',
                    nombre: 'MESA',
                    apellido: 'ENTRADA',
                    password: '12345678',
                    role: 'MESA_DE_ENTRADA',
                    blocked: false
                });
                console.log('‚úÖ Mesa de Entrada creado');
            }
            
            // Personal
            if (!users.find(u => u.username === '87654321')) {
                users.push({
                    username: '87654321',
                    dni: '87654321',
                    nombre: 'PERSONAL',
                    apellido: 'TEST',
                    password: '87654321',
                    role: 'PERSONAL',
                    blocked: false
                });
                console.log('‚úÖ Personal creado');
            }
            
            localStorage.setItem('users', JSON.stringify(users));
            console.log('üë• Usuarios disponibles:', users.map(u => `${u.username} (${u.role})`));
            
            // Iniciar watcher autom√°tico de expedientes
            startExpedienteWatcher();
        })();
    </script>
</body>
</html>


