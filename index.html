<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Expediente - Parque Automotor</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-blue: #1e40af;
            --primary-blue-light: #3b82f6;
            --primary-blue-dark: #1e3a8a;
            --accent-blue: #60a5fa;
            --blue-50: #eff6ff;
            --blue-100: #dbeafe;
            --blue-200: #bfdbfe;
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e1;
            --gray-400: #94a3b8;
            --gray-500: #64748b;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1e293b;
            --gray-900: #0f172a;
            --success: #10b981;
            --success-light: #d1fae5;
            --warning: #f59e0b;
            --warning-light: #fef3c7;
            --danger: #ef4444;
            --danger-light: #fee2e2;
            --white: #ffffff;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            --border-radius-sm: 0.375rem;
            --border-radius: 0.5rem;
            --border-radius-md: 0.75rem;
            --border-radius-lg: 1rem;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-blue-dark) 50%, var(--primary-blue) 100%);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            min-height: 100vh;
            padding: 2rem;
            position: relative;
            overflow-x: auto;
            text-transform: uppercase;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml,<svg width="60" height="60" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd"><g fill="%23ffffff" fill-opacity="0.02"><circle cx="30" cy="30" r="1"/></g></g></svg>');
            z-index: -1;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 3rem;
            position: relative;
        }

        .header::after {
            content: '';
            position: absolute;
            bottom: -1rem;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--accent-blue), transparent);
            border-radius: 2px;
        }

        .header h1 {
            font-size: 3rem;
            font-weight: 800;
            margin-bottom: 0.75rem;
            letter-spacing: -0.02em;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            background: linear-gradient(135deg, #ffffff 0%, var(--blue-200) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            font-size: 1.25rem;
            opacity: 0.95;
            font-weight: 400;
            letter-spacing: 0.025em;
        }

        .main-card {
            background: var(--white);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-xl);
            margin-bottom: 2.5rem;
            overflow: hidden;
            border: 1px solid var(--blue-100);
            backdrop-filter: blur(10px);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .main-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 25px 50px -12px rgba(30, 64, 175, 0.25);
        }

        .card-header {
            padding: 2rem;
            background: linear-gradient(135deg, var(--blue-50) 0%, var(--blue-100) 100%);
            border-bottom: 1px solid var(--blue-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            overflow: hidden;
        }

        .card-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, var(--primary-blue), var(--accent-blue), var(--primary-blue));
        }

        .card-header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .card-header h2 {
            color: var(--gray-800);
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .icon-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-blue-light));
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-md);
        }

        .icon {
            width: 24px;
            height: 24px;
            fill: white;
        }

        .add-btn {
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-blue-light));
            color: white;
            border: none;
            width: 48px;
            height: 48px;
            border-radius: var(--border-radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
        }

        .add-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .add-btn:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: var(--shadow-lg);
        }

        .add-btn:hover::before {
            left: 100%;
        }

        .add-btn:active {
            transform: translateY(0) scale(0.98);
        }

        .card-content {
            padding: 2rem;
            color: var(--gray-600);
            font-size: 1rem;
            line-height: 1.6;
            background: linear-gradient(135deg, var(--white) 0%, var(--gray-50) 100%);
        }

        /* FILTRO GLOBAL */
        .filter-bar {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        .filter-btn {
            padding: 0.5rem 0.9rem;
            border: 1px solid var(--gray-300);
            border-radius: 0.5rem;
            background: var(--white);
            color: var(--gray-700);
            cursor: pointer;
            font-weight: 600;
        }
        .filter-btn.active {
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-blue-light));
            color: #fff;
            border-color: transparent;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .section-card {
            background: var(--white);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            border: 1px solid var(--gray-200);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .section-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-blue), var(--accent-blue));
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .section-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
            border-color: var(--blue-200);
        }

        .section-card:hover::before {
            transform: scaleX(1);
        }

        .section-header {
            padding: 1.5rem;
            background: linear-gradient(135deg, var(--gray-50) 0%, var(--blue-50) 100%);
            border-bottom: 1px solid var(--gray-200);
            position: relative;
        }

        .section-header h3 {
            color: var(--gray-800);
            font-size: 1.125rem;
            font-weight: 600;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .section-icon-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--primary-blue-light), var(--accent-blue));
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
        }

        .section-content {
            padding: 1.5rem;
            background: var(--white);
        }

        .expediente-item {
            background: linear-gradient(135deg, var(--blue-50) 0%, var(--white) 100%);
            border: 1px solid var(--blue-200);
            border-radius: var(--border-radius-md);
            padding: 1.5rem;
            margin-bottom: 1rem;
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }

        .expediente-item:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
            border-color: var(--primary-blue-light);
        }

        .expediente-item:last-child {
            margin-bottom: 0;
        }

        .expediente-header {
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 0.75rem;
            font-size: 0.95rem;
            line-height: 1.4;
            padding-right: 120px;
        }

        .expediente-details {
            font-size: 0.875rem;
            color: var(--gray-600);
            line-height: 1.5;
        }

        .expediente-details strong {
            color: var(--gray-700);
            font-weight: 600;
        }

        .status-badge {
            position: absolute;
            top: 1rem;
            right: 1rem;
            padding: 0.375rem 0.75rem;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            box-shadow: var(--shadow-sm);
        }

        .status-finalizado {
            background: var(--success-light);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .status-pendiente {
            background: var(--warning-light);
            color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.2);
        }

        .status-alert {
            background: var(--danger-light);
            color: var(--danger);
            border: 1px solid rgba(239, 68, 68, 0.25);
        }

        .empty-state {
            text-align: center;
            color: var(--gray-400);
            padding: 3rem 1.5rem;
        }

        .empty-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.6;
        }

        .empty-state p {
            font-size: 1rem;
            font-weight: 500;
        }

        .shopping-preview {
            background: linear-gradient(135deg, var(--blue-50) 0%, var(--white) 100%);
            border: 1px solid var(--blue-200);
            border-radius: var(--border-radius-md);
            padding: 2rem;
            text-align: center;
            color: var(--gray-600);
            transition: all 0.3s ease;
        }

        .shopping-preview:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .shopping-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            opacity: 0.7;
        }

        .executive-item {
            background: linear-gradient(135deg, #fef7ed 0%, var(--white) 100%);
            border: 1px solid #fed7aa;
            border-radius: var(--border-radius-md);
            padding: 1.5rem;
            margin-bottom: 1rem;
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }

        .executive-item:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
            border-color: var(--warning);
        }

        .executive-item:last-child {
            margin-bottom: 0;
        }

        .delete-btn {
            background: var(--white);
            border: 1px solid var(--danger-light);
            color: var(--danger);
            cursor: pointer;
            font-size: 16px;
            width: 32px;
            height: 32px;
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            box-shadow: var(--shadow-sm);
        }

        .delete-btn:hover {
            background: var(--danger-light);
            border-color: var(--danger);
            transform: scale(1.1);
        }

        .delete-btn:active {
            transform: scale(0.95);
        }

        /* Mejoras para dispositivos móviles */
        @media (max-width: 768px) {
            .item-actions {
                position: static !important;
                margin-top: 0.5rem;
                display: flex;
                gap: 0.5rem;
                flex-wrap: wrap;
                justify-content: center;
            }

            .item-actions button {
                flex: 1;
                min-width: 0;
                font-size: 0.8rem;
                padding: 0.4rem 0.6rem;
                touch-action: manipulation;
            }

            .expediente-item,
            .executive-item {
                position: relative;
                padding-bottom: 3rem;
            }

            .expediente-header {
                padding-right: 0;
                margin-bottom: 0.5rem;
            }

            .expediente-details {
                margin-bottom: 0.5rem;
            }

            /* Mejorar la legibilidad en móviles */
            .expediente-item:hover,
            .executive-item:hover {
                transform: none;
            }

            .expediente-item:active,
            .executive-item:active {
                transform: scale(0.98);
            }

            /* Asegurar que los botones sean fáciles de tocar */
            button {
                min-height: 44px;
                min-width: 44px;
            }

            .delete-btn,
            .edit-btn,
            .send-btn,
            .finalize-btn {
                min-height: 36px;
                font-size: 0.8rem;
            }
        }

        .edit-btn {
            padding: 0.45rem 0.8rem;
            border-radius: 0.5rem;
            border: 1px solid var(--warning);
            background: var(--white);
            color: var(--warning);
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s ease;
        }

        .edit-btn:hover {
            background: var(--warning);
            color: var(--white);
            transform: scale(1.05);
        }

        .finalize-btn {
            padding: 0.45rem 0.8rem;
            border-radius: 0.5rem;
            border: 1px solid var(--success);
            background: var(--white);
            color: var(--success);
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .finalize-btn:hover {
            background: var(--success);
            color: var(--white);
            transform: scale(1.05);
        }

        /* Toolbar de selección y envío */
        .item-actions {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        .inline-select {
            padding: 0.45rem 0.6rem;
            border: 1px solid var(--gray-300);
            border-radius: 0.5rem;
            font-size: 0.85rem;
            background: var(--white);
            color: var(--gray-700);
        }
        .send-btn, .send-back-btn {
            padding: 0.45rem 0.8rem;
            border-radius: 0.5rem;
            border: none;
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-blue-light));
            color: #fff;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .stats-bar {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--gray-200);
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: var(--gray-50);
            border-radius: var(--border-radius);
            font-size: 0.875rem;
            color: var(--gray-600);
        }

        .stat-number {
            font-weight: 600;
            color: var(--primary-blue);
        }

        /* Form Page Styles */
        .form-page {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-blue-dark) 50%, var(--primary-blue) 100%);
            z-index: 1000;
            overflow-y: auto;
            padding: 2rem;
        }

        .form-page.active {
            display: flex;
            flex-direction: column;
        }

        .form-container {
            max-width: 800px;
            margin: 0 auto;
            background: var(--white);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-xl);
            overflow: hidden;
            border: 1px solid var(--blue-100);
        }

        .form-header {
            padding: 1.5rem;
            background: linear-gradient(135deg, var(--blue-50) 0%, var(--blue-100) 100%);
            border-bottom: 1px solid var(--blue-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .form-header h2 {
            color: var(--gray-800);
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .close-btn {
            background: var(--white);
            border: 1px solid var(--gray-300);
            color: var(--gray-600);
            cursor: pointer;
            font-size: 16px;
            width: 36px;
            height: 36px;
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .close-btn:hover {
            background: var(--gray-100);
            color: var(--gray-800);
        }

        .form-content {
            padding: 1.5rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.4rem;
            color: var(--gray-700);
            font-weight: 500;
            font-size: 0.85rem;
        }

        .form-label .required {
            color: var(--danger);
        }

        .form-input, .form-select, .form-textarea {
            padding: 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: var(--border-radius);
            font-size: 0.9rem;
            transition: all 0.2s ease;
            outline: none;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--gray-200);
        }

        .btn {
            padding: 0.75rem 1.25rem;
            border-radius: var(--border-radius);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-secondary {
            background: var(--white);
            color: var(--gray-700);
            border: 1px solid var(--gray-300);
        }

        .btn-secondary:hover {
            background: var(--gray-50);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-blue-light));
            color: white;
            box-shadow: var(--shadow-sm);
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        @media (max-width: 1024px) {
            .grid-container {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 0.5rem;
                font-size: 14px;
            }
            
            .header {
                margin-bottom: 1rem;
                padding: 0.75rem;
                text-align: center;
            }
            
            .header h1 {
                font-size: 1.5rem;
                line-height: 1.2;
            }

            .header p {
                font-size: 0.9rem;
                margin-top: 0.25rem;
            }
            
            .main-card {
                margin-bottom: 0.75rem;
            }
            
            .card-header {
                padding: 0.75rem;
                flex-direction: column;
                align-items: stretch;
                gap: 0.5rem;
            }

            .card-header-left {
                justify-content: center;
                flex-wrap: wrap;
                text-align: center;
            }

            .card-content {
                padding: 0.75rem;
            }

            .section-content {
                padding: 0.5rem;
            }

            .expediente-item,
            .executive-item {
                padding: 0.75rem;
                margin-bottom: 0.5rem;
                border-radius: 8px;
            }

            .expediente-header {
                padding-right: 0;
                font-size: 0.8rem;
                margin-bottom: 0.5rem;
                font-weight: 600;
            }

            .expediente-details {
                font-size: 0.75rem;
                margin-bottom: 0.75rem;
                line-height: 1.4;
            }

            .item-actions {
                position: static !important;
                margin-top: 0.5rem;
                display: flex;
                gap: 0.25rem;
                flex-wrap: wrap;
                justify-content: center;
            }

            .item-actions button {
                flex: 1;
                min-width: 60px;
                font-size: 0.7rem;
                padding: 0.4rem 0.5rem;
                border-radius: 4px;
                min-height: 36px;
                touch-action: manipulation;
            }

            .stats-bar {
                flex-wrap: wrap;
                gap: 0.25rem;
                justify-content: center;
            }

            .stats-item {
                font-size: 0.75rem;
                padding: 0.4rem;
                min-width: 80px;
                text-align: center;
            }

            .form-grid {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }

            .form-content {
                padding: 0.75rem;
            }

            .form-group {
                margin-bottom: 0.5rem;
            }

            .form-group label {
                font-size: 0.8rem;
                margin-bottom: 0.25rem;
            }

            .form-group input,
            .form-group select,
            .form-group textarea {
                font-size: 0.8rem;
                padding: 0.5rem;
                width: 100%;
            }

            .btn {
                font-size: 0.8rem;
                padding: 0.5rem 0.75rem;
                min-height: 40px;
                touch-action: manipulation;
            }

            .grid-container {
                gap: 0.75rem;
                grid-template-columns: 1fr;
            }

            .section-title {
                font-size: 1rem;
                margin-bottom: 0.5rem;
                text-align: center;
            }

            /* Mejoras específicas para móviles */
            .card {
                border-radius: 8px;
                margin-bottom: 0.5rem;
            }

            .status-badge {
                font-size: 0.65rem;
                padding: 0.2rem 0.4rem;
            }

            /* Botones más grandes para touch */
            button, .btn, input[type="button"], input[type="submit"] {
                min-height: 44px;
                touch-action: manipulation;
            }

            /* Selects más grandes */
            select {
                min-height: 44px;
                font-size: 16px; /* Evita zoom en iOS */
            }

            /* Mejorar legibilidad en pantallas pequeñas */
            .expediente-details strong {
                display: inline-block;
                min-width: 80px;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 0.5rem;
                font-size: 13px;
            }

            .header {
                margin-bottom: 1rem;
                padding: 0.75rem;
            }

            .header h1 {
                font-size: 1.5rem;
                line-height: 1.1;
            }

            .header p {
                font-size: 0.9rem;
            }

            .main-card {
                margin-bottom: 1rem;
            }

            .card-header {
                padding: 0.75rem;
            }

            .card-content {
                padding: 0.75rem;
            }

            .section-content {
                padding: 0.5rem;
            }

            .expediente-item,
            .executive-item {
                padding: 0.5rem;
                margin-bottom: 0.5rem;
            }

            .expediente-header {
                font-size: 0.8rem;
                margin-bottom: 0.25rem;
            }

            .expediente-details {
                font-size: 0.75rem;
                margin-bottom: 0.25rem;
            }

            .item-actions {
                margin-top: 0.25rem;
                gap: 0.25rem;
            }

            .item-actions button {
                font-size: 0.75rem;
                padding: 0.3rem 0.4rem;
            }

            .stats-bar {
                gap: 0.25rem;
            }

            .stats-item {
                font-size: 0.75rem;
                padding: 0.4rem;
            }

            .form-content {
                padding: 0.75rem;
            }

            .form-group {
                margin-bottom: 0.5rem;
            }

            .form-group label {
                font-size: 0.8rem;
            }

            .form-group input,
            .form-group select,
            .form-group textarea {
                font-size: 0.8rem;
                padding: 0.4rem;
            }

            .btn {
                font-size: 0.8rem;
                padding: 0.4rem 0.8rem;
            }

            .grid-container {
                gap: 0.75rem;
            }

            .section-title {
                font-size: 1rem;
                margin-bottom: 0.5rem;
            }

            .status-badge {
                font-size: 0.7rem;
                padding: 0.2rem 0.4rem;
            }
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--gray-100);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-blue-light);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-blue);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .loading {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='0.9em' font-size='90'%3E%F0%9F%9A%97%3C/text%3E%3C/svg%3E">
</head>
<body>
    <!-- LOGIN PAGE -->
    <div class="form-page active" id="loginPage">
        <div class="form-container" style="max-width: 500px;">
            <div class="form-header">
                <h2>
                    <div class="icon-wrapper" style="width: 40px; height: 40px;">
                        <svg class="icon" viewBox="0 0 24 24" style="width: 20px; height: 20px;">
                            <path d="M12 2C13.1 2 14 2.9 14 4C14 5.1 13.1 6 12 6C10.9 6 10 5.1 10 4C10 2.9 10.9 2 12 2ZM21 9V7L15 1H5C3.89 1 3 1.89 3 3V21C3 22.11 3.89 23 5 23H11V21H5V3H13V9H21Z"/>
                        </svg>
                    </div>
                    INICIAR SESIÓN
                </h2>
            </div>
            
            <div class="form-content">
                <form id="loginForm">
                    <div class="form-group">
                        <label class="form-label">🆔 DNI (USUARIO) <span class="required">*</span></label>
                        <input type="text" name="username" class="form-input" placeholder="INGRESE SU DNI" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">🔒 CONTRASEÑA <span class="required">*</span></label>
                        <input type="password" name="password" class="form-input" placeholder="INGRESE SU CONTRASEÑA" required>
                    </div>
                    <div class="form-actions" style="flex-direction: column; gap: 1rem;">
                        <button type="submit" class="btn btn-primary" style="width: 100%;">🚀 INGRESAR AL SISTEMA</button>
                        <div style="text-align: center; color: var(--gray-600);">
                            ¿NO TIENES CUENTA? 
                            <a href="#" onclick="showRegister()" style="color: var(--primary-blue); font-weight: 600; text-decoration: none;">REGÍSTRATE AQUÍ</a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- REGISTER PAGE -->
    <div class="form-page" id="registerPage">
        <div class="form-container" style="max-width: 600px;">
            <div class="form-header">
                <h2>
                    <div class="icon-wrapper" style="width: 40px; height: 40px;">
                        <svg class="icon" viewBox="0 0 24 24" style="width: 20px; height: 20px;">
                            <path d="M15 12C17.21 12 19 10.21 19 8S17.21 4 15 4 11 5.79 11 8 12.79 12 15 12M6 10V7H4V10H1V12H4V15H6V12H9V10M15 14C12.33 14 7 15.34 7 18V20H23V18C23 15.34 17.67 14 15 14Z"/>
                        </svg>
                    </div>
                    REGISTRO DE USUARIO
                </h2>
                <button class="close-btn" onclick="showLogin()" title="VOLVER AL LOGIN">←</button>
            </div>
            
            <div class="form-content">
                <form id="registerForm">
                    <div class="form-group">
                        <label class="form-label">🆔 DNI <span class="required">*</span></label>
                        <input type="text" name="dni" class="form-input" placeholder="EJ: 12345678" required pattern="^\d{7,9}$" title="INGRESE SOLO NÚMEROS (7 A 9 DÍGITOS)">
                    </div>

                    <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                        <div class="form-group">
                            <label class="form-label">👤 NOMBRE COMPLETO <span class="required">*</span></label>
                            <input type="text" name="nombre" class="form-input" placeholder="EJ: JUAN CARLOS" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">📝 APELLIDO <span class="required">*</span></label>
                            <input type="text" name="apellido" class="form-input" placeholder="EJ: GONZÁLEZ" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">👤 USUARIO (AUTOCOMPLETADO CON DNI)</label>
                        <input type="text" name="username" class="form-input" placeholder="SE AUTOCOMPLETA CON DNI" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">🔒 CONTRASEÑA <span class="required">*</span></label>
                        <input type="password" name="password" class="form-input" placeholder="MÍNIMO 6 CARACTERES" required minlength="6">
                    </div>
                    <div class="form-group">
                        <label class="form-label">🔒 REPETIR CONTRASEÑA <span class="required">*</span></label>
                        <input type="password" name="confirmPassword" class="form-input" placeholder="CONFIRME SU CONTRASEÑA" required minlength="6">
                    </div>
                    <div class="form-actions" style="flex-direction: column; gap: 1rem;">
                        <button type="submit" class="btn btn-primary" style="width: 100%;">✅ REGISTRAR USUARIO</button>
                        <div style="text-align: center; color: var(--gray-600);">
                            ¿YA TIENES CUENTA? 
                            <a href="#" onclick="showLogin()" style="color: var(--primary-blue); font-weight: 600; text-decoration: none;">INICIA SESIÓN AQUÍ</a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="container" id="mainPage" style="display: none;">
        <div class="header">
            <h1>CONTROL DE EXPEDIENTE</h1>
            <h1 style="margin-top: -0.5rem;">PARQUE AUTOMOTOR</h1>
            <p>Sistema integral de gestión de expedientes automotores</p>
            <div style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 0.5rem 1rem; border-radius: 8px; margin-top: 1rem; text-align: center; font-weight: 600; font-size: 0.9rem;">
                🗄️ BASE DE DATOS ÚNICA CENTRALIZADA - Una sola fuente de expedientes para todos los usuarios
            </div>
            <div style="position: absolute; top: 1rem; right: 1rem; display:flex; gap:.5rem;">
                <button class="btn btn-secondary" onclick="window.location.href='/configuracion/'" style="padding: 0.5rem 1rem;">⚙️ CONFIGURACIÓN</button>
                <button class="btn btn-secondary" onclick="logout()" style="padding: 0.5rem 1rem;">🚪 CERRAR SESIÓN</button>
            </div>
        </div>

        <div class="main-card">
            <div class="card-header">
                <div class="card-header-left">
                    <div class="icon-wrapper">
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
                        </svg>
                    </div>
                    <h2>Mesa de Entrada</h2>
                </div>
                <button class="add-btn" onclick="window.location.href='/nuevo-expediente/'" title="Agregar nuevo expediente">+</button>
            </div>
            <div class="card-content">
                Administre y controle todos los expedientes del parque automotor desde un panel centralizado con herramientas avanzadas de seguimiento y gestión profesional.
                
                <div class="stats-bar">
                    <div class="stat-item">
                        <span>📊</span>
                        <span>Total: <span class="stat-number" id="totalExpedientes">1</span></span>
                    </div>
                    <div class="stat-item">
                        <span>✅</span>
                        <span>Finalizados: <span class="stat-number" id="finalizados">1</span></span>
                    </div>
                    <div class="stat-item">
                        <span>⏳</span>
                        <span>Pendientes: <span class="stat-number" id="pendientes">0</span></span>
                    </div>
                </div>

                <div class="filter-bar">
                    <span style="color:var(--gray-700); font-weight:600;">FILTRAR:</span>
                    <button class="filter-btn" data-filter="TODOS">TODOS</button>
                    <button class="filter-btn" data-filter="PENDIENTE">PENDIENTE</button>
                    <button class="filter-btn" data-filter="CONFIRMADOS">CONFIRMADOS</button>
                </div>


            </div>
        </div>

        <div class="grid-container">
            <div class="section-card">
                <div class="section-header">
                    <h3>
                        <div class="section-icon-wrapper">
                            <svg class="icon" viewBox="0 0 24 24" style="width: 20px; height: 20px;">
                                <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 2 2h8c1.1 0 2-.9 2-2V8l-6-6zm4 18H6V4h7v5h5v11z"/>
                            </svg>
                        </div>
                        Expedientes Creados
                    </h3>

                </div>
                
                <!-- Barra de búsqueda por fecha -->
                <div class="search-bar" style="margin-bottom: 1rem; padding: 0.75rem; background: var(--gray-50); border-radius: 0.5rem; border: 1px solid var(--gray-200);">
                    <div style="display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <label style="font-size: 0.85rem; font-weight: 600; color: var(--gray-700);">DESDE:</label>
                            <input type="date" id="fechaDesde" class="input" style="padding: 0.4rem; font-size: 0.85rem; border: 1px solid var(--gray-300); border-radius: 0.375rem;" />
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <label style="font-size: 0.85rem; font-weight: 600; color: var(--gray-700);">HASTA:</label>
                            <input type="date" id="fechaHasta" class="input" style="padding: 0.4rem; font-size: 0.85rem; border: 1px solid var(--gray-300); border-radius: 0.375rem;" />
                        </div>
                        <button onclick="buscarPorFecha()" class="btn" style="background: var(--primary-blue); color: white; border: none; padding: 0.4rem 0.8rem; border-radius: 0.375rem; font-size: 0.85rem; font-weight: 600; cursor: pointer;">🔍 BUSCAR</button>
                    </div>
                </div>
                
                <div class="section-content" id="expedientesCreados">
                    <div class="empty-state" id="emptyExpedientes" style="display: block;">
                        <div class="empty-icon">📄</div>
                        <p>No hay expedientes creados</p>
                    </div>
                </div>
            </div>

            <div class="section-card">
                <div class="section-header">
                    <h3>
                        <div class="section-icon-wrapper">
                            <svg class="icon" viewBox="0 0 24 24" style="width: 20px; height: 20px;">
                                <path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.22.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zM5 11l1.5-4.5h11L19 11H5z"/>
                            </svg>
                        </div>
                        Parque Automotor Ejecutivo
                    </h3>
                </div>
                <div class="section-content" id="executiveSection">
                    <div class="executive-item" data-default="true">
                        <button class="delete-btn" onclick="deleteExecutive(this)" title="Eliminar expediente">🗑️</button>
                        <div class="status-badge status-pendiente">PENDIENTE</div>
                        <div class="expediente-header">SDA-001 - Solicitud de documentación adicional</div>
                        <div class="expediente-details">
                            <strong>📅 05/08/2025</strong><br>
                            <strong>Código:</strong> SDA-001<br>
                            <strong>Número:</strong> 222/2025<br>
                            <strong>Corresponde:</strong> Personal<br>
                            <strong>Derivado a:</strong> Área Legal<br>
                            <strong>Días de trámite:</strong> 0 días
                        </div>
                    </div>
                    <div class="empty-state" id="emptyExecutive" style="display: none;">
                        <div class="empty-icon">🚗</div>
                        <p>No hay expedientes ejecutivos</p>
                    </div>
                </div>
            </div>

            <div class="section-card">
                <div class="section-header">
                    <h3>
                        <div class="section-icon-wrapper">
                            <svg class="icon" viewBox="0 0 24 24" style="width: 20px; height: 20px;">
                                <path d="M7 18c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12L8.1 13h7.45c.75 0 1.41-.41 1.75-1.03L21.7 4H5.21l-.94-2H1zm16 16c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
                            </svg>
                        </div>
                        Centro de Compras
                    </h3>
                </div>
                <div class="section-content">
                    <div class="shopping-preview">
                        <div class="shopping-icon">🛒</div>
                        <h4 style="margin-bottom: 0.5rem; color: var(--gray-700);">Sistema de Compras Integrado</h4>
                        <p style="margin-bottom: 1rem;">Control de Expediente - Parque Automotor</p>
                        <small style="color: var(--gray-500);">📱 App.js - Módulo de gestión de compras y expedientes</small>
                        <small style="color: var(--green-600); margin-top: 0.5rem; display: block;">🗄️ BASE DE DATOS ÚNICA - Una sola fuente para todos los usuarios</small>
                        <small style="color: var(--blue-600); margin-top: 0.3rem; display: block;">🔄 FLUJO BIDIRECCIONAL - Mover expedientes entre todas las secciones + Finalizar desde cualquier lugar</small>
                        
                        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--gray-200);">
                            <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.875rem;">
                                <span style="color: var(--gray-600);">Estado del módulo:</span>
                                <span style="color: var(--success); font-weight: 600;">🟢 Activo</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ROLE PENDING PAGE -->
    <div class="form-page" id="rolePendingPage">
        <div class="form-container" style="max-width: 560px;">
            <div class="form-header">
                <h2>
                    <div class="icon-wrapper" style="width: 40px; height: 40px;">
                        <svg class="icon" viewBox="0 0 24 24" style="width: 20px; height: 20px;">
                            <path d="M12,2A10,10 0 1,0 22,12A10,10 0 0,0 12,2M11,6H13V13H11V6M11,16H13V18H11V16Z"/>
                        </svg>
                    </div>
                    ROL PENDIENTE
                </h2>
            </div>
            <div class="form-content" style="text-align:center;">
                <p style="color: var(--gray-700); margin-bottom: 1rem;">SU USUARIO AÚN NO TIENE ROL ASIGNADO.</p>
                                        <p style="color: var(--gray-600);">CONTACTE AL ADMIN PARA CONTINUAR.</p>
            </div>
        </div>
    </div>

    <!-- Form Page -->
    <div class="form-page" id="formPage">
        <div class="form-container">
            <div class="form-header">
                <h2>
                    <div class="icon-wrapper" style="width: 40px; height: 40px;">
                        <svg class="icon" viewBox="0 0 24 24" style="width: 20px; height: 20px;">
                            <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 2 2h8c1.1 0 2-.9 2-2V8l-6-6zm4 18H6V4h7v5h5v11z"/>
                        </svg>
                    </div>
                    Nuevo Expediente - Parque Automotor
                </h2>
                <button class="close-btn" onclick="closeForm()" title="Cerrar">✕</button>
            </div>
            
            <div class="form-content">
                <form id="expedienteForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">
                                # CÓDIGO DE EXPEDIENTE <span class="required">*</span>
                            </label>
                            <input type="text" name="codigo" class="form-input" placeholder="Ej: EXP-001" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                📋 NÚMERO DE EXPEDIENTE
                            </label>
                            <input type="text" name="numero" class="form-input" placeholder="Ej: 001">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                📅 AÑO
                            </label>
                            <input type="number" name="anio" class="form-input" value="2025" min="2020" max="2030">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                🏢 CORRESPONDE
                            </label>
                            <input type="text" name="corresponde" class="form-input" placeholder="Ej: Flota Ejecutiva">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                📋 TIPO DE EXPEDIENTE
                            </label>
                            <select name="tipo" class="form-select" required>
                                <option value="">Seleccionar tipo</option>
                                <option value="Combustible">Combustible</option>
                                <option value="Seguros">Seguros</option>
                                <option value="Personal">Personal</option>
                                <option value="Reparacion">Reparación</option>
                                <option value="Choferes">Choferes</option>
                                <option value="Patrimonio">Patrimonio</option>
                                <option value="Comisiones">Comisiones</option>
                                <option value="Otros">Otros</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                👤 DERIVADO A PERSONA
                            </label>
                            <input type="text" name="derivado" class="form-input" placeholder="Ej: Juan Pérez">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                📅 FECHA DE INGRESO
                            </label>
                            <input type="date" name="fechaIngreso" class="form-input" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                📅 FECHA DE DERIVACIÓN
                            </label>
                            <input type="date" name="fechaDerivacion" class="form-input">
                        </div>
                        
                        <div class="form-group full-width">
                            <label class="form-label">
                                📝 DETALLE
                            </label>
                            <textarea name="detalle" class="form-textarea" placeholder="Descripción detallada del expediente"></textarea>
                        </div>
                        
                        <div class="form-group full-width">
                            <label class="form-label">
                                💭 OBSERVACIÓN
                            </label>
                            <textarea name="observacion" class="form-textarea" placeholder="Observaciones adicionales del expediente"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                ⏳ DÍAS DE TRÁMITE
                            </label>
                            <input type="number" name="diasTramite" class="form-input" value="0" min="0" readonly style="background-color: #f1f5f9; color: #64748b;" title="Se calcula automáticamente desde la fecha de ingreso">
                            <small style="color: #64748b; font-size: 0.75rem; margin-top: 0.25rem; display: block;">Se calcula automáticamente por día transcurrido</small>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeForm()">
                            ✕ Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary">
                            ✓ Confirmar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // --- SISTEMA DE BASE DE DATOS ÚNICA CENTRALIZADA ---
        
        // Una sola base de datos compartida para TODOS los usuarios y dispositivos
        // Todos ven los mismos expedientes independientemente de donde accedan
        const CENTRAL_DATABASE_KEY = 'PARQUE_AUTOMOTOR_CENTRAL_DB';
        const DEVICE_ID = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        
        // Simular una base de datos central usando IndexedDB + localStorage como fallback
        let centralDatabase = null;
        
        // SISTEMA DE BASE DE DATOS CENTRAL - UNA SOLA FUENTE PARA TODOS
        async function initializeCentralDatabase() {
            try {
                console.log('🗄️ Inicializando base de datos central...');
                
                // Intentar usar IndexedDB para una verdadera base de datos del navegador
                if ('indexedDB' in window) {
                    centralDatabase = await openIndexedDB();
                    console.log('✅ Base de datos IndexedDB inicializada');
                } else {
                    // Fallback a localStorage con clave única global
                    centralDatabase = {
                        type: 'localStorage',
                        key: CENTRAL_DATABASE_KEY
                    };
                    console.log('✅ Base de datos localStorage inicializada');
                }
                
                // Migrar datos existentes a la base central si es necesario
                await migrateToCentralDatabase();
                
                // Cargar datos iniciales en caché
                await loadAllCentralData();
                
            } catch (error) {
                console.error('❌ Error inicializando base de datos central:', error);
                // Fallback to localStorage
                centralDatabase = {
                    type: 'localStorage',
                    key: CENTRAL_DATABASE_KEY
                };
            }
        }
        
        function openIndexedDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('ParqueAutomotorDB', 1);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve(request.result);
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    
                    // Crear tabla de expedientes si no existe
                    if (!db.objectStoreNames.contains('expedientes')) {
                        const store = db.createObjectStore('expedientes', { keyPath: 'id' });
                        store.createIndex('categoria', 'categoria', { unique: false });
                        store.createIndex('codigo', 'codigo', { unique: false });
                    }
                };
            });
        }
        
        // Leer expedientes de la base de datos central
        async function getCentralExpedientes(category) {
            try {
                console.log(`🗄️ [CENTRAL DB] Leyendo ${category}...`);
                
                if (centralDatabase && centralDatabase.type === 'indexedDB') {
                    // Usar IndexedDB
                    return await getFromIndexedDB(category);
                } else {
                    // Usar localStorage central
                    return getFromCentralLocalStorage(category);
                }
            } catch (error) {
                console.error('❌ Error leyendo base central:', error);
                return [];
            }
        }
        
        async function getFromIndexedDB(category) {
            return new Promise((resolve, reject) => {
                const transaction = centralDatabase.transaction(['expedientes'], 'readonly');
                const store = transaction.objectStore('expedientes');
                const index = store.index('categoria');
                const request = index.getAll(category);
                
                request.onsuccess = () => {
                    const expedientes = request.result.map(item => item.data);
                    console.log(`📊 [IndexedDB] ${category}: ${expedientes.length} expedientes`);
                    resolve(expedientes);
                };
                
                request.onerror = () => reject(request.error);
            });
        }
        
        function getFromCentralLocalStorage(category) {
            try {
                // Usar una clave especial que sea la misma para TODOS los usuarios/dispositivos
                const centralKey = `${CENTRAL_DATABASE_KEY}_${category}`;
                const data = localStorage.getItem(centralKey);
                const expedientes = data ? JSON.parse(data) : [];
                console.log(`📊 [Central LocalStorage] ${category}: ${expedientes.length} expedientes`);
                return expedientes;
            } catch (error) {
                console.error('❌ Error leyendo localStorage central:', error);
                return [];
            }
        }
        
        // Wrapper para mantener compatibilidad
        function getGlobalExpedientes(category) {
            // Esta función ahora es síncrona pero internamente usa la base central
            if (!centralDatabase) {
                console.warn('⚠️ Base de datos central no inicializada, usando fallback');
                return getFromCentralLocalStorage(category);
            }
            
            // Para mantener compatibilidad síncrona, usar caché
            const cached = getCachedCentralData(category);
            
            // Actualizar caché de forma asíncrona
            updateCentralCache(category);
            
            return cached;
        }
        
        let centralCache = {
            expedientesCreados: [],
            expedientesFinalizados: [],
            expedientesEjecutivo: [],
            expedientesCompras: [],
            lastUpdate: null
        };
        
        function getCachedCentralData(category) {
            return centralCache[category] || [];
        }
        
        async function updateCentralCache(category) {
            try {
                const data = await getCentralExpedientes(category);
                centralCache[category] = data;
                centralCache.lastUpdate = new Date().toISOString();
            } catch (error) {
                console.error('❌ Error actualizando caché central:', error);
            }
        }
        
        // Migrar datos existentes de localStorage individual a base central
        async function migrateToCentralDatabase() {
            try {
                console.log('🔄 Migrando datos existentes a base de datos central...');
                
                const categories = ['expedientesCreados', 'expedientesFinalizados', 'expedientesEjecutivo', 'expedientesCompras'];
                let migratedAny = false;
                
                for (const category of categories) {
                    // Verificar si ya existe en base central
                    const centralData = await getCentralExpedientes(category);
                    
                    if (centralData.length === 0) {
                        // No hay datos centrales, migrar desde localStorage local
                        const localData = JSON.parse(localStorage.getItem(category) || '[]');
                        const oldGlobalData = JSON.parse(localStorage.getItem('SISTEMA_PARQUE_AUTOMOTOR_GLOBAL') || '{}')[category] || [];
                        
                        // Combinar datos locales con datos globales antiguos
                        const allLocalData = [...localData, ...oldGlobalData];
                        
                        if (allLocalData.length > 0) {
                            console.log(`📦 Migrando ${category}: ${allLocalData.length} expedientes`);
                            await setCentralExpedientes(category, allLocalData);
                            migratedAny = true;
                        }
                    }
                }
                
                if (migratedAny) {
                    console.log('✅ Migración completada - todos los expedientes ahora están en la base central');
                } else {
                    console.log('ℹ️ No había datos para migrar o ya están en la base central');
                }
                
            } catch (error) {
                console.error('❌ Error durante migración:', error);
            }
        }
        
        // Cargar todos los datos centrales en caché
        async function loadAllCentralData() {
            try {
                console.log('📥 Cargando datos centrales en caché...');
                
                const categories = ['expedientesCreados', 'expedientesFinalizados', 'expedientesEjecutivo', 'expedientesCompras'];
                
                for (const category of categories) {
                    await updateCentralCache(category);
                }
                
                console.log('✅ Caché central cargado completamente');
                
            } catch (error) {
                console.error('❌ Error cargando datos centrales:', error);
            }
        }
        
        // Actualizar listeners para base de datos central
        function setupCentralDatabaseListeners() {
            // Escuchar eventos de actualización de base central
            window.addEventListener('centralDatabaseUpdate', async (event) => {
                if (event.detail.deviceId !== DEVICE_ID) {
                    console.log('🔄 Actualizando desde otro dispositivo (central DB):', event.detail);
                    await updateCentralCache(event.detail.category);
                    refreshAllSections();
                }
            });
            
            // BroadcastChannel para comunicación cross-tab
            if (typeof BroadcastChannel !== 'undefined') {
                const channel = new BroadcastChannel('central_db_sync');
                channel.addEventListener('message', async (event) => {
                    if (event.data.type === 'database_update' && event.data.deviceId !== DEVICE_ID) {
                        console.log('📻 Mensaje central DB recibido:', event.data);
                        await updateCentralCache(event.data.category);
                        refreshAllSections();
                    }
                });
            }
            
            console.log('✅ Listeners de base de datos central configurados');
        }
        
        function getFromLocalStorage(category) {
            try {
                // Usar localStorage central en lugar del antiguo GLOBAL_STORAGE_KEY
                return getFromCentralLocalStorage(category);
            } catch {
                return [];
            }
        }
        
        function getFromSharedStorage(category) {
            try {
                // Use sessionStorage as a secondary source (shared across tabs)
                const sharedKey = `SHARED_${CENTRAL_DATABASE_KEY}`;
                const sharedStorage = JSON.parse(sessionStorage.getItem(sharedKey) || '{}');
                return sharedStorage[category] || [];
            } catch {
                return [];
            }
        }
        
        function getFromUrlHash(category) {
            try {
                // Try to read data from URL hash (for cross-device sharing)
                const hashData = window.location.hash.substr(1);
                if (hashData && hashData.startsWith('data=')) {
                    const encoded = hashData.substr(5);
                    const decoded = JSON.parse(atob(encoded));
                    return decoded[category] || [];
                }
                return [];
            } catch {
                return [];
            }
        }
        
        function mergeExpedienteSources(sources) {
            const expedientesMap = new Map();
            
            // Merge all sources, using codigo as unique key
            sources.forEach(source => {
                if (Array.isArray(source)) {
                    source.forEach(exp => {
                        if (exp && exp.codigo) {
                            // Use the most recent version (by fechaCreacion or fechaModificacion)
                            const existing = expedientesMap.get(exp.codigo);
                            if (!existing || (exp.fechaModificacion || exp.fechaCreacion) > (existing.fechaModificacion || existing.fechaCreacion)) {
                                expedientesMap.set(exp.codigo, exp);
                            }
                        }
                    });
                }
            });
            
            return Array.from(expedientesMap.values());
        }
        
        // GUARDAR EN BASE DE DATOS CENTRAL - UNA SOLA FUENTE PARA TODOS
        async function setCentralExpedientes(category, data) {
            try {
                console.log(`💾 [CENTRAL DB] Guardando ${category}:`, data.length, 'expedientes');
                
                // Add timestamp to each expediente
                const timestampedData = data.map(exp => ({
                    ...exp,
                    fechaModificacion: new Date().toISOString(),
                    lastDevice: DEVICE_ID
                }));
                
                if (centralDatabase && centralDatabase.type === 'indexedDB') {
                    // Guardar en IndexedDB
                    await saveToCentralIndexedDB(category, timestampedData);
                } else {
                    // Guardar en localStorage central
                    saveToCentralLocalStorage(category, timestampedData);
                }
                
                // Actualizar caché local inmediatamente
                centralCache[category] = timestampedData;
                centralCache.lastUpdate = new Date().toISOString();
                
                // Trigger eventos para otros tabs
                triggerCentralDatabaseUpdate(category, timestampedData);
                
                // Update sync URL
                updateSyncUrl();
                
                console.log(`✅ [CENTRAL DB] ${category} guardado exitosamente`);
                
            } catch (error) {
                console.error('❌ Error guardando en base central:', error);
                // Fallback to localStorage
                saveToCentralLocalStorage(category, data);
            }
        }
        
        async function saveToCentralIndexedDB(category, data) {
            return new Promise((resolve, reject) => {
                const transaction = centralDatabase.transaction(['expedientes'], 'readwrite');
                const store = transaction.objectStore('expedientes');
                
                // Limpiar datos existentes de esta categoría
                const index = store.index('categoria');
                const deleteRequest = index.openCursor(category);
                
                deleteRequest.onsuccess = (event) => {
                    const cursor = event.target.result;
                    if (cursor) {
                        cursor.delete();
                        cursor.continue();
                    } else {
                        // Agregar nuevos datos
                        data.forEach((expediente, index) => {
                            store.add({
                                id: `${category}_${expediente.codigo}_${Date.now()}_${index}`,
                                categoria: category,
                                codigo: expediente.codigo,
                                data: expediente
                            });
                        });
                        resolve();
                    }
                };
                
                deleteRequest.onerror = () => reject(deleteRequest.error);
            });
        }
        
        function saveToCentralLocalStorage(category, data) {
            try {
                const centralKey = `${CENTRAL_DATABASE_KEY}_${category}`;
                localStorage.setItem(centralKey, JSON.stringify(data));
                console.log(`✅ [Central LocalStorage] ${category} guardado`);
            } catch (error) {
                console.error('❌ Error guardando en localStorage central:', error);
            }
        }
        
        function triggerCentralDatabaseUpdate(category, data) {
            // Evento para otros tabs
            window.dispatchEvent(new CustomEvent('centralDatabaseUpdate', {
                detail: { category, data, timestamp: new Date().toISOString(), deviceId: DEVICE_ID }
            }));
            
            // BroadcastChannel para comunicación cross-tab
            if (typeof BroadcastChannel !== 'undefined') {
                const channel = new BroadcastChannel('central_db_sync');
                channel.postMessage({
                    type: 'database_update',
                    category,
                    data,
                    timestamp: new Date().toISOString(),
                    deviceId: DEVICE_ID
                });
            }
        }
        
        // Wrapper para mantener compatibilidad
        function setGlobalExpedientes(category, data) {
            // Llamar a la nueva función central de forma asíncrona
            setCentralExpedientes(category, data).catch(error => {
                console.error('❌ Error en setGlobalExpedientes:', error);
            });
        }
        
        function saveToLocalStorage(category, data) {
            try {
                // Usar el sistema central en lugar del antiguo global storage
                saveToCentralLocalStorage(category, data);
            } catch (error) {
                console.error('Error saving to localStorage:', error);
            }
        }
        
        function saveToSharedStorage(category, data) {
            try {
                const sharedKey = `SHARED_${CENTRAL_DATABASE_KEY}`;
                const sharedStorage = JSON.parse(sessionStorage.getItem(sharedKey) || '{}');
                sharedStorage[category] = data;
                sharedStorage.lastUpdated = new Date().toISOString();
                sharedStorage.deviceId = DEVICE_ID;
                sessionStorage.setItem(sharedKey, JSON.stringify(sharedStorage));
            } catch (error) {
                console.error('Error saving to sessionStorage:', error);
            }
        }
        
        function saveToUrlHash(category, data) {
            try {
                // Create a shareable URL with data encoded in hash
                const allData = getAllGlobalExpedientes();
                allData[category] = data;
                allData.lastUpdated = new Date().toISOString();
                allData.deviceId = DEVICE_ID;
                
                // Encode data in URL hash for sharing
                const encoded = btoa(JSON.stringify(allData));
                const newHash = `#data=${encoded}`;
                
                // Update URL without triggering page reload
                if (window.location.hash !== newHash) {
                    window.history.replaceState(null, '', newHash);
                    console.log(`🔗 [${DEVICE_ID}] URL actualizada para sincronización cross-device`);
                }
            } catch (error) {
                console.error('Error saving to URL hash:', error);
            }
        }
        
        function triggerCrossDeviceSync(category, data) {
            try {
                // Trigger update event for other tabs/windows
                window.dispatchEvent(new CustomEvent('expedientesUpdated', { 
                    detail: { category, data, timestamp: new Date().toISOString(), deviceId: DEVICE_ID } 
                }));
                
                // Try to use BroadcastChannel for cross-tab communication
                if (typeof BroadcastChannel !== 'undefined') {
                    const channel = new BroadcastChannel('expedientes_sync');
                    channel.postMessage({
                        type: 'expediente_update',
                        category,
                        data,
                        timestamp: new Date().toISOString(),
                        deviceId: DEVICE_ID
                    });
                }
                
                // Show cross-device sharing instructions
                showCrossDeviceInstructions();
                
            } catch (error) {
                console.error('Error triggering cross-device sync:', error);
            }
        }
        
        function showCrossDeviceInstructions() {
            if (!window.crossDeviceInstructionsShown) {
                console.log('📱💻 SINCRONIZACIÓN CROSS-DEVICE ACTIVA:');
                console.log('  1. Copia la URL actual completa (incluye #data=...)');
                console.log('  2. Pega la URL en otro dispositivo/navegador');
                console.log('  3. Los expedientes se sincronizarán automáticamente');
                console.log('  🔗 URL actual:', window.location.href);
                window.crossDeviceInstructionsShown = true;
            }
        }
        
        function getAllGlobalExpedientes() {
            try {
                // Usar el caché central en lugar de localStorage individual
                return {
                    creados: centralCache.expedientesCreados || [],
                    finalizados: centralCache.expedientesFinalizados || [],
                    ejecutivo: centralCache.expedientesEjecutivo || [],
                    compras: centralCache.expedientesCompras || [],
                    lastUpdated: centralCache.lastUpdate,
                    version: Date.now() // Usar timestamp como versión
                };
            } catch (error) {
                console.error('Error reading all global expedientes:', error);
                return { creados: [], finalizados: [], ejecutivo: [], compras: [] };
            }
        }

        // --- Persistencia con localStorage ---
        function parseJSONSafe(text, fallback) {
            try { return JSON.parse(text || ''); } catch { return fallback; }
        }

        // Global storage functions - now all expedientes are shared across all users and browsers
        function getStoredCreated() {
            // Try to get from global storage first, fallback to localStorage for migration
            const globalData = getGlobalExpedientes('expedientesCreados');
            if (globalData.length === 0) {
                // Migrate from localStorage if exists
                const localData = parseJSONSafe(localStorage.getItem('expedientesCreados'), []);
                if (localData.length > 0) {
                    setGlobalExpedientes('expedientesCreados', localData);
                    return localData;
                }
            }
            return globalData;
        }
        function setStoredCreated(list) {
            setGlobalExpedientes('expedientesCreados', list);
            // Also keep in localStorage for compatibility
            localStorage.setItem('expedientesCreados', JSON.stringify(list));
            
            // Force update sync URL whenever expedientes are modified
            setTimeout(() => {
                updateSyncUrl();
            }, 100);
        }

        function getStoredFinalizados() {
            const globalData = getGlobalExpedientes('expedientesFinalizados');
            if (globalData.length === 0) {
                const localData = parseJSONSafe(localStorage.getItem('expedientesFinalizados'), []);
                if (localData.length > 0) {
                    setGlobalExpedientes('expedientesFinalizados', localData);
                    return localData;
                }
            }
            return globalData;
        }
        function setStoredFinalizados(list) {
            setGlobalExpedientes('expedientesFinalizados', list);
            localStorage.setItem('expedientesFinalizados', JSON.stringify(list));
        }

        function getStoredEjecutivo() {
            const globalData = getGlobalExpedientes('expedientesEjecutivo');
            if (globalData.length === 0) {
                const localData = parseJSONSafe(localStorage.getItem('expedientesEjecutivo'), []);
                if (localData.length > 0) {
                    setGlobalExpedientes('expedientesEjecutivo', localData);
                    return localData;
                }
            }
            return globalData;
        }
        function setStoredEjecutivo(list) {
            setGlobalExpedientes('expedientesEjecutivo', list);
            localStorage.setItem('expedientesEjecutivo', JSON.stringify(list));
            
            // Force update sync URL whenever expedientes are modified
            setTimeout(() => {
                updateSyncUrl();
            }, 100);
        }

        function getStoredCompras() {
            const globalData = getGlobalExpedientes('expedientesCompras');
            if (globalData.length === 0) {
                const localData = parseJSONSafe(localStorage.getItem('expedientesCompras'), []);
                if (localData.length > 0) {
                    setGlobalExpedientes('expedientesCompras', localData);
                    return localData;
                }
            }
            return globalData;
        }
        function setStoredCompras(list) {
            setGlobalExpedientes('expedientesCompras', list);
            localStorage.setItem('expedientesCompras', JSON.stringify(list));
            
            // Force update sync URL whenever expedientes are modified
            setTimeout(() => {
                updateSyncUrl();
            }, 100);
        }

        function renderAllInCreated() {
            console.log('🚀 INICIANDO renderAllInCreated...');
            
            // SOLO mostrar expedientes que están en "creados" - no mezclar con otras secciones
            const createdList = getStoredCreated();
            const finList = getStoredFinalizados();

            console.log('🔍 DEBUG renderAllInCreated:');
            console.log('  - Creados:', createdList);
            console.log('  - Finalizados:', finList);

            const expedientesCreados = document.getElementById('expedientesCreados');
            const emptyExpedientes = document.getElementById('emptyExpedientes');
            
            console.log('🎯 Elementos DOM encontrados:');
            console.log('  - expedientesCreados:', expedientesCreados);
            console.log('  - emptyExpedientes:', emptyExpedientes);
            
            // Clear current list items
            const itemsToRemove = expedientesCreados.querySelectorAll('.expediente-item');
            console.log('🗑️ Elementos a eliminar:', itemsToRemove.length);
            Array.from(itemsToRemove).forEach(n => n.remove());

            // Solo procesar expedientes creados
            const entries = createdList || [];
            console.log('📋 Expedientes creados a renderizar:', entries);
            
            if (!entries.length) {
                console.log('⚠️ No hay expedientes creados, mostrando estado vacío');
                if (emptyExpedientes) emptyExpedientes.style.display = 'block';
                return;
            }
            
            console.log('✅ Hay expedientes creados para renderizar, ocultando estado vacío');
            if (emptyExpedientes) emptyExpedientes.style.display = 'none';
            
            // Crear un identificador único que combine código + fecha de creación para evitar conflictos
            const finalizadoSet = new Set((finList || []).map(e => `${e.codigo}_${e.fechaCreacion}`));
            console.log('🏁 Set de finalizados:', Array.from(finalizadoSet));
            
            console.log('🎨 Iniciando renderizado de expedientes creados...');
            entries.forEach((data, index) => {
                console.log(`  🎯 Renderizando expediente ${index + 1}/${entries.length}:`, data.codigo);
                
                const item = document.createElement('div');
                item.className = 'expediente-item';
                const uniqueId = `${data.codigo}_${data.fechaCreacion}`;
                const isFinal = finalizadoSet.has(uniqueId);
                console.log(`    📊 Estado: ${isFinal ? 'FINALIZADO' : 'PENDIENTE'} (ID: ${uniqueId})`);
                
                item.innerHTML = `
                    <div class="status-badge ${isFinal ? 'status-finalizado' : 'status-pendiente'}">${isFinal ? 'FINALIZADO' : 'PENDIENTE'}</div>
                    <div class="expediente-header">${data.codigo} - ${data.detalle || 'Sin descripción'}</div>
                    <div class="expediente-details">
                        <strong>📅 ${formatDateEs(new Date(data.fechaIngreso || new Date()))}</strong><br>
                        <strong>Código:</strong> ${data.codigo}<br>
                        <strong>Número:</strong> ${data.numero || 'N/A'}/${data.anio || '2025'}<br>
                        <strong>Corresponde:</strong> ${data.corresponde || 'N/A'}<br>
                        <strong>Derivado a:</strong> ${data.derivado || 'N/A'}<br>
                        <strong>Días de trámite:</strong> ${data.diasTramite || 0} días
                        ${data.observacion ? '<br><strong>Observación:</strong> ' + data.observacion : ''}
                    </div>
                    ${!isFinal ? `
                    <div class="item-actions">
                        <label style="display:flex;align-items:center;gap:0.4rem;color:var(--gray-700);">
                            <input type="checkbox" class="select-checkbox" /> Seleccionar
                        </label>
                        <select class="inline-select" aria-label="Mover a" disabled>
                            <option value="">Enviar a...</option>
                            <option value="ejecutivo">Parque Automotor Ejecutivo</option>
                            <option value="compra">Compras</option>
                        </select>
                        <button class="send-btn" disabled>Enviar</button>
                        <button class="finalize-btn" onclick="finalizeExpediente('${data.codigo}', this)" title="Finalizar expediente">✅ Finalizar</button>
                        <button class="edit-btn" onclick="editExpediente('${data.codigo}')" title="Modificar expediente">✏️</button>
                        <button class="delete-btn" onclick="deleteExpedienteCreado('${data.codigo}')" title="Eliminar expediente">🗑️</button>
                    </div>
                    ` : `
                    <div class="item-actions" style="opacity: 0.6; pointer-events: none;">
                    </div>
                    `}
                `;
                
                console.log(`    🔧 Agregando handlers para:`, data.codigo);
                attachExpedienteItemHandlers(item, data);
                
                console.log(`    📍 Insertando en DOM:`, data.codigo);
                expedientesCreados.insertBefore(item, emptyExpedientes);
                console.log(`    ✅ Expediente ${data.codigo} renderizado exitosamente`);
            });
            
            console.log('🎉 Renderizado completado. Total de expedientes en DOM:', expedientesCreados.querySelectorAll('.expediente-item').length);
        }

        function buildFinalizadoItem(data) {
            const back = document.createElement('div');
            back.className = 'expediente-item';
            back.innerHTML = `
                <div class="status-badge status-finalizado">FINALIZADO</div>
                <div class="expediente-header">${data.codigo} - ${data.detalle || 'Sin descripción'}</div>
                <div class="expediente-details">
                    <strong>📅 ${formatDateEs(new Date(data.fechaIngreso))}</strong><br>
                    <strong>Código:</strong> ${data.codigo}<br>
                    <strong>Número:</strong> ${data.numero || 'N/A'}/${data.anio || '2025'}<br>
                    <strong>Corresponde:</strong> ${data.corresponde || 'N/A'}<br>
                    <strong>Derivado a:</strong> ${data.derivado || 'N/A'}<br>
                    <strong>Días de trámite:</strong> ${data.diasTramite || 0} días
                    ${data.observacion ? '<br><strong>Observación:</strong> ' + data.observacion : ''}
                </div>
            `;
            return back;
        }

        // renderStoredFinalizados ya no se usa, centralizamos en renderAllInCreated

        function ensureCompraContainer() {
            let compraContainer = document.getElementById('compraContainer');
            if (!compraContainer) {
                compraContainer = document.createElement('div');
                compraContainer.id = 'compraContainer';
                const compraSection = document.querySelector('.section-card:nth-of-type(3) .section-content');
                compraSection.appendChild(compraContainer);
            }
            return compraContainer;
        }

        function renderStoredEjecutivo() {
            const list = getStoredEjecutivo();
            const execSection = document.getElementById('executiveSection');
            const emptyExec = document.getElementById('emptyExecutive');
            
            // Limpiar elementos existentes (excepto emptyExec)
            const existingItems = execSection.querySelectorAll('.executive-item');
            existingItems.forEach(item => item.remove());
            
            if (!Array.isArray(list) || list.length === 0) {
                console.log('🏢 No hay expedientes en ejecutivo para renderizar');
                if (emptyExec) emptyExec.style.display = 'block';
                return;
            }
            
            console.log(`🏢 Renderizando ${list.length} expedientes en ejecutivo...`);
            if (emptyExec) emptyExec.style.display = 'none';
            
            list.forEach(d => {
                const el = buildExecutiveItemSimple(d);
                execSection.insertBefore(el, emptyExec);
                console.log(`✅ Expediente ${d.codigo} renderizado en ejecutivo`);
            });
        }

        function renderStoredCompras() {
            const list = getStoredCompras();
            const compraContainer = ensureCompraContainer();
            
            // Limpiar contenedor antes de renderizar
            compraContainer.innerHTML = '';
            
            if (!Array.isArray(list) || list.length === 0) {
                console.log('📦 No hay expedientes en compras para renderizar');
                return;
            }
            
            console.log(`📦 Renderizando ${list.length} expedientes en compras...`);
            list.forEach(d => {
                const item = buildCompraItemSimple(d);
                compraContainer.appendChild(item);
                console.log(`✅ Expediente ${d.codigo} renderizado en compras`);
            });
        }

        // Función para formatear fecha en español
        function formatDateEs(date) {
            return date.toLocaleDateString('es-ES');
        }

        // Función para calcular días de trámite
        function calculateDays(startDate, endDate = new Date()) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            const diffTime = Math.abs(end - start);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        }

        // Función para actualizar estadísticas
        function updateStats() {
            const expedientesCreados = document.querySelectorAll('#expedientesCreados .expediente-item').length;
            const executiveItems = document.querySelectorAll('#executiveSection .executive-item').length;
            const totalExpedientes = expedientesCreados + executiveItems;
            const finalizados = document.querySelectorAll('.status-finalizado').length;
            const pendientes = document.querySelectorAll('.status-pendiente').length;

            const totalEl = document.getElementById('totalExpedientes');
            const finalizadosEl = document.getElementById('finalizados');
            const pendientesEl = document.getElementById('pendientes');
            
            if (totalEl) totalEl.textContent = String(totalExpedientes);
            if (finalizadosEl) finalizadosEl.textContent = String(finalizados);
            if (pendientesEl) pendientesEl.textContent = String(pendientes);
        }

        // Función para crear item de expediente
        function createExpedienteItem(data) {
            const item = document.createElement('div');
            item.className = 'expediente-item';
            item.dataset.codigo = data.codigo;
            
            const fechaIngreso = new Date(data.fechaIngreso);
            const diasTramite = data.diasTramite || calculateDays(fechaIngreso);
            
            item.innerHTML = `
                <div class="status-badge status-pendiente">PENDIENTE</div>
                <div class="expediente-header">${data.codigo} - ${data.detalle || 'Sin descripción'}</div>
                <div class="expediente-details">
                    <strong>📅 ${formatDateEs(fechaIngreso)}</strong><br>
                    <strong>Código:</strong> ${data.codigo}<br>
                    <strong>Número:</strong> ${data.numero || 'N/A'}/${data.anio || '2025'}<br>
                    <strong>Corresponde:</strong> ${data.corresponde || 'N/A'}<br>
                    <strong>Derivado a:</strong> ${data.derivado || 'N/A'}<br>
                    <strong>Días de trámite:</strong> ${diasTramite} días
                    ${data.observacion ? '<br><strong>Observación:</strong> ' + data.observacion : ''}
                </div>
                <div class="item-actions">
                    <label style="display:flex;align-items:center;gap:0.4rem;color:var(--gray-700);">
                        <input type="checkbox" class="select-checkbox" /> Seleccionar
                    </label>
                    <select class="inline-select" aria-label="Mover a" disabled>
                        <option value="">Enviar a...</option>
                        <option value="ejecutivo">Parque Automotor Ejecutivo</option>
                        <option value="compra">Compras</option>
                    </select>
                    <button class="send-btn" disabled>Enviar</button>
                </div>
            `;
            attachExpedienteItemHandlers(item, data);
            
            return item;
        }

        function attachExpedienteItemHandlers(item, data) {
            // Verificar si el expediente está finalizado
            const isFinalizado = item.querySelector('.status-badge')?.textContent === 'FINALIZADO';
            
            // Si está finalizado, no agregar handlers
            if (isFinalizado) {
                return;
            }
            
            const checkbox = item.querySelector('.select-checkbox');
            const select = item.querySelector('.inline-select');
            const sendBtn = item.querySelector('.send-btn');
            
            // Si no hay elementos de acción, no continuar
            if (!checkbox || !select || !sendBtn) {
                return;
            }
            
            // Preselección según tipo de expediente
            const tipo = (data.tipo || '').toString().toLowerCase();
            if (tipo.includes('ejecutivo')) {
                select.value = 'ejecutivo';
            } else if (tipo.includes('compra')) {
                select.value = 'compra';
            }
            
            checkbox.addEventListener('change', () => {
                const enabled = checkbox.checked;
                select.disabled = !enabled;
                sendBtn.disabled = !enabled;
            });
            
            sendBtn.addEventListener('click', () => {
                let destino = select.value;
                if (!destino) {
                    // Usar mapeo por tipo si no eligió manualmente
                    if (tipo.includes('ejecutivo')) destino = 'ejecutivo';
                    if (tipo.includes('compra')) destino = 'compra';
                }
                if (!destino) {
                    alert('Seleccione un destino (Ejecutivo o Compras).');
                    return;
                }
                moveBidirectionalExpediente(data, 'creados', destino, item);
                checkbox.checked = false;
                select.value = '';
                select.disabled = true;
                sendBtn.disabled = true;
            });
        }

        function buildExecutiveItemSimple(data) {
            const newItem = document.createElement('div');
            newItem.className = 'executive-item';
            newItem.dataset.codigo = data.codigo;
            newItem.innerHTML = `
                <div class="status-badge status-pendiente">PENDIENTE</div>
                <div class="expediente-header">${data.codigo} - ${data.detalle || ''}</div>
                <div class="expediente-details">
                    <strong>📅 ${formatDateEs(new Date(data.fechaIngreso))}</strong><br>
                    <strong>Código:</strong> ${data.codigo}<br>
                    <strong>Número:</strong> ${data.numero || 'N/A'}/${data.anio || '2025'}<br>
                    <strong>Corresponde:</strong> ${data.corresponde || 'N/A'}<br>
                    <strong>Derivado a:</strong> ${data.derivado || 'N/A'}<br>
                    <strong>Días de trámite:</strong> ${data.diasTramite || 0} días
                </div>
                <div class="item-actions">
                    <label style="display:flex;align-items:center;gap:0.4rem;color:var(--gray-700);">
                        <input type="checkbox" class="select-checkbox" /> Seleccionar
                    </label>
                    <select class="inline-select" aria-label="Mover a" disabled>
                        <option value="">Enviar a...</option>
                        <option value="creados">Expedientes Creados</option>
                        <option value="compra">Compras</option>
                    </select>
                    <button class="send-btn" disabled>Enviar</button>
                    <button class="finalize-btn" onclick="finalizeExpediente('${data.codigo}', this)" title="Finalizar expediente">✅ FINALIZAR</button>
                    <button class="delete-btn" onclick="deleteExecutive(this)" title="Eliminar expediente">🗑️</button>
                </div>
            `;
            attachBidirectionalHandler(newItem, data, 'ejecutivo');
            return newItem;
        }

        function buildCompraItemSimple(data) {
            const newItem = document.createElement('div');
            newItem.className = 'executive-item';
            newItem.dataset.codigo = data.codigo;
            newItem.innerHTML = `
                <div class="status-badge status-pendiente">PENDIENTE</div>
                <div class="expediente-header">${data.codigo} - ${data.detalle || ''}</div>
                <div class="expediente-details">
                    <strong>📅 ${formatDateEs(new Date(data.fechaIngreso))}</strong><br>
                    <strong>Código:</strong> ${data.codigo}<br>
                    <strong>Número:</strong> ${data.numero || 'N/A'}/${data.anio || '2025'}<br>
                    <strong>Corresponde:</strong> ${data.corresponde || 'N/A'}<br>
                    <strong>Derivado a:</strong> ${data.derivado || 'N/A'}<br>
                    <strong>Días de trámite:</strong> ${data.diasTramite || 0} días
                </div>
                <div class="item-actions">
                    <label style="display:flex;align-items:center;gap:0.4rem;color:var(--gray-700);">
                        <input type="checkbox" class="select-checkbox" /> Seleccionar
                    </label>
                    <select class="inline-select" aria-label="Mover a" disabled>
                        <option value="">Enviar a...</option>
                        <option value="creados">Expedientes Creados</option>
                        <option value="ejecutivo">Parque Automotor Ejecutivo</option>
                    </select>
                    <button class="send-btn" disabled>Enviar</button>
                    <button class="finalize-btn" onclick="finalizeExpediente('${data.codigo}', this)" title="Finalizar expediente">✅ FINALIZAR</button>
                    <button class="delete-btn" onclick="deleteExecutive(this)" title="Eliminar expediente">🗑️</button>
                </div>
            `;
            attachBidirectionalHandler(newItem, data, 'compras');
            return newItem;
        }

        function moveExpediente(data, destino, itemEl) {
            // Verificar que el expediente no esté finalizado
            if (itemEl && itemEl.querySelector('.status-badge')?.textContent === 'FINALIZADO') {
                alert('❌ No se puede mover un expediente FINALIZADO');
                return;
            }
            
            // Remover de expedientes creados (y storage) si va a otro destino
            const expedientesCreados = document.getElementById('expedientesCreados');
            const emptyExpedientes = document.getElementById('emptyExpedientes');
            if (itemEl && itemEl.parentElement === expedientesCreados) {
                itemEl.remove();
                const stored = getStoredCreated().filter(x => x.codigo !== data.codigo);
                setStoredCreated(stored);
                if (expedientesCreados.querySelectorAll('.expediente-item').length === 0 && emptyExpedientes) {
                    emptyExpedientes.style.display = 'block';
                }
            }

            if (destino === 'ejecutivo') {
                const execSection = document.getElementById('executiveSection');
                const emptyExec = document.getElementById('emptyExecutive');
                if (emptyExec) emptyExec.style.display = 'none';
                execSection.insertBefore(buildExecutiveItemSimple(data), emptyExec);
                const ejList = getStoredEjecutivo();
                ejList.push(data);
                setStoredEjecutivo(ejList);
            } else if (destino === 'compra') {
                // Reusar contenedor de compras: agregar debajo del preview
                let compraContainer = document.getElementById('compraContainer');
                if (!compraContainer) {
                    compraContainer = document.createElement('div');
                    compraContainer.id = 'compraContainer';
                    const compraSection = document.querySelector('.section-card:nth-of-type(3) .section-content');
                    compraSection.appendChild(compraContainer);
                }
                compraContainer.prepend(buildCompraItemSimple(data));
                const cList = getStoredCompras();
                cList.push(data);
                setStoredCompras(cList);
            }
            // Activar alerta si pasan 2 días sin finalizar
            scheduleTwoDayAlert();

            updateStats();
        }

        // New bidirectional handler for all sections
        function attachBidirectionalHandler(wrapper, data, currentSection) {
            const checkbox = wrapper.querySelector('.select-checkbox');
            const sendBtn = wrapper.querySelector('.send-btn');
            const select = wrapper.querySelector('.inline-select');
            
            if (!checkbox || !sendBtn || !select) {
                console.log('⚠️ Elementos de control no encontrados, usando handler legacy');
                attachReturnHandler(wrapper, data);
                return;
            }
            
            checkbox.addEventListener('change', () => {
                if (checkbox.checked) {
                    sendBtn.disabled = false;
                    select.disabled = false;
                } else {
                    sendBtn.disabled = true;
                    select.disabled = true;
                }
            });
            
            sendBtn.addEventListener('click', () => {
                const destino = select.value;
                if (!destino) {
                    alert('❌ Selecciona un destino para enviar el expediente');
                    return;
                }
                
                console.log(`📤 Enviando expediente ${data.codigo} desde ${currentSection} hacia ${destino}`);
                moveBidirectionalExpediente(data, currentSection, destino, wrapper);
                
                // Reset form
                checkbox.checked = false;
                select.value = '';
                sendBtn.disabled = true;
                select.disabled = true;
            });
        }

        // Enhanced bidirectional movement function
        function moveBidirectionalExpediente(data, fromSection, toSection, itemEl) {
            console.log(`🔄 Moviendo expediente ${data.codigo}: ${fromSection} → ${toSection}`);
            
            // Verificar que el expediente no esté finalizado
            if (itemEl && itemEl.querySelector('.status-badge')?.textContent === 'FINALIZADO') {
                alert('❌ No se puede mover un expediente FINALIZADO');
                return;
            }
            
            // Remove from current section
            removeFromSection(data.codigo, fromSection, itemEl);
            
            // Add to destination section  
            addToSection(data, toSection);
            
            // Update statistics and alerts
            updateStats();
            scheduleTwoDayAlert();
            
            alert(`✅ Expediente ${data.codigo} movido exitosamente de ${getSectionDisplayName(fromSection)} a ${getSectionDisplayName(toSection)}`);
        }
        
        function removeFromSection(codigo, section, itemEl) {
            console.log(`🗑️ Removiendo expediente ${codigo} de ${section}`);
            
            // Remove from DOM
            if (itemEl) {
                itemEl.remove();
            }
            
            // Remove from storage
            switch(section) {
                case 'creados':
                    const storedCreados = getStoredCreated().filter(x => x.codigo !== codigo);
                    setStoredCreated(storedCreados);
                    // Show empty state if needed
                    const expedientesCreados = document.getElementById('expedientesCreados');
                    const emptyExpedientes = document.getElementById('emptyExpedientes');
                    if (expedientesCreados && expedientesCreados.querySelectorAll('.expediente-item').length === 0 && emptyExpedientes) {
                        emptyExpedientes.style.display = 'block';
                    }
                    break;
                case 'ejecutivo':
                    const storedEjecutivo = getStoredEjecutivo().filter(x => x.codigo !== codigo);
                    setStoredEjecutivo(storedEjecutivo);
                    // Show empty state if needed
                    const execSection = document.getElementById('executiveSection');
                    const emptyExec = document.getElementById('emptyExecutive');
                    if (execSection && execSection.querySelectorAll('.executive-item').length === 0 && emptyExec) {
                        emptyExec.style.display = 'block';
                    }
                    break;
                case 'compras':
                    const storedCompras = getStoredCompras().filter(x => x.codigo !== codigo);
                    setStoredCompras(storedCompras);
                    // Clean up empty container
                    const compraContainer = document.getElementById('compraContainer');
                    if (compraContainer && compraContainer.children.length === 0) {
                        compraContainer.remove();
                    }
                    break;
            }
        }
        
        function addToSection(data, section) {
            console.log(`➕ Agregando expediente ${data.codigo} a ${section}`);
            
            switch(section) {
                case 'creados':
                    // Add to expedientes creados
                    const expedientesCreados = document.getElementById('expedientesCreados');
                    const emptyExpedientes = document.getElementById('emptyExpedientes');
                    if (emptyExpedientes) emptyExpedientes.style.display = 'none';
                    
                    // Check if expediente already exists to avoid duplication
                    const existingCreateds = getStoredCreated();
                    const alreadyExists = existingCreateds.some(exp => exp.codigo === data.codigo);
                    
                    if (!alreadyExists) {
                        existingCreateds.push(data);
                        setStoredCreated(existingCreateds);
                        renderAllInCreated(); // Refresh the entire section
                    } else {
                        console.log(`⚠️ Expediente ${data.codigo} ya existe en creados, evitando duplicación`);
                    }
                    break;
                    
                case 'ejecutivo':
                    // Add to ejecutivo section
                    const execSection = document.getElementById('executiveSection');
                    const emptyExec = document.getElementById('emptyExecutive');
                    if (emptyExec) emptyExec.style.display = 'none';
                    
                    // Check if expediente already exists to avoid duplication
                    const existingEjecutivo = getStoredEjecutivo();
                    const alreadyExistsEjecutivo = existingEjecutivo.some(exp => exp.codigo === data.codigo);
                    
                    if (!alreadyExistsEjecutivo) {
                        execSection.insertBefore(buildExecutiveItemSimple(data), emptyExec);
                        existingEjecutivo.push(data);
                        setStoredEjecutivo(existingEjecutivo);
                    } else {
                        console.log(`⚠️ Expediente ${data.codigo} ya existe en ejecutivo, evitando duplicación`);
                    }
                    break;
                    
                case 'compras':
                    // Add to compras section
                    let compraContainer = document.getElementById('compraContainer');
                    if (!compraContainer) {
                        compraContainer = document.createElement('div');
                        compraContainer.id = 'compraContainer';
                        const compraSection = document.querySelector('.section-card:nth-of-type(3) .section-content');
                        compraSection.appendChild(compraContainer);
                    }
                    
                    // Check if expediente already exists to avoid duplication
                    const existingCompras = getStoredCompras();
                    const alreadyExistsCompras = existingCompras.some(exp => exp.codigo === data.codigo);
                    
                    if (!alreadyExistsCompras) {
                        // Agregar al DOM
                        const compraItem = buildCompraItemSimple(data);
                        compraContainer.prepend(compraItem);
                        
                        // Agregar al storage
                        existingCompras.push(data);
                        setStoredCompras(existingCompras);
                        
                        console.log(`✅ Expediente ${data.codigo} agregado exitosamente a compras`);
                    } else {
                        console.log(`⚠️ Expediente ${data.codigo} ya existe en compras, evitando duplicación`);
                    }
                    break;
            }
        }
        
        function getSectionDisplayName(section) {
            const names = {
                'creados': 'Expedientes Creados',
                'ejecutivo': 'Parque Automotor Ejecutivo', 
                'compras': 'Compras'
            };
            return names[section] || section;
        }

        function attachReturnHandler(wrapper, data) {
            // Casilla para volver a "Expedientes Creados" como FINALIZADO
            const checkbox = wrapper.querySelector('.select-checkbox');
            const sendBackBtn = wrapper.querySelector('.send-back-btn');
            if (checkbox && sendBackBtn) {
                checkbox.addEventListener('change', () => {
                    sendBackBtn.disabled = !checkbox.checked;
                });
                sendBackBtn.addEventListener('click', () => {
                    if (!checkbox.checked) return;
                    const created = document.getElementById('expedientesCreados');
                    const empty = document.getElementById('emptyExpedientes');
                    if (empty) empty.style.display = 'none';
                    const back = buildFinalizadoItem(data);
                    created.insertBefore(back, empty);
                    setStoredFinalizados([...getStoredFinalizados(), data]);
                    const inExec = wrapper.closest('#executiveSection');
                    if (inExec) setStoredEjecutivo(getStoredEjecutivo().filter(x => x.codigo !== data.codigo));
                    const compraCont = document.getElementById('compraContainer');
                    if (compraCont && compraCont.contains(wrapper)) {
                        setStoredCompras(getStoredCompras().filter(x => x.codigo !== data.codigo));
                    }
                    wrapper.remove();
                    updateStats();
                });
            }
            const badge = wrapper.querySelector('.status-badge');
            if (badge) badge.title = 'Pendiente: se volverá rojo si pasan 2 días sin finalizar';
        }

        function scheduleTwoDayAlert() {
            // Recorre todos los pendientes (creados, ejecutivo, compra) y marca alerta si >2 días
            const now = new Date();
            document.querySelectorAll('.status-badge.status-pendiente').forEach(badge => {
                const wrapper = badge.closest('.expediente-item, .executive-item');
                if (!wrapper) return;
                const dateText = (wrapper.querySelector('.expediente-details strong')?.textContent || '').replace('📅', '').trim();
                // intentar parsear DD/MM/YYYY o similar
                let parts = dateText.split('/').map(x => x.trim());
                let parsed = null;
                if (parts.length === 3) {
                    const [dd, mm, yyyy] = parts;
                    parsed = new Date(parseInt(yyyy,10), parseInt(mm,10)-1, parseInt(dd,10));
                } else {
                    parsed = new Date(dateText);
                }
                if (parsed instanceof Date && !isNaN(parsed.getTime())) {
                    const diffDays = Math.ceil(Math.abs(now - parsed) / (1000*60*60*24));
                    if (diffDays > 2) {
                        badge.classList.add('status-alert');
                        badge.textContent = 'ALERTA (PENDIENTE)';
                    }
                }
            });
        }

        // FILTRO GLOBAL (APLICA A LAS TRES SECCIONES)
        function applyGlobalFilter(mode) {
            // mode: 'TODOS' | 'PENDIENTE' | 'CONFIRMADOS'
            const showAll = mode === 'TODOS';
            const showPend = mode === 'PENDIENTE';
            const showConf = mode === 'CONFIRMADOS';
            const allCards = document.querySelectorAll('#expedientesCreados .expediente-item, #executiveSection .executive-item, #compraContainer .executive-item');
            allCards.forEach(card => {
                const isPend = !!card.querySelector('.status-badge.status-pendiente');
                const isFin = !!card.querySelector('.status-badge.status-finalizado');
                let visible = true;
                if (!showAll) {
                    if (showPend) visible = isPend;
                    if (showConf) visible = isFin;
                }
                card.style.display = visible ? '' : 'none';
            });
            // Botones activos
            document.querySelectorAll('.filter-btn').forEach(b => {
                b.classList.toggle('active', b.dataset.filter === mode);
            });
        }

        // Función para abrir el formulario
        function openNewExpedienteForm() {
            const mainPage = document.getElementById('mainPage');
            const formPage = document.getElementById('formPage');
            
            // Establecer fecha actual por defecto
            const today = new Date().toISOString().split('T')[0];
            const fechaIngresoInput = document.querySelector('input[name="fechaIngreso"]');
            if (fechaIngresoInput) fechaIngresoInput.value = today;
            
            // Mostrar formulario
            formPage.classList.add('active');
            document.body.style.overflow = 'hidden';
            
            // Enfocar en el primer campo
            setTimeout(() => {
                const firstInput = formPage.querySelector('input[name="codigo"]');
                if (firstInput) firstInput.focus();
            }, 100);
        }

        // Función para cerrar el formulario
        function closeForm() {
            const formPage = document.getElementById('formPage');
            formPage.classList.remove('active');
            document.body.style.overflow = '';
            
            // Limpiar formulario
            const form = document.getElementById('expedienteForm');
            if (form) form.reset();
        }

        // Función para eliminar expediente ejecutivo
        function deleteExecutive(button) {
            if (confirm('¿Está seguro de que desea eliminar este expediente?')) {
                const item = button.closest('.executive-item');
                if (item) item.remove();
                if (item && item.dataset && item.dataset.default === 'true') {
                    localStorage.setItem('hideDefaultExecutive', '1');
                }
                
                const executiveSection = document.getElementById('executiveSection');
                const items = executiveSection.querySelectorAll('.executive-item');
                const emptyState = document.getElementById('emptyExecutive');
                if (items.length === 0 && emptyState) {
                    emptyState.style.display = 'block';
                }
                // Actualizar storage según la sección de la que proviene
                const codigo = item?.dataset?.codigo;
                if (codigo) {
                    if (executiveSection.contains(item)) {
                        setStoredEjecutivo(getStoredEjecutivo().filter(x => x.codigo !== codigo));
                    } else {
                        const compraContainer = document.getElementById('compraContainer');
                        if (compraContainer && compraContainer.contains(item)) {
                            setStoredCompras(getStoredCompras().filter(x => x.codigo !== codigo));
                        }
                    }
                }
                updateStats();
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', async function() {
            // Initialize central database system first
            await initializeGlobalSystem();
            
            // Start real-time synchronization
            startExpedienteWatcher();
            
            // Render inicial (consolidada por defecto)
            renderStoredEjecutivo();
            renderStoredCompras();
            renderAllInCreated();
            
            // Show global status
            showAllExpedientesGlobal();

            // Ocultar item ejecutivo por defecto si fue eliminado previamente
            if (localStorage.getItem('hideDefaultExecutive') === '1') {
                const def = document.querySelector('#executiveSection .executive-item[data-default="true"]');
                if (def) def.remove();
                const executiveSection = document.getElementById('executiveSection');
                const items = executiveSection.querySelectorAll('.executive-item');
                const emptyState = document.getElementById('emptyExecutive');
                if (items.length === 0 && emptyState) {
                    emptyState.style.display = 'block';
                }
            }

            updateStats();
            scheduleTwoDayAlert();

            // Filtro: eventos
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => applyGlobalFilter(btn.dataset.filter));
            });
            // Estado inicial: TODOS
            applyGlobalFilter('TODOS');

            // Render inicial: todos los expedientes en Expedientes Creados
            renderAllInCreated();
            
            // Configurar el formulario
            const form = document.getElementById('expedienteForm');
            if (form) {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const formData = new FormData(form);
                    const data = {};
                    for (let [key, value] of formData.entries()) {
                        data[key] = value.toString().trim();
                    }

                    // Calcular días de trámite automáticamente
                    const fechaIngreso = new Date(data.fechaIngreso);
                    if (!Number.isFinite(fechaIngreso.getTime())) {
                        alert('Fecha de ingreso inválida.');
                        return;
                    }
                    data.diasTramite = calculateDays(data.fechaIngreso);
                    
                    // Validar campos requeridos
                    if (!data.codigo || !data.fechaIngreso) {
                        alert('Por favor complete todos los campos obligatorios.');
                        return;
                    }
                    
                    // Crear nuevo expediente
                    const expedientesCreados = getStoredCreated();
                    expedientesCreados.push({
                        codigo: data.codigo,
                        numero: data.numero || '',
                        anio: data.anio || '',
                        corresponde: data.corresponde || '',
                        derivado: data.derivado || '',
                        fechaIngreso: data.fechaIngreso,
                        fechaDerivacion: data.fechaDerivacion || '',
                        detalle: data.detalle || '',
                        observacion: data.observacion || '',
                        diasTramite: data.diasTramite || 0,
                        tipo: data.tipo || 'Otros',
                        status: 'CREADO',
                        fechaCreacion: new Date().toISOString()
                    });
                    setStoredCreated(expedientesCreados);

                    renderAllInCreated();
                    updateStats();

                    closeForm();

                    setTimeout(() => {
                        alert('Expediente creado exitosamente');
                    }, 300);
                });
            }
            
            // Cerrar formulario con ESC
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const formPage = document.getElementById('formPage');
                    if (formPage && formPage.classList.contains('active')) {
                        closeForm();
                    }
                }
            });
            
            // Efectos visuales
            document.querySelectorAll('.section-card').forEach(card => {
                card.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-4px)';
                });
                card.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0)';
                });
            });
        });

        // Historia de URL (simulación básica)
        window.addEventListener('popstate', function() {
            closeForm();
        });

        // AUTH BÁSICO (LOCALSTORAGE)
        function showRegister(){
            document.getElementById('loginPage').classList.remove('active');
            document.getElementById('registerPage').classList.add('active');
        }
        function showLogin(){
            document.getElementById('registerPage').classList.remove('active');
            document.getElementById('loginPage').classList.add('active');
        }
        function logout(){
            localStorage.removeItem('authUser');
            document.getElementById('mainPage').style.display = 'none';
            document.getElementById('loginPage').classList.add('active');
            document.getElementById('registerPage').classList.remove('active');
        }

        // INIT AUTH EVENTS
        (function initAuth(){
            // Crear admin por defecto si no existe
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const adminExists = users.find(u => u.username === '35477889');
            if (!adminExists) {
                users.push({
                    username: '35477889',
                    dni: '35477889',
                    nombre: 'ADMIN',
                    apellido: 'SISTEMA',
                    password: '35477889',
                    role: 'ADMIN',
                    blocked: false
                });
                localStorage.setItem('users', JSON.stringify(users));
                console.log('Admin creado automáticamente');
            }
            
            const auth = JSON.parse(localStorage.getItem('authUser') || 'null');
            if (auth) {
                const hasRole = !!(auth.role && auth.role.trim());
                if (!hasRole) {
                    document.getElementById('loginPage').classList.remove('active');
                    document.getElementById('registerPage').classList.remove('active');
                    const rp = document.getElementById('rolePendingPage');
                    if (rp) rp.classList.add('active');
                    document.getElementById('mainPage').style.display = 'none';
                } else {
                    document.getElementById('loginPage').classList.remove('active');
                    document.getElementById('registerPage').classList.remove('active');
                    document.getElementById('mainPage').style.display = '';
                    applyRoleUI(auth.role || 'MESA_DE_ENTRADA');
                }
            }
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const fd = new FormData(loginForm);
                    const username = (fd.get('username')||'').toString().trim();
                    const password = (fd.get('password')||'').toString().trim();
                    if (!username || !password) return alert('COMPLETE USUARIO (DNI) Y CONTRASEÑA');
                    const users = JSON.parse(localStorage.getItem('users')||'[]');
                    const found = users.find(u => (u.username === username || u.dni === username) && u.password === password);
                    if (!found) {
                        alert('USUARIO O CONTRASEÑA INCORRECTOS');
                        return;
                    }
                    if (found.blocked) {
                        alert('CUENTA BLOQUEADA. CONTACTE AL ADMIN.');
                        return;
                    }
                    localStorage.setItem('authUser', JSON.stringify({ username: found.username, dni: found.dni, nombre: found.nombre, apellido: found.apellido, role: (found.role||'').trim() }));
                    const hasRole = !!((found.role||'').trim());
                    document.getElementById('loginPage').classList.remove('active');
                    document.getElementById('registerPage').classList.remove('active');
                    if (!hasRole) {
                        const rp = document.getElementById('rolePendingPage');
                        if (rp) rp.classList.add('active');
                        document.getElementById('mainPage').style.display = 'none';
                    } else {
                        document.getElementById('mainPage').style.display = '';
                        applyRoleUI(found.role);
                    }
                });
            }
            const registerForm = document.getElementById('registerForm');
            if (registerForm) {
                registerForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const fd = new FormData(registerForm);
                    const pw = (fd.get('password')||'').toString();
                    const cpw = (fd.get('confirmPassword')||'').toString();
                    const dni = (fd.get('dni')||'').toString().trim();
                    if (!/^\d{7,9}$/.test(dni)) return alert('DNI INVÁLIDO. USE SOLO NÚMEROS (7 A 9 DÍGITOS)');
                    if (pw !== cpw) return alert('LAS CONTRASEÑAS NO COINCIDEN');
                    // Guardar usuario con rol por defecto
                    const user = { username: dni, dni, nombre: (fd.get('nombre')||'').toString(), apellido: (fd.get('apellido')||'').toString(), password: pw, role: 'PERSONAL' };
                    const users = JSON.parse(localStorage.getItem('users')||'[]');
                    if (users.find(u => u.username === user.username)) {
                        return alert('YA EXISTE UN USUARIO CON ESE DNI');
                    }
                    users.push(user);
                    localStorage.setItem('users', JSON.stringify(users));
                    alert('USUARIO REGISTRADO');
                    showLogin();
                });
                // Autocompletar USERNAME con DNI
                const dniInput = document.querySelector('#registerForm [name="dni"]');
                const userInput = document.querySelector('#registerForm [name="username"]');
                if (dniInput && userInput) {
                    const sync = () => { userInput.value = dniInput.value.trim(); };
                    dniInput.addEventListener('input', sync);
                    dniInput.addEventListener('change', sync);
                }
            }
        })();

        function applyRoleUI(role){
            console.log('🔐 Aplicando rol:', role);
            
            // Todos los usuarios pueden ver expedientes - no hay restricciones de visualización
            // Solo se mantienen restricciones para funciones administrativas
            
            // Botón de agregar expediente - solo ADMIN y MESA_DE_ENTRADA pueden crear
            const addBtn = document.querySelector('.add-btn');
            if (addBtn) {
                if (role === 'PERSONAL') {
                    addBtn.style.display = 'none';
                } else {
                    addBtn.style.display = '';
                }
            }
            
            // Configuración de pestañas según rol
            const configTabs = document.querySelectorAll('#configTabs .tab-btn');
            if (configTabs.length > 0) {
                if (role === 'ADMIN') {
                    // ADMIN: ve todas las pestañas
                    configTabs.forEach(tab => tab.style.display = '');
                } else {
                    // MESA_DE_ENTRADA y PERSONAL: solo ven USUARIO
                    configTabs.forEach(tab => {
                        if (tab.dataset.tab === 'usuario') {
                            tab.style.display = '';
                        } else {
                            tab.style.display = 'none';
                        }
                    });
                }
            }
            
            // IMPORTANTE: Todos los usuarios pueden VER expedientes
            // No hay restricciones de visualización por rol
            console.log('✅ Expedientes visibles para todos los usuarios independientemente del rol');
        }

        // Función para refrescar expedientes manualmente
        function refreshExpedientes() {
            console.log('🔄 Refrescando expedientes...');
            renderAllInCreated();
            alert('Expedientes actualizados');
        }

        // Enhanced cross-device synchronization system
        function startExpedienteWatcher() {
            console.log('🚀 Iniciando sistema de sincronización cross-device de expedientes...');
            
            // Listen for updates from other tabs/windows
            window.addEventListener('expedientesUpdated', (event) => {
                console.log('📡 Expedientes actualizados en otra pestaña:', event.detail);
                if (event.detail.deviceId !== DEVICE_ID) {
                    console.log('🔄 Actualizando desde otro dispositivo...');
                    refreshAllSections();
                }
            });
            
            // Listen for storage events (cross-tab communication)
            window.addEventListener('storage', (event) => {
                if (event.key === CENTRAL_DATABASE_KEY || event.key.includes('SHARED_') || event.key.includes('PARQUE_AUTOMOTOR_CENTRAL_DB')) {
                    console.log('🔄 Cambios detectados en almacenamiento central, sincronizando...');
                    refreshAllSections();
                }
            });
            
            // Listen for URL hash changes (cross-device sharing)
            window.addEventListener('hashchange', () => {
                console.log('🔗 URL hash cambió, verificando datos compartidos...');
                loadFromUrlIfAvailable();
            });
            
            // BroadcastChannel for cross-tab communication
            if (typeof BroadcastChannel !== 'undefined') {
                const channel = new BroadcastChannel('expedientes_sync');
                channel.addEventListener('message', (event) => {
                    console.log('📻 Mensaje recibido via BroadcastChannel:', event.data);
                    if (event.data.type === 'expediente_update' && event.data.deviceId !== DEVICE_ID) {
                        console.log('🔄 Sincronizando desde BroadcastChannel...');
                        refreshAllSections();
                    }
                });
            }
            
            // Periodic sync check every 10 seconds for cross-device updates (reduced frequency)
            setInterval(() => {
                checkForCrossDeviceUpdates();
            }, 10000);
            
            // Check for data in URL on initial load
            loadFromUrlIfAvailable();
            
            // Initialize counters
            const initialData = getAllGlobalExpedientes();
            window.lastExpedienteCount = initialData.creados.length + initialData.ejecutivo.length + initialData.compras.length + initialData.finalizados.length;
            window.lastGlobalVersion = initialData.version;
            
            console.log('✅ Sistema de sincronización cross-device activo');
        }
        
        function refreshAllSections() {
            console.log('🔄 Refrescando todas las secciones...');
            renderAllInCreated();
            renderStoredEjecutivo();
            renderStoredCompras();
        }
        
        function checkForCrossDeviceUpdates() {
            const allData = getAllGlobalExpedientes();
            const currentCount = allData.creados.length + allData.ejecutivo.length + allData.compras.length + allData.finalizados.length;
            
            // Solo actualizar si hay cambios significativos
            const significantChange = Math.abs(window.lastExpedienteCount - currentCount) > 0;
            const versionChanged = window.lastGlobalVersion && allData.version && 
                                 Math.abs(allData.version - window.lastGlobalVersion) > 5000; // 5 segundos de diferencia
            
            if (significantChange || versionChanged) {
                console.log('📝 Cambios significativos detectados en expedientes cross-device, actualizando...');
                console.log('  - Versión anterior:', window.lastGlobalVersion, '-> Nueva:', allData.version);
                console.log('  - Total anterior:', window.lastExpedienteCount, '-> Nuevo:', currentCount);
                
                window.lastExpedienteCount = currentCount;
                window.lastGlobalVersion = allData.version;
                
                // Solo refrescar si realmente hay cambios significativos
                if (significantChange) {
                    refreshAllSections();
                }
            }
        }
        
        function loadFromUrlIfAvailable() {
            try {
                const hashData = window.location.hash.substr(1);
                if (hashData && hashData.startsWith('data=')) {
                    console.log('🔗 Datos encontrados en URL, cargando...');
                    const encoded = hashData.substr(5);
                    const decoded = JSON.parse(atob(encoded));
                    
                    console.log('📥 Datos decodificados desde URL:', decoded);
                    
                    // Load data from URL into local storage
                    const categories = ['expedientesCreados', 'expedientesFinalizados', 'expedientesEjecutivo', 'expedientesCompras'];
                    let hasData = false;
                    
                    categories.forEach(category => {
                        if (decoded[category] && Array.isArray(decoded[category]) && decoded[category].length > 0) {
                            console.log(`📥 Cargando ${category} desde URL:`, decoded[category].length, 'items');
                            saveToLocalStorage(category, decoded[category]);
                            saveToSharedStorage(category, decoded[category]);
                            hasData = true;
                        }
                    });
                    
                    if (hasData) {
                        // Refresh display
                        refreshAllSections();
                        console.log('✅ Datos cargados exitosamente desde URL compartida');
                        
                        // Show success message
                        alert('📱💻 ¡Datos sincronizados exitosamente desde otro dispositivo!');
                    } else {
                        console.log('⚠️ No hay datos válidos en la URL');
                    }
                } else {
                    console.log('🔍 No se encontraron datos de sincronización en la URL');
                }
            } catch (error) {
                console.error('Error loading data from URL:', error);
                alert('❌ Error al cargar datos de sincronización. Verifica que la URL sea correcta.');
            }
        }

        // Initialize central database system and migrate existing data
        async function initializeGlobalSystem() {
            console.log('🚀 Inicializando sistema central de expedientes...');
            
            // Inicializar base de datos central primero
            await initializeCentralDatabase();
            
            // Configurar listeners
            setupCentralDatabaseListeners();
            
            // Check if we need to migrate from old localStorage system
            const hasLocalData = localStorage.getItem('expedientesCreados') || 
                                localStorage.getItem('expedientesFinalizados') || 
                                localStorage.getItem('expedientesEjecutivo') || 
                                localStorage.getItem('expedientesCompras');
                                
            const hasGlobalData = localStorage.getItem('SISTEMA_PARQUE_AUTOMOTOR_GLOBAL');
            
            if (hasLocalData && !hasGlobalData) {
                console.log('📦 Migrando datos locales al sistema global...');
                
                // Trigger migration by calling the get functions (they handle migration internally)
                getStoredCreated();
                getStoredFinalizados();
                getStoredEjecutivo();
                getStoredCompras();
                
                console.log('✅ Migración completada - todos los expedientes ahora son globales');
            }
            
            // Show global status in console
            const globalData = getAllGlobalExpedientes();
            console.log('🌐 Estado del sistema global:');
            console.log('  - Expedientes creados:', globalData.creados.length);
            console.log('  - Expedientes finalizados:', globalData.finalizados.length);
            console.log('  - Expedientes ejecutivo:', globalData.ejecutivo.length);
            console.log('  - Expedientes compras:', globalData.compras.length);
            console.log('  - Última actualización:', globalData.lastUpdated);
            console.log('  - Versión:', globalData.version);
            
            console.log('✅ Sistema global inicializado - expedientes accesibles desde cualquier navegador/usuario');
            
            // Generate and show sync URL
            generateSyncUrl();
        }
        
        // Generate URL for cross-device synchronization
        function generateSyncUrl() {
            try {
                const allData = getAllGlobalExpedientes();
                console.log('📊 Datos para sincronización:', allData);
                
                // Always generate URL, even if empty (for initial setup)
                const syncData = {
                    expedientesCreados: allData.creados || [],
                    expedientesFinalizados: allData.finalizados || [],
                    expedientesEjecutivo: allData.ejecutivo || [],
                    expedientesCompras: allData.compras || [],
                    lastUpdated: new Date().toISOString(),
                    version: allData.version || 0,
                    deviceId: DEVICE_ID
                };
                
                const encoded = btoa(JSON.stringify(syncData));
                const syncUrl = `${window.location.origin}${window.location.pathname}#data=${encoded}`;
                
                // Add sync URL display to interface
                addSyncUrlDisplay(syncUrl);
                
                console.log('🔗 URL de sincronización generada:', syncUrl);
                console.log('📱 Datos codificados:', syncData);
                
                return syncUrl;
            } catch (error) {
                console.error('Error generando URL de sincronización:', error);
                return null;
            }
        }
        
        function addSyncUrlDisplay(syncUrl) {
            // Find a good place to add the sync URL display
            const header = document.querySelector('.header');
            if (header && !document.getElementById('syncUrlDisplay')) {
                const syncDisplay = document.createElement('div');
                syncDisplay.id = 'syncUrlDisplay';
                syncDisplay.style.cssText = `
                    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
                    color: white;
                    padding: 0.75rem;
                    border-radius: 8px;
                    margin-top: 0.5rem;
                    font-size: 0.85rem;
                    display: flex;
                    align-items: center;
                    gap: 0.5rem;
                    flex-wrap: wrap;
                `;
                
                syncDisplay.innerHTML = `
                    <span style="font-weight: 600;">📱💻 SINCRONIZACIÓN CROSS-DEVICE:</span>
                    <input type="text" value="${syncUrl}" readonly 
                           style="flex: 1; min-width: 300px; padding: 0.25rem 0.5rem; border: none; border-radius: 4px; font-size: 0.8rem; background: rgba(255,255,255,0.9); color: #333;">
                    <button onclick="copySyncUrl()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 0.25rem 0.75rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                        📋 COPIAR
                    </button>
                    <button onclick="toggleSyncInstructions()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 0.25rem 0.75rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                        ❓ AYUDA
                    </button>
                `;
                
                header.appendChild(syncDisplay);
                
                // Add instructions panel (hidden by default)
                const instructionsPanel = document.createElement('div');
                instructionsPanel.id = 'syncInstructions';
                instructionsPanel.style.cssText = `
                    background: #f8fafc;
                    border: 2px solid #e2e8f0;
                    border-radius: 8px;
                    padding: 1rem;
                    margin-top: 0.5rem;
                    font-size: 0.9rem;
                    display: none;
                `;
                
                instructionsPanel.innerHTML = `
                    <h4 style="margin: 0 0 0.5rem 0; color: #1e40af;">📱💻 Cómo sincronizar entre dispositivos:</h4>
                    <ol style="margin: 0; padding-left: 1.5rem; color: #374151;">
                        <li><strong>Copia la URL completa</strong> haciendo click en "📋 COPIAR"</li>
                        <li><strong>Pega la URL en otro dispositivo</strong> (celular, tablet, otra computadora)</li>
                        <li><strong>Los expedientes aparecerán automáticamente</strong> en el nuevo dispositivo</li>
                        <li><strong>Cualquier cambio se sincroniza</strong> cuando actualices la URL</li>
                    </ol>
                    <p style="margin: 0.5rem 0 0 0; padding: 0.5rem; background: #dbeafe; border-radius: 4px; color: #1e40af; font-size: 0.85rem;">
                        💡 <strong>Tip:</strong> Guarda esta URL en favoritos para acceso rápido desde cualquier dispositivo
                    </p>
                `;
                
                header.appendChild(instructionsPanel);
            }
        }
        
        // Global functions for sync URL management
        window.copySyncUrl = function() {
            const input = document.querySelector('#syncUrlDisplay input');
            if (input) {
                input.select();
                document.execCommand('copy');
                alert('📋 URL copiada al portapapeles! Pégala en otro dispositivo para sincronizar.');
            }
        };
        
        window.toggleSyncInstructions = function() {
            const instructions = document.getElementById('syncInstructions');
            if (instructions) {
                instructions.style.display = instructions.style.display === 'none' ? 'block' : 'none';
            }
        };
        
        // Debug function to check central database status
        window.debugCentralDatabase = function() {
            console.log('🔍 DEBUG: Estado de la Base de Datos Central');
            console.log('📱 Device ID:', DEVICE_ID);
            console.log('🗄️ Tipo de base central:', centralDatabase ? centralDatabase.type || 'indexedDB' : 'No inicializada');
            
            // Check cache status
            console.log('💾 Estado del caché central:');
            Object.keys(centralCache).forEach(key => {
                if (key !== 'lastUpdate') {
                    console.log(`  - ${key}: ${centralCache[key].length} expedientes`);
                }
            });
            console.log('  - Última actualización:', centralCache.lastUpdate);
            
            // Check localStorage central keys
            console.log('🔑 Claves de localStorage central:');
            const centralKeys = Object.keys(localStorage).filter(key => key.startsWith(CENTRAL_DATABASE_KEY));
            centralKeys.forEach(key => {
                try {
                    const data = JSON.parse(localStorage.getItem(key));
                    console.log(`  - ${key}: ${Array.isArray(data) ? data.length : 'No es array'} items`);
                } catch (e) {
                    console.log(`  - ${key}: Error parseando datos`);
                }
            });
            
            // Test database read
            console.log('🧪 Probando lectura de base de datos...');
            ['expedientesCreados', 'expedientesFinalizados', 'expedientesEjecutivo', 'expedientesCompras'].forEach(async (category) => {
                try {
                    const data = await getCentralExpedientes(category);
                    console.log(`✅ ${category}: ${data.length} expedientes leídos correctamente`);
                } catch (error) {
                    console.error(`❌ Error leyendo ${category}:`, error);
                }
            });
        };
        
        // Debug function to check sync status (legacy)
        window.debugSyncStatus = function() {
            console.log('ℹ️ Esta función ha sido reemplazada por debugCentralDatabase()');
            console.log('🔄 Ejecutando debugCentralDatabase() en su lugar...');
            debugCentralDatabase();
        };
        
        // Update sync URL when data changes
        function updateSyncUrl() {
            try {
                const syncDisplay = document.getElementById('syncUrlDisplay');
                if (syncDisplay) {
                    const allData = getAllGlobalExpedientes();
                    const encoded = btoa(JSON.stringify(allData));
                    const syncUrl = `${window.location.origin}${window.location.pathname}#data=${encoded}`;
                    
                    const input = syncDisplay.querySelector('input');
                    if (input) {
                        input.value = syncUrl;
                        console.log('🔗 URL de sincronización actualizada automáticamente');
                    }
                }
            } catch (error) {
                console.error('Error actualizando URL de sincronización:', error);
            }
        }

        // Function to show all expedientes from all categories and users
        function showAllExpedientesGlobal() {
            console.log('🌍 Mostrando todos los expedientes globales...');
            
            const allData = getAllGlobalExpedientes();
            const totalCount = allData.creados.length + allData.finalizados.length + allData.ejecutivo.length + allData.compras.length;
            
            console.log('📊 Resumen global de expedientes:');
            console.log('  🆕 Creados:', allData.creados.length);
            console.log('  ✅ Finalizados:', allData.finalizados.length);
            console.log('  🏢 Ejecutivo:', allData.ejecutivo.length);
            console.log('  🛒 Compras:', allData.compras.length);
            console.log('  📈 Total:', totalCount);
            
            // Update the page title to reflect global access
            document.title = `Parque Automotor - ${totalCount} expedientes globales`;
            
            // Show notification about global system
            if (window.globalSystemNotificationShown !== true) {
                console.log('💡 Sistema configurado para acceso global - todos los expedientes son visibles para todos los usuarios');
                window.globalSystemNotificationShown = true;
            }
            
            return {
                total: totalCount,
                creados: allData.creados.length,
                finalizados: allData.finalizados.length,
                ejecutivo: allData.ejecutivo.length,
                compras: allData.compras.length,
                lastUpdated: allData.lastUpdated
            };
        }

        // Función para eliminar expediente de cualquier sección
        function deleteExpedienteCreado(codigo) {
            if (confirm(`¿Estás seguro de que quieres eliminar el expediente ${codigo}?`)) {
                console.log('🗑️ Eliminando expediente:', codigo);
                
                // Buscar y eliminar de todas las listas
                let eliminado = false;
                
                // Eliminar de creados
                const expedientesCreados = getStoredCreated().filter(e => e.codigo !== codigo);
                if (expedientesCreados.length !== getStoredCreated().length) {
                    setStoredCreated(expedientesCreados);
                    eliminado = true;
                    console.log('✅ Eliminado de Expedientes Creados');
                }
                
                // Eliminar de ejecutivo
                const expedientesEjecutivo = getStoredEjecutivo().filter(e => e.codigo !== codigo);
                if (expedientesEjecutivo.length !== getStoredEjecutivo().length) {
                    setStoredEjecutivo(expedientesEjecutivo);
                    eliminado = true;
                    console.log('✅ Eliminado de Parque Automotor Ejecutivo');
                }
                
                // Eliminar de compras
                const expedientesCompras = getStoredCompras().filter(e => e.codigo !== codigo);
                if (expedientesCompras.length !== getStoredCompras().length) {
                    setStoredCompras(expedientesCompras);
                    eliminado = true;
                    console.log('✅ Eliminado de Centro de Compras');
                }
                
                // Eliminar de finalizados
                const expedientesFinalizados = getStoredFinalizados().filter(e => e.codigo !== codigo);
                if (expedientesFinalizados.length !== getStoredFinalizados().length) {
                    setStoredFinalizados(expedientesFinalizados);
                    eliminado = true;
                    console.log('✅ Eliminado de Finalizados');
                }
                
                if (eliminado) {
                    // Forzar actualización de todas las secciones
                    renderAllInCreated();
                    renderStoredEjecutivo();
                    renderStoredCompras();
                    updateStats();
                    alert('Expediente eliminado exitosamente');
                } else {
                    alert('Expediente no encontrado');
                }
            }
        }

        // Función para finalizar expediente
        function finalizeExpediente(codigo, button) {
            if (confirm(`¿Está seguro de que desea finalizar el expediente ${codigo}?`)) {
                console.log('✅ Finalizando expediente:', codigo);
                
                // Buscar el expediente en todas las listas
                let expedienteData = null;
                let found = false;
                
                // Buscar en creados
                const expedientesCreados = getStoredCreated();
                expedienteData = expedientesCreados.find(e => e.codigo === codigo);
                if (expedienteData) {
                    // Remover de creados
                    setStoredCreated(expedientesCreados.filter(e => e.codigo !== codigo));
                    found = true;
                }
                
                // Buscar en ejecutivo
                if (!found) {
                    const expedientesEjecutivo = getStoredEjecutivo();
                    expedienteData = expedientesEjecutivo.find(e => e.codigo === codigo);
                    if (expedienteData) {
                        // Remover de ejecutivo
                        setStoredEjecutivo(expedientesEjecutivo.filter(e => e.codigo !== codigo));
                        found = true;
                    }
                }
                
                // Buscar en compras
                if (!found) {
                    const expedientesCompras = getStoredCompras();
                    expedienteData = expedientesCompras.find(e => e.codigo === codigo);
                    if (expedienteData) {
                        // Remover de compras
                        setStoredCompras(expedientesCompras.filter(e => e.codigo !== codigo));
                        found = true;
                    }
                }
                
                if (found && expedienteData) {
                    // Calcular días de trámite desde creación hasta finalización
                    const fechaCreacion = new Date(expedienteData.fechaIngreso || expedienteData.fechaCreacion);
                    const fechaFinalizacion = new Date();
                    const diasTramite = Math.ceil((fechaFinalizacion - fechaCreacion) / (1000 * 60 * 60 * 24));
                    
                    // Agregar a finalizados con fecha de finalización
                    expedienteData.fechaFinalizacion = fechaFinalizacion.toISOString();
                    expedienteData.diasTramite = diasTramite;
                    expedienteData.estado = 'FINALIZADO';
                    
                    const expedientesFinalizados = getStoredFinalizados();
                    expedientesFinalizados.push(expedienteData);
                    setStoredFinalizados(expedientesFinalizados);
                    
                    // Actualizar la interfaz
                    renderAllInCreated();
                    renderStoredEjecutivo();
                    renderStoredCompras();
                    updateStats();
                    
                    alert(`Expediente ${codigo} finalizado exitosamente. Días de trámite: ${diasTramite}`);
                } else {
                    alert('Expediente no encontrado');
                }
            }
        }

        // Función para editar expediente
        function editExpediente(codigo) {
            console.log('✏️ Editando expediente:', codigo);
            
            // Buscar en todas las listas, no solo en creados
            let expediente = getStoredCreated().find(e => e.codigo === codigo);
            if (!expediente) {
                expediente = getStoredEjecutivo().find(e => e.codigo === codigo);
            }
            if (!expediente) {
                expediente = getStoredCompras().find(e => e.codigo === codigo);
            }
            if (!expediente) {
                expediente = getStoredFinalizados().find(e => e.codigo === codigo);
            }
            
            if (expediente) {
                console.log('📝 Expediente encontrado:', expediente);
                
                // Crear URL con todos los datos del expediente
                const params = new URLSearchParams();
                Object.keys(expediente).forEach(key => {
                    if (expediente[key] !== null && expediente[key] !== undefined) {
                        params.append(key, expediente[key]);
                    }
                });
                
                const url = `/nuevo-expediente/?${params.toString()}`;
                console.log('🔗 URL de edición:', url);
                
                // Redirigir a la página de edición
                window.location.href = url;
            } else {
                console.error('❌ Expediente no encontrado en ninguna lista:', codigo);
                alert('Expediente no encontrado');
            }
        }

        // Función para debug de expedientes
        function debugExpedientes() {
            console.log('🐛 DEBUG EXPEDIENTES INICIADO');
            console.log('================================');
            
            // Verificar localStorage
            console.log('📦 localStorage completo:');
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const value = localStorage.getItem(key);
                console.log(`  ${key}:`, value);
            }
            
            // Verificar funciones de storage
            console.log('🔍 Funciones de storage:');
            console.log('  - getStoredCreated():', getStoredCreated());
            console.log('  - getStoredEjecutivo():', getStoredEjecutivo());
            console.log('  - getStoredCompras():', getStoredCompras());
            console.log('  - getStoredFinalizados():', getStoredFinalizados());
            
            // Verificar DOM
            console.log('🎯 Estado del DOM:');
            const expedientesCreados = document.getElementById('expedientesCreados');
            const emptyExpedientes = document.getElementById('emptyExpedientes');
            console.log('  - expedientesCreados:', expedientesCreados);
            console.log('  - emptyExpedientes:', emptyExpedientes);
            console.log('  - Elementos .expediente-item:', expedientesCreados?.querySelectorAll('.expediente-item').length || 0);
            
            // Forzar renderizado
            console.log('🔄 Forzando renderizado...');
            renderAllInCreated();
            
            alert('Debug completado. Revisa la consola del navegador (F12)');
        }

        // Función para buscar expedientes por fecha
        function buscarPorFecha() {
            const fechaDesde = document.getElementById('fechaDesde').value;
            const fechaHasta = document.getElementById('fechaHasta').value;
            
            if (!fechaDesde && !fechaHasta) {
                alert('Por favor selecciona al menos una fecha (DESDE o HASTA)');
                return;
            }
            
            console.log('🔍 Buscando expedientes por fecha:', { fechaDesde, fechaHasta });
            
            // Obtener todos los expedientes
            const todosExpedientes = [
                ...getStoredCreated(),
                ...getStoredEjecutivo(),
                ...getStoredCompras(),
                ...getStoredFinalizados()
            ];
            
            // Filtrar por fecha
            const expedientesFiltrados = todosExpedientes.filter(exp => {
                const fechaExpediente = new Date(exp.fechaIngreso || exp.fechaCreacion);
                
                if (fechaDesde && fechaHasta) {
                    const desde = new Date(fechaDesde);
                    const hasta = new Date(fechaHasta);
                    return fechaExpediente >= desde && fechaExpediente <= hasta;
                } else if (fechaDesde) {
                    const desde = new Date(fechaDesde);
                    return fechaExpediente >= desde;
                } else if (fechaHasta) {
                    const hasta = new Date(fechaHasta);
                    return fechaExpediente <= hasta;
                }
                
                return true;
            });
            
            console.log('📊 Expedientes encontrados:', expedientesFiltrados.length);
            
            // Renderizar solo los expedientes filtrados
            renderExpedientesFiltrados(expedientesFiltrados);
            
            // Mostrar resumen
            const mensaje = `Búsqueda completada: ${expedientesFiltrados.length} expedientes encontrados`;
            if (fechaDesde && fechaHasta) {
                mensaje += ` entre ${fechaDesde} y ${fechaHasta}`;
            } else if (fechaDesde) {
                mensaje += ` desde ${fechaDesde}`;
            } else if (fechaHasta) {
                mensaje += ` hasta ${fechaHasta}`;
            }
            
            alert(mensaje);
        }

        // Función para renderizar expedientes filtrados
        function renderExpedientesFiltrados(expedientes) {
            const expedientesCreados = document.getElementById('expedientesCreados');
            const emptyExpedientes = document.getElementById('emptyExpedientes');
            
            // Limpiar lista actual
            Array.from(expedientesCreados.querySelectorAll('.expediente-item')).forEach(n => n.remove());
            
            if (!expedientes.length) {
                if (emptyExpedientes) {
                    emptyExpedientes.style.display = 'block';
                    emptyExpedientes.innerHTML = `
                        <div class="empty-icon">🔍</div>
                        <p>No se encontraron expedientes en el rango de fechas seleccionado</p>
                    `;
                }
                return;
            }
            
            if (emptyExpedientes) emptyExpedientes.style.display = 'none';
            
            // Crear mapa para evitar duplicados
            const mapByCode = new Map();
            expedientes.forEach(exp => {
                if (!mapByCode.has(exp.codigo)) {
                    mapByCode.set(exp.codigo, exp);
                }
            });
            
            // Renderizar expedientes filtrados
            const finalizadoSet = new Set(getStoredFinalizados().map(e => e.codigo));
            
            Array.from(mapByCode.values()).forEach(data => {
                const item = document.createElement('div');
                item.className = 'expediente-item';
                const isFinal = finalizadoSet.has(data.codigo);
                
                item.innerHTML = `
                    <div class="status-badge ${isFinal ? 'status-finalizado' : 'status-pendiente'}">${isFinal ? 'FINALIZADO' : 'PENDIENTE'}</div>
                    <div class="expediente-header">${data.codigo} - ${data.detalle || 'Sin descripción'}</div>
                    <div class="expediente-details">
                        <strong>📅 ${formatDateEs(new Date(data.fechaIngreso || data.fechaCreacion))}</strong><br>
                        <strong>Código:</strong> ${data.codigo}<br>
                        <strong>Número:</strong> ${data.numero || 'N/A'}/${data.anio || '2025'}<br>
                        <strong>Corresponde:</strong> ${data.corresponde || 'N/A'}<br>
                        <strong>Derivado a:</strong> ${data.derivado || 'N/A'}<br>
                        <strong>Días de trámite:</strong> ${data.diasTramite || 0} días
                        ${data.observacion ? '<br><strong>Observación:</strong> ' + data.observacion : ''}
                    </div>
                    ${!isFinal ? `
                    <div class="item-actions">
                        <label style="display:flex;align-items:center;gap:0.4rem;color:var(--gray-700);">
                            <input type="checkbox" class="select-checkbox" /> Seleccionar
                        </label>
                        <select class="inline-select" aria-label="Mover a" disabled>
                            <option value="">Enviar a...</option>
                            <option value="ejecutivo">Parque Automotor Ejecutivo</option>
                            <option value="compra">Compras</option>
                        </select>
                        <button class="send-btn" disabled>Enviar</button>
                        <button class="finalize-btn" onclick="finalizeExpediente('${data.codigo}', this)" title="Finalizar expediente">✅ Finalizar</button>
                        <button class="edit-btn" onclick="editExpediente('${data.codigo}')" title="Modificar expediente">✏️</button>
                        <button class="delete-btn" onclick="deleteExpedienteCreado('${data.codigo}')" title="Eliminar expediente">🗑️</button>
                    </div>
                    ` : `
                    <div class="item-actions" style="opacity: 0.6; pointer-events: none;">
                    </div>
                    `}
                `;
                
                attachExpedienteItemHandlers(item, data);
                expedientesCreados.insertBefore(item, emptyExpedientes);
            });
        }

        // Función para limpiar búsqueda y mostrar todos los expedientes
        function limpiarBusqueda() {
            document.getElementById('fechaDesde').value = '';
            document.getElementById('fechaHasta').value = '';
            renderAllInCreated();
            alert('Búsqueda limpiada. Mostrando todos los expedientes.');
        }



        // FORZAR CREACIÓN DE USUARIOS DE PRUEBA
        (function() {
            console.log('Creando usuarios de prueba...');
            
            // Solo crear si no existen
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            
            // Admin
            if (!users.find(u => u.username === '35477889')) {
                users.push({
                    username: '35477889',
                    dni: '35477889',
                    nombre: 'ADMIN',
                    apellido: 'SISTEMA',
                    password: '35477889',
                    role: 'ADMIN',
                    blocked: false
                });
                console.log('✅ Admin creado');
            }
            
            // Mesa de Entrada
            if (!users.find(u => u.username === '12345678')) {
                users.push({
                    username: '12345678',
                    dni: '12345678',
                    nombre: 'MESA',
                    apellido: 'ENTRADA',
                    password: '12345678',
                    role: 'MESA_DE_ENTRADA',
                    blocked: false
                });
                console.log('✅ Mesa de Entrada creado');
            }
            
            // Personal
            if (!users.find(u => u.username === '87654321')) {
                users.push({
                    username: '87654321',
                    dni: '87654321',
                    nombre: 'PERSONAL',
                    apellido: 'TEST',
                    password: '87654321',
                    role: 'PERSONAL',
                    blocked: false
                });
                console.log('✅ Personal creado');
            }
            
            localStorage.setItem('users', JSON.stringify(users));
            console.log('👥 Usuarios disponibles:', users.map(u => `${u.username} (${u.role})`));
            
            // Iniciar watcher automático de expedientes
            startExpedienteWatcher();
        })();
    </script>
</body>
</html>


