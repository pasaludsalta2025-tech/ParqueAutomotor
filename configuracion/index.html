<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CONFIGURACI√ìN</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
    :root {
      --primary-blue: #1e40af; --primary-blue-light:#3b82f6; --gray-100:#f1f5f9; --gray-200:#e2e8f0; --gray-600:#475569; --white:#fff;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:'Inter',sans-serif;background:linear-gradient(135deg,#1e40af,#1e3a8a);min-height:100vh;padding:2rem;text-transform:uppercase}
    .container{max-width:900px;margin:0 auto}
    .card{background:var(--white);border:1px solid var(--gray-200);border-radius:12px;box-shadow:0 10px 20px rgba(0,0,0,.08);overflow:hidden}
    .header{display:flex;justify-content:space-between;align-items:center;padding:1rem 1.25rem;background:linear-gradient(135deg,#eff6ff,#dbeafe);border-bottom:1px solid var(--gray-200)}
    .title{font-weight:800;color:#1e293b}
    .content{display:grid;grid-template-columns:220px 1fr}
    .sidebar{border-right:1px solid var(--gray-200);background:#fafcff}
    .nav{list-style:none}
    .nav li{border-bottom:1px solid var(--gray-200)}
    .nav a{display:block;padding:0.9rem 1rem;color:#0f172a;text-decoration:none;font-weight:600}
    .nav a.active,.nav a:hover{background:#e2e8f0}
    .panel{padding:1.25rem}
    .row{margin-bottom:1rem;color:#334155}
    .btn{padding:.6rem .9rem;border-radius:8px;border:1px solid var(--gray-200);background:#fff;cursor:pointer;font-weight:700}
    .top-actions{display:flex;gap:.5rem}
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="header">
        <div class="title">CONFIGURACI√ìN</div>
        <div class="top-actions">
          <button class="btn" onclick="window.location.href='/'">‚¨Ö VOLVER</button>
        </div>
      </div>
      <div class="content">
        <aside class="sidebar">
          <ul class="nav">
            <li><a href="#usuario" class="active" onclick="showTab(event,'usuario')">USUARIO</a></li>
            <li><a href="#perfil" onclick="showTab(event,'perfil')">PERFIL</a></li>
            <li><a href="#pendiente" onclick="showTab(event,'pendiente')">PENDIENTE</a></li>
            <li><a href="#roles" onclick="showTab(event,'roles')">ROLES</a></li>
          </ul>
        </aside>
        <section class="panel">
          <div id="tab-usuario">
            <div class="row">DNI: <span id="conf-dni">-</span></div>
            <div class="row">NOMBRE: <span id="conf-nombre">-</span></div>
            <div class="row">APELLIDO: <span id="conf-apellido">-</span></div>

            <div class="row" style="margin-top:1.25rem;font-weight:800;">CAMBIAR CONTRASE√ëA</div>
            <form id="pwdForm" style="margin-top:.5rem;display:grid;grid-template-columns:1fr 1fr;gap:.75rem;max-width:560px;">
              <div style="display:flex;flex-direction:column;gap:.35rem;grid-column:1 / -1;">
                <label>CONTRASE√ëA ACTUAL</label>
                <input type="password" name="current" style="padding:.7rem;border:1px solid var(--gray-200);border-radius:8px;" required>
              </div>
              <div style="display:flex;flex-direction:column;gap:.35rem;">
                <label>NUEVA CONTRASE√ëA</label>
                <input type="password" name="next" minlength="6" style="padding:.7rem;border:1px solid var(--gray-200);border-radius:8px;" required>
              </div>
              <div style="display:flex;flex-direction:column;gap:.35rem;">
                <label>REPETIR NUEVA</label>
                <input type="password" name="confirm" minlength="6" style="padding:.7rem;border:1px solid var(--gray-200);border-radius:8px;" required>
              </div>
              <div style="grid-column:1 / -1;display:flex;gap:.5rem;">
                <button type="submit" class="btn">üíæ GUARDAR</button>
                <button type="reset" class="btn">‚Ü∫ LIMPIAR</button>
              </div>
            </form>
            <div id="pwdMsg" class="row" style="margin-top:.5rem;color:#ef4444;display:none;"></div>
          </div>
          <div id="tab-perfil" style="display:none;">
            <div class="row" style="font-weight:800;">USUARIOS REGISTRADOS</div>
            <div id="usersList" class="row" style="display:flex;flex-direction:column;gap:.5rem;">
              <!-- RENDER DIN√ÅMICO -->
            </div>
          </div>
          <div id="tab-pendiente" style="display:none;">
            <div class="row">ALERTAS DE PENDIENTE > 2 D√çAS: ACTIVAS</div>
            <div class="row">M√ìDULOS VISIBLES: CREADOS / EJECUTIVO / COMPRAS</div>
          </div>
          <div id="tab-roles" style="display:none;">
            <div class="row" style="font-weight:800;">GESTI√ìN DE ROLES</div>
                            <div class="row" style="margin-bottom:.5rem; color:#334155;">ROLES DISPONIBLES: ADMIN, MESA_DE_ENTRADA, PERSONAL (POR DEFECTO)</div>
            <div id="rolesList" class="row" style="display:flex;flex-direction:column;gap:.5rem;"></div>
          </div>
        </section>
      </div>
    </div>
  </div>

  <script>
    function showTab(e, id){
      if(e){ e.preventDefault(); }
      document.querySelectorAll('.nav a').forEach(a=>a.classList.remove('active'));
      const link = document.querySelector('.nav a[href="#'+id+'"]');
      if (link) link.classList.add('active');
      document.querySelectorAll('[id^="tab-"]').forEach(p=>p.style.display='none');
      const panel = document.getElementById('tab-'+id); if(panel) panel.style.display='block';
    }
    (function init(){
      const user = JSON.parse(localStorage.getItem('authUser')||'null');
      if (!user) { window.location.href = '/'; return; }
      if (user){
        document.getElementById('conf-dni').textContent = user.dni || user.username || '-';
        document.getElementById('conf-nombre').textContent = user.nombre || '-';
        document.getElementById('conf-apellido').textContent = user.apellido || '-';
      }

      const pwdForm = document.getElementById('pwdForm');
      const pwdMsg = document.getElementById('pwdMsg');
      if (pwdForm){
        pwdForm.addEventListener('submit', (e)=>{
          e.preventDefault();
          pwdMsg.style.display='none';
          pwdMsg.textContent='';
          const fd = new FormData(pwdForm);
          const current = (fd.get('current')||'').toString();
          const next = (fd.get('next')||'').toString();
          const confirm = (fd.get('confirm')||'').toString();
          if (next.length < 6){ pwdMsg.textContent='LA NUEVA CONTRASE√ëA DEBE TENER AL MENOS 6 CARACTERES'; pwdMsg.style.display='block'; return; }
          if (next !== confirm){ pwdMsg.textContent='LA NUEVA CONTRASE√ëA NO COINCIDE'; pwdMsg.style.display='block'; return; }

          const users = JSON.parse(localStorage.getItem('users')||'[]');
          const idx = users.findIndex(u => u.username === (user.dni||user.username));
          if (idx === -1) { pwdMsg.textContent='USUARIO NO ENCONTRADO'; pwdMsg.style.display='block'; return; }
          if (users[idx].password !== current){ pwdMsg.textContent='CONTRASE√ëA ACTUAL INCORRECTA'; pwdMsg.style.display='block'; return; }
          users[idx].password = next;
          localStorage.setItem('users', JSON.stringify(users));
          alert('CONTRASE√ëA ACTUALIZADA');
          pwdForm.reset();
        });
      }

      // RENDER LISTA DE USUARIOS EN PERFIL
      function renderUsers(){
        const container = document.getElementById('usersList');
        if (!container) return;
        container.innerHTML = '';
        const users = JSON.parse(localStorage.getItem('users')||'[]');
        if (users.length === 0){
          container.innerHTML = '<div style="color:#475569">NO HAY USUARIOS REGISTRADOS</div>';
          return;
        }
        users.forEach(u => {
          const row = document.createElement('div');
          row.style.cssText = 'display:flex;justify-content:space-between;align-items:center;border:1px solid var(--gray-200);border-radius:8px;padding:.6rem .8rem;background:#fff';
          row.innerHTML = `
            <div>
              <div><strong>DNI:</strong> ${u.dni || u.username}</div>
              <div><strong>NOMBRE:</strong> ${u.nombre || '-'} <strong>APELLIDO:</strong> ${u.apellido || '-'}</div>
              <div><strong>ESTADO:</strong> ${u.blocked ? 'BLOQUEADO' : 'ACTIVO'}</div>
            </div>
            <div style="display:flex;gap:.4rem;">
              <button class="btn" data-action="reset" data-id="${u.username}">üîÅ BLANQUEAR</button>
              <button class="btn" data-action="block" data-id="${u.username}">${u.blocked ? 'üîì DESBLOQUEAR' : 'üîí BLOQUEAR'}</button>
              <button class="btn" data-action="delete" data-id="${u.username}">üóë ELIMINAR</button>
            </div>
          `;
          container.appendChild(row);
        });
      }
      renderUsers();

      function renderRoles(){
        const container = document.getElementById('rolesList');
        if (!container) return;
        container.innerHTML = '';
        const users = JSON.parse(localStorage.getItem('users')||'[]');
        users.forEach(u => {
          const row = document.createElement('div');
          row.style.cssText = 'display:flex;justify-content:space-between;align-items:center;border:1px solid var(--gray-200);border-radius:8px;padding:.6rem .8rem;background:#fff';
          row.innerHTML = `
            <div>
              <div><strong>DNI:</strong> ${u.dni || u.username}</div>
              <div><strong>NOMBRE:</strong> ${u.nombre || '-'} <strong>APELLIDO:</strong> ${u.apellido || '-'}</div>
            </div>
            <div style="display:flex;gap:.4rem;align-items:center;">
              <select data-role="select" data-id="${u.username}" style="padding:.4rem;border:1px solid var(--gray-200);border-radius:6px;">
                <option value="ADMIN" ${ (u.role==='ADMIN')?'selected':'' }>ADMIN</option>
                <option value="MESA_DE_ENTRADA" ${ (!u.role || u.role==='MESA_DE_ENTRADA')?'selected':'' }>MESA_DE_ENTRADA</option>
                <option value="PERSONAL" ${ (u.role==='PERSONAL')?'selected':'' }>PERSONAL</option>
              </select>
              <button class="btn" data-action="save-role" data-id="${u.username}">üíæ GUARDAR</button>
            </div>
          `;
          container.appendChild(row);
        });
      }
      renderRoles();

      // ACCIONES SOBRE USUARIOS
      document.addEventListener('click', (e)=>{
        const btn = e.target.closest('button.btn[data-action]');
        if (!btn) return;
        const action = btn.dataset.action;
        const id = btn.dataset.id;
        let users = JSON.parse(localStorage.getItem('users')||'[]');
        const idx = users.findIndex(u => u.username === id);
        if (idx === -1) return;
        if (action === 'delete'){
          if (!confirm('¬øELIMINAR USUARIO?')) return;
          users.splice(idx,1);
        } else if (action === 'reset'){
          if (!confirm('¬øBLANQUEAR CONTRASE√ëA A "123456"?')) return;
          users[idx].password = '123456';
        } else if (action === 'block'){
          users[idx].blocked = !users[idx].blocked;
        } else if (action === 'save-role'){
          const select = document.querySelector(`select[data-role="select"][data-id="${id}"]`);
          if (select){ users[idx].role = select.value; }
        }
        localStorage.setItem('users', JSON.stringify(users));
        renderUsers();
        renderRoles();
      });

      // VISIBILIDAD POR ROL (CONFIGURACI√ìN)
      const auth = user;
      if (auth){
        // Reglas solicitadas:
                    // - ADMIN: ve TODO completo
        // - MESA_DE_ENTRADA: en CONFIGURACI√ìN solo "USUARIO" (ocultar PERFIL, PENDIENTE, ROLES)
        // - PERSONAL: ve TODO excepto el + (se maneja en index) y en CONFIGURACI√ìN solo "USUARIO"
        const role = (auth.role || 'MESA_DE_ENTRADA').toUpperCase();
        if (role === 'MESA_DE_ENTRADA' || role === 'PERSONAL'){
          // ocultar pesta√±as PERFIL, PENDIENTE, ROLES
          ['perfil','pendiente','roles'].forEach(id => {
            const link = document.querySelector(`.nav a[href="#${id}"]`);
            if (link) link.style.display = 'none';
            const panel = document.getElementById('tab-'+id);
            if (panel) panel.style.display = 'none';
          });
          // asegurar USUARIO activo
          showTab(null,'usuario');
        }
        // ADMIN ve todo
      }
    })();
  </script>
</body>
</html>


